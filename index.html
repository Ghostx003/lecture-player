<!DOCTYPE html>
<html lang="en" data-theme="dark" data-accent="green">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CourseFlix</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* --- THEME & ACCENT COLOR VARIABLES --- */
        :root {
            --bg-primary: #f9fafb; --bg-secondary: #ffffff; --bg-tertiary: #f3f4f6;
            --text-primary: #1f2937; --text-secondary: #6b7280; --text-on-accent: #ffffff;
            --border-primary: #e5e7eb; --border-secondary: #d1d5db; --accent-danger: #ef4444;
            --status-review: #f59e0b; --status-practice: #3b82f6;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        html[data-theme="dark"] {
            --bg-primary: #000000; --bg-secondary: #121212; --bg-tertiary: #1E1E1E;
            --text-primary: #f5f5f5; --text-secondary: #a3a3a3;
            --border-primary: #27272a; --border-secondary: #3f3f46;
            --shadow: 0 1px 3px 0 rgb(255 255 255 / 0.1), 0 1px 2px -1px rgb(255 255 255 / 0.08);
        }
        html[data-accent="green"] {
            --accent-primary: #16a34a; --accent-hover: #15803d;
            --accent-primary_translucent: rgba(34, 197, 94, 0.4);
        }

        /* --- BASE STYLES --- */
        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent;
            background-color: var(--bg-primary); color: var(--text-primary);
            transition: background-color 0.2s, color 0.2s; margin: 0;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        button, a, input { font-family: inherit; -webkit-tap-highlight-color: transparent; }

        /* --- VIEWS & LAYOUT --- */
        .view { width: 100%; flex-grow: 1; display: none; flex-direction: column; overflow: hidden; }
        .view.active { display: flex; }
        
        /* --- NAVBAR --- */
        nav {
            display: flex; align-items: center; padding: 1rem 2.5rem;
            background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-primary); 
            flex-shrink: 0; z-index: 10; gap: 1rem; /* Adjusted gap */
        }
        nav.hidden { display: none; }
        nav h1 { margin: 0; font-size: 1.5rem; font-weight: 700; cursor: pointer; }
        .nav-links { margin-right: auto; display: flex; gap: 1rem; }
        .nav-link { 
            color: var(--text-secondary); text-decoration: none; font-weight: 600; font-size: 0.95rem;
            padding: 8px 12px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;
        }
        .nav-link:hover { color: var(--text-primary); background-color: var(--bg-tertiary); }
        .nav-link.active { color: var(--accent-primary); }
        .primary-btn {
            background-color: var(--accent-primary); color: var(--text-on-accent); border: none;
            padding: 10px 18px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: background-color 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .primary-btn:hover { background-color: var(--accent-hover); }

        .info-display {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-secondary);
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            display: none; /* Hidden by default, shown via JS */
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        /* --- DASHBOARD, REVIEW, PRACTICE GRIDS --- */
        .grid-container { overflow-y: auto; flex-grow: 1; padding: 24px; }
        #course-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }
        #review-grid, #practice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* --- Course Card (Dashboard) --- */
        .course-card {
            background-color: var(--bg-secondary); border-radius: 10px;
            box-shadow: var(--shadow); border: 1px solid var(--border-primary);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; 
            display: flex; flex-direction: column; height: 350px; /* Increased height for new fields */
            overflow: hidden;
        }
        html[data-theme="dark"] .course-card:hover { border-color: var(--accent-primary); box-shadow: 0 0 15px -2px var(--accent-primary_translucent); transform: translateY(-2px); }
        html[data-theme="light"] .course-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .thumbnail-placeholder {
            width: 100%; height: 140px; background-color: var(--bg-tertiary); border-bottom: 1px solid var(--border-primary);
            display: flex; align-items: center; justify-content: center; position: relative;
            flex-shrink: 0; cursor: pointer; background-size: cover; background-position: center;
        }
        .thumbnail-placeholder i { font-size: 2.5rem; color: var(--text-secondary); opacity: 0.4; }
        .thumbnail-placeholder.has-thumbnail i { display: none; }
        .remove-course-btn, .remove-thumbnail-btn, .refresh-course-btn {
            position: absolute; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 28px; height: 28px;
            cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; z-index: 2;
        }
        .remove-course-btn { top: 8px; right: 8px; }
        .remove-thumbnail-btn { top: 8px; left: 8px; display: none; }
        .refresh-course-btn { top: 8px; left: 50%; transform: translateX(-50%); }
        .refresh-course-btn.loading i { animation: spin 1.5s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .remove-course-btn:hover, .remove-thumbnail-btn:hover { background: var(--accent-danger); }
        .refresh-course-btn:hover { background: var(--accent-primary); }
        
        .course-card:hover .remove-course-btn, .course-card:hover .refresh-course-btn { opacity: 1; }
        .course-card:hover .thumbnail-placeholder.has-thumbnail .remove-thumbnail-btn { opacity: 1; display: flex; }
        .course-info { padding: 12px 16px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .course-info h3 { margin: 0 0 4px 0; font-size: 1rem; line-height: 1.3; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .course-meta { font-size: 0.8rem; color: var(--text-secondary); margin: 0 0 8px 0; }
        .course-duration { font-size: 0.75rem; color: var(--accent-primary); margin-bottom: 8px; font-weight: 500; }
        .course-progress-container { margin-top: auto; }
        .course-progress-bar, .lecture-progress-bar, .menu-progress-bar { width: 100%; height: 6px; background-color: var(--bg-tertiary); border-radius: 3px; overflow: hidden; margin-bottom: 4px;}
        .course-progress-fill, .lecture-progress-fill, .menu-progress-fill { height: 100%; background-color: var(--accent-primary); transition: width 0.3s ease; }
        .course-progress-text, .menu-progress-text { font-size: 0.75rem; color: var(--text-secondary); }
        .enter-course-btn { padding: 8px 12px; width: 100%; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; text-decoration: none; display: block; text-align: center; background-color: var(--accent-primary); color: var(--text-on-accent); margin-top: 12px; }
        .enter-course-btn:hover { background-color: var(--accent-hover); }

        .course-extra-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin: 8px 0;
            gap: 8px;
        }
        .course-faculty {
            font-weight: 500;
            cursor: text;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .course-faculty:hover {
            background-color: var(--bg-tertiary);
        }
        .course-rating {
            display: flex;
            flex-shrink: 0;
        }
        .course-rating i {
            cursor: pointer;
            color: var(--border-secondary); /* Default color for empty stars */
            transition: transform 0.1s, color 0.1s;
            padding: 0 1px;
        }
        .course-rating i.fas {
            color: #f59e0b; /* Filled star color */
        }
        .course-rating:hover i {
           color: #f59e0b !important;
        }
        .course-rating i:hover ~ i {
            color: var(--border-secondary) !important;
        }
        .course-faculty-input {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-secondary);
            border-radius: 4px;
            padding: 2px 4px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.8rem;
            box-sizing: border-box;
        }

        /* --- Lecture Card (Review/Practice) --- */
        .lecture-review-card {
            background-color: var(--bg-secondary);
            border-radius: 10px; border: 1px solid var(--border-primary); padding: 16px;
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; cursor: pointer; overflow: hidden; min-height: 220px;
            background-image: url('lect.webp'); background-size: cover; background-position: center;
        }
        .lecture-review-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); border-radius: 10px; z-index: 1;
        }
        .lecture-review-info, .card-action-center, .remove-status-btn { position: relative; z-index: 2; }
        .lecture-review-info h3 { margin: 0 0 4px 0; font-size: 1.1rem; font-weight: 600; color: #ffffff; }
        .lecture-review-info .course-title { font-size: 0.8rem; font-weight: 500; color: #e5e5e5; margin-bottom: 12px; }
        .lecture-review-meta { display: flex; justify-content: space-between; font-size: 0.75rem; color: #e5e5e5; margin-top: 6px; }
        .card-action-center { display: flex; justify-content: center; padding-top: 1rem; }
        
        .remove-status-btn {
            position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%;
            width: 28px; height: 28px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s, background-color 0.2s;
        }
        .lecture-review-card:hover .remove-status-btn { opacity: 1; }
        .remove-status-btn:hover { background: var(--accent-danger); }

        /* --- View Header (Filters) --- */
        .view-header { padding: 12px 24px; border-bottom: 1px solid var(--border-primary); display: flex; align-items: center; gap: 1rem; position: relative; }
        .filter-dropdown { position: absolute; top: 100%; left: 24px; background-color: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 8px; box-shadow: var(--shadow); z-index: 20; max-height: 300px; overflow-y: auto; }
        .filter-dropdown a { display: block; padding: 10px 15px; text-decoration: none; color: var(--text-primary); cursor: pointer; }
        .filter-dropdown a:hover { background-color: var(--bg-tertiary); }

        /* --- ADD COURSE MODAL --- */
        #modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        #modal-overlay.hidden { display: none !important; }
        .modal-content { background-color: var(--bg-secondary); border-radius: 1rem; padding: 2rem; width: 100%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 1.5rem; position: relative; }
        #close-modal-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s; }
        #close-modal-btn:hover { background-color: var(--bg-tertiary); }
        .modal-content h2 { margin: 0; }
        .modal-content .secondary-btn {
            background-color: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s;
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-secondary);
        }
        .modal-content .secondary-btn:hover { background-color: var(--border-primary); }

        /* --- PLAYER VIEW --- */
        #player-view { 
            flex-direction: row; 
            --viewer-width: 0px; /* Default width for the media viewer */
        }
        .player-content-wrapper {
            flex-grow: 1; display: flex; position: relative;
            width: calc(100% - 380px); /* Initial width considering the menu */
            transition: width 0.3s ease-in-out;
        }
        #player-view.viewer-active .player-content-wrapper {
            width: calc(100% - 380px - var(--viewer-width));
        }
        #lecture-menu { 
            width:380px; 
            background-color:var(--bg-secondary); 
            border-right:1px solid var(--border-primary); 
            flex-shrink:0; 
            display:flex; 
            flex-direction:column; 
            transition:margin-left 0.3s ease; 
        }
        #lecture-menu.hidden { margin-left:-380px; }
        .menu-header { padding:20px; border-bottom:1px solid var(--border-primary); background-color: var(--bg-primary); flex-shrink: 0; }
        .back-link { color:var(--accent-primary);text-decoration:none;display:block;margin-bottom:15px;font-weight:500; cursor: pointer;}
        .back-link:hover { text-decoration: underline; }
        #chapter-list { overflow-y:auto; flex-grow:1; padding:10px; }
        .chapter-title { font-weight:bold; cursor:pointer; padding:12px; border-radius:8px; display:flex; align-items:center; gap:8px; transition: background-color 0.2s; position: relative;}
        .chapter-title:hover { background-color: var(--bg-tertiary); }
        .chapter-title-text { flex-grow: 1; cursor: text; }
        .chapter-duration { font-size: 0.8rem; color: var(--text-secondary); margin-left: 10px; }
        
        .chapter-drag-handle {
            cursor: grab;
            color: var(--text-secondary);
            padding: 0 10px 0 2px;
            margin-left: -12px; /* Pull it left */
            opacity: 0.4;
            transition: opacity 0.2s;
        }
        .chapter-title:hover .chapter-drag-handle { opacity: 1; }
        .chapter.dragging { opacity: 0.5; background: var(--bg-tertiary); }
        .chapter-drop-indicator { height: 2px; background-color: var(--accent-primary); margin: -1px 0; }

        .chapter-title i { transition: transform 0.2s; }
        .chapter.open > .chapter-title i:not(.chapter-drag-handle) { transform: rotate(90deg); }
        .lecture-list { list-style:none; padding-left: 20px; margin: 0; display: none; }
        .chapter.open > .lecture-list { display: block; }
        .lecture-list li { 
            padding:10px 12px; cursor:pointer; border-radius:8px; margin-top:5px; display:flex; align-items:center; gap:10px;
            justify-content: space-between;
        }
        .lecture-list li:hover { background-color:var(--bg-tertiary); }
        .lecture-list li.active { background-color:var(--accent-primary);color:var(--text-on-accent); }
        .lecture-checkbox { width: 18px; height: 18px; border: 2px solid var(--border-secondary); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
        .lecture-checkbox.completed { background-color: var(--accent-primary); border-color: var(--accent-primary); }
        .lecture-checkbox i { color: white; font-size: 12px; opacity: 0; }
        .lecture-checkbox.completed i { opacity: 1; }
        .lecture-title { flex-grow: 1; transition: opacity 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: text;}
        .lecture-title.completed { text-decoration: line-through; opacity: 0.6; }
        .lecture-title-input { width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-secondary); border-radius: 4px; padding: 2px 4px; color: var(--text-primary); font-weight: normal; font-size: 1em; }
        .lecture-duration { font-size: 0.7rem; color: var(--text-secondary); margin-left: auto; flex-shrink: 0; }
        .status-btn { border: none; border-radius: 6px; font-size: 0.65rem; font-weight: 700; padding: 4px 8px; margin-left: 10px; cursor: pointer; flex-shrink: 0; background-color: var(--bg-tertiary); color: var(--text-secondary); }
        .status-btn.review { background-color: var(--status-review); color: white; }
        .status-btn.practice { background-color: var(--status-practice); color: white; }

        /* --- PDF/Assignment viewer --- */
        #media-viewer {
            display: flex; flex-direction: column; width: var(--viewer-width); height: 100%;
            background-color: var(--bg-secondary); border-left: 1px solid var(--border-primary);
            position: relative; z-index: 50; overflow: hidden; transition: width 0.3s ease-in-out;
        }
        #media-viewer.hidden { width: 0; border-left: none; }
        
        #media-viewer-header {
            display: flex; align-items: center; justify-content: space-between; padding: 1rem;
            border-bottom: 1px solid var(--border-primary); background-color: var(--bg-secondary); flex-shrink: 0;
            gap: 1rem;
        }
        #viewer-title {
            margin: 0; font-size: 1.1rem; font-weight: 600;
            text-overflow: ellipsis; white-space: nowrap; overflow: hidden; flex-grow: 1;
        }
        .viewer-actions { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
        
        #close-viewer-btn {
            background-color: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 6px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        #close-viewer-btn:hover {
            background-color: var(--accent-hover);
        }

        #delete-viewer-file {
            background-color: var(--accent-danger); color: white; border: none; border-radius: 6px;
            font-size: 0.8rem; font-weight: 500; padding: 6px 12px; cursor: pointer;
            display: none; align-items: center; gap: 6px;
        }
        #delete-viewer-file.visible { display: inline-flex; }
        #media-viewer-frame { flex-grow: 1; width: 100%; border: none; }
        #media-resize-handle {
            position: absolute; top: 0; left: 0; height: 100%; width: 8px; cursor: ew-resize; z-index: 60;
            background-color: transparent; transition: background-color 0.2s;
        }
        #media-resize-handle:hover { background-color: var(--accent-primary_translucent); }
        #video-wrapper-container {
            flex-grow: 1; display: flex; flex-direction: column; position: relative;
            width: 100%; transition: width 0.3s ease-in-out;
        }
        
        /* --- File Switcher --- */
        #file-switcher-container { position: relative; }
        #file-switcher-btn {
            background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-secondary);
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500;
        }
        #file-switcher-dropdown {
            position: absolute; top: 110%; right: 0; background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary); border-radius: 6px; box-shadow: var(--shadow);
            z-index: 70; min-width: 120px; overflow: hidden;
        }
        #file-switcher-dropdown button {
            display: block; width: 100%; text-align: left; padding: 8px 12px;
            background: none; border: none; color: var(--text-primary); cursor: pointer;
        }
        #file-switcher-dropdown button:hover { background-color: var(--bg-tertiary); }


        /* --- Video Player & Controls --- */
        #video-wrapper { flex-grow:1;background-color:black;display:flex;justify-content:center;align-items:center;position:relative;overflow:hidden;}
        #video-player { width:100%;height:100%;outline:none;}
        #unmute-btn {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); color: white; border: 2px solid white; border-radius: 8px;
            padding: 12px 20px; font-size: 1.1rem; font-weight: 600; cursor: pointer; z-index: 25;
        }
        .seek-overlay{position:absolute;top:0;width:50%;height:100%;z-index:10;pointer-events:none;}
        #left-seek-overlay{left:0;} #right-seek-overlay{right:0;}
        .seek-overlay i{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:48px;color:white;opacity:0;pointer-events:none;}
        .seek-overlay.show-icon i{opacity:0.8;animation:fade-out 0.5s forwards;}
        @keyframes fade-out { from { opacity: 0.8; } to { opacity: 0; } }
        .video-controls-container { position:absolute;bottom:0;left:0;width:100%;padding:0 15px;z-index:20;opacity:0;transition:opacity 0.2s ease-in-out;background:linear-gradient(to top, rgba(0,0,0,0.7), transparent);}
        #video-wrapper:hover .video-controls-container { opacity:1; }
        .timeline-container { padding: 10px 0; }
        .timeline { -webkit-appearance:none; appearance:none; background:rgba(255,255,255,0.3); cursor:pointer; height:8px; width:100%; border-radius:5px; transition: height 0.2s ease; }
        .timeline:hover { height: 12px; }
        .timeline::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; height:18px; width:18px; border-radius:50%; background-color:var(--accent-primary); border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); transition: transform 0.2s ease, box-shadow 0.2s ease; opacity: 0; }
        .timeline-container:hover .timeline::-webkit-slider-thumb { opacity: 1; transform: scale(1.1); }
        .controls { display:flex;justify-content:space-between;align-items:center;padding-bottom:10px;color:white;}
        .left-controls, .right-controls { display:flex;align-items:center;gap:15px; }
        .control-btn { background:none;border:none;color:white;font-size:18px;cursor:pointer;padding:5px; }
        
        #sidebar-toggle-btn { 
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1001;
            background:var(--accent-primary);
            color:white;
            border:none;
            width:25px;
            height:70px;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            transition: all 0.3s ease;
            left:380px;
            border-radius:0 8px 8px 0;
        }
        #sidebar-toggle-btn.collapsed { left:0; }
        #sidebar-toggle-btn i { transition:transform 0.3s; }
        #sidebar-toggle-btn.collapsed i { transform:rotate(180deg); }

        #media-viewer-toggle-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 55; /* Below resize handle */
            background: var(--accent-primary);
            color: white;
            border: none;
            width: 25px;
            height: 70px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease, right 0.3s ease;
            right: 0;
            border-radius: 8px 0 0 8px;
        }
        
        #no-content-message { text-align: center; color: var(--text-secondary); padding: 50px; }
        .hidden { display: none !important; }
        .file-controls { display: flex; gap: 5px; align-items: center; }
        .file-btn {
            background: none; border: none; color: var(--text-secondary); cursor: pointer;
            width: 24px; height: 24px; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .file-btn:hover { color: var(--accent-primary); }
        #add-pdf-input, #add-assignment-input { display: none; }
    </style>
</head>
<body>

    <nav>
        <h1 id="home-btn">CourseFlix</h1>
        <div class="nav-links">
            <a href="#" class="nav-link" data-view="dashboard-view">Dashboard</a>
            <a href="#" class="nav-link" data-view="review-view">Review</a>
            <a href="#" class="nav-link" data-view="practice-view">Practice</a>
        </div>
        <div id="total-time-left-display" class="info-display"></div>
        <button id="add-course-btn" class="primary-btn"><i class="fas fa-plus"></i> Add Course</button>
    </nav>

    <div id="dashboard-view" class="view active">
        <main id="course-grid" class="grid-container"></main>
    </div>

    <div id="review-view" class="view">
        <div class="view-header">
            <button class="primary-btn" id="filter-btn-review"><i class="fas fa-filter"></i> Filter by Course</button>
            <div id="filter-dropdown-review" class="filter-dropdown hidden"></div>
        </div>
        <main id="review-grid" class="grid-container"></main>
    </div>

    <div id="practice-view" class="view">
        <div class="view-header">
            <button class="primary-btn" id="filter-btn-practice"><i class="fas fa-filter"></i> Filter by Course</button>
            <div id="filter-dropdown-practice" class="filter-dropdown hidden"></div>
        </div>
        <main id="practice-grid" class="grid-container"></main>
    </div>

    <div id="player-view" class="view">
        <div id="lecture-menu">
            <div class="menu-header">
                <a class="back-link">&larr; Back to Courses</a>
                <h2 id="course-title-menu"></h2>
                <div class="course-stats"></div>
                <div class="menu-progress-container">
                    <div class="menu-progress-bar">
                        <div class="menu-progress-fill"></div>
                    </div>
                    <div class="menu-progress-text"></div>
                </div>
            </div>
            <div id="chapter-list"></div>
        </div>
        <div class="player-content-wrapper">
            <div id="video-wrapper-container">
                <div id="video-wrapper">
                    <video id="video-player"></video>
                    <button id="unmute-btn" class="hidden"><i class="fas fa-volume-mute"></i> Click to Unmute</button>
                    <div class="seek-overlay" id="left-seek-overlay"><i class="fas fa-backward"></i></div>
                    <div class="seek-overlay" id="right-seek-overlay"><i class="fas fa-forward"></i></div>
                    <div class="video-controls-container">
                        <div class="timeline-container"><input type="range" class="timeline" value="0" step="0.1"></div>
                        <div class="controls">
                            <div class="left-controls">
                                <button class="control-btn" id="play-pause-btn"><i class="fas fa-play"></i></button>
                                <div class="time-display"><span id="current-time">0:00</span> / <span id="video-duration">0:00</span></div>
                            </div>
                            <div class="right-controls">
                                <button class="control-btn" id="speed-btn">1x</button>
                                <button class="control-btn" id="fullscreen-btn"><i class="fas fa-expand"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="media-viewer" class="hidden">
                <div id="media-resize-handle"></div>
                <div id="media-viewer-header">
                    <h3 id="viewer-title"></h3>
                    <div class="viewer-actions">
                        <div id="file-switcher-container"></div>
                        <button id="delete-viewer-file" title="Delete File"><i class="fas fa-trash"></i> Delete</button>
                        <button id="close-viewer-btn" title="Close Viewer"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <iframe id="media-viewer-frame"></iframe>
            </div>
            <button id="media-viewer-toggle-btn" class="hidden"><i class="fas fa-chevron-left"></i></button>
        </div>
        <button id="sidebar-toggle-btn"><i class="fas fa-chevron-left"></i></button>
    </div>

    <div id="modal-overlay" class="hidden">
        <div class="modal-content">
            <button id="close-modal-btn" title="Close">&times;</button>
            <h2>Add New Course</h2>
            <button id="add-folder-btn" class="secondary-btn"><i class="fas fa-folder-open"></i> Add Course Folder</button>
        </div>
    </div>
    
    <input type="file" id="thumbnail-uploader" class="hidden" accept="image/*">
    <input type="file" id="add-pdf-input" class="hidden" accept=".pdf">
    <input type="file" id="add-assignment-input" class="hidden" accept=".pdf,.doc,.docx,.txt,.zip">

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const DB_NAME = 'CourseFlixDB';
        const DB_VERSION = 8;
        const STORE_NAME = 'courses';
        const PROGRESS_STORE = 'progress';
        let db;

        // --- Database Helper ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("Error opening IndexedDB");
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (event) => { 
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(PROGRESS_STORE)) db.createObjectStore(PROGRESS_STORE, { keyPath: 'id' });
                };
            });
        }
        function getStore(storeName, mode) { return db.transaction(storeName, mode).objectStore(storeName); }

        // --- DOM Elements ---
        const nav = document.querySelector('nav');
        const navLinks = document.querySelectorAll('.nav-link');
        const homeBtn = document.getElementById('home-btn');
        const views = document.querySelectorAll('.view');
        const courseGrid = document.getElementById('course-grid');
        const reviewGrid = document.getElementById('review-grid');
        const practiceGrid = document.getElementById('practice-grid');
        const playerView = document.getElementById('player-view');
        const videoWrapper = document.getElementById('video-wrapper');
        const videoPlayer = document.getElementById('video-player');
        const unmuteBtn = document.getElementById('unmute-btn');
        const chapterListDiv = document.getElementById('chapter-list');
        const courseTitleMenu = document.getElementById('course-title-menu');
        const backToLibraryBtn = document.querySelector('#player-view .back-link');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const timeline = document.querySelector('.timeline');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const leftSeekOverlay = document.getElementById('left-seek-overlay');
        const rightSeekOverlay = document.getElementById('right-seek-overlay');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const mediaViewerToggleBtn = document.getElementById('media-viewer-toggle-btn');
        const lectureMenu = document.getElementById('lecture-menu');
        const speedBtn = document.getElementById('speed-btn');
        const mediaViewer = document.getElementById('media-viewer');
        const mediaViewerFrame = document.getElementById('media-viewer-frame');
        const viewerTitle = document.getElementById('viewer-title');
        const addPdfInput = document.getElementById('add-pdf-input');
        const addAssignmentInput = document.getElementById('add-assignment-input');
        const mediaResizeHandle = document.getElementById('media-resize-handle');
        const deleteViewerFileBtn = document.getElementById('delete-viewer-file');
        const totalTimeDisplay = document.getElementById('total-time-left-display');
        const closeViewerBtn = document.getElementById('close-viewer-btn');

        let courses = [];
        let currentCourse = null;
        let currentLectureLi = null;
        let courseProgress = {};
        let clickTimer = null;
        let reviewFilter = null;
        let practiceFilter = null;
        let activeStatusCard = null;
        let lastView = 'dashboard-view';
        let activeFileUrl = null;
        let activeViewerFileType = null;
        let isResizing = false;
        let userInteracted = false;

        // --- Utility Functions ---
        function formatTime(timeInSeconds, withHours = true) {
            const time = Math.round(timeInSeconds || 0);
            const hours = Math.floor(time / 3600);
            const minutes = Math.floor((time % 3600) / 60);
            const seconds = Math.floor(time % 60);
            if (hours > 0 && withHours) return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        function formatDuration(seconds) {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }
        function formatTotalDuration(seconds) {
            if (isNaN(seconds) || seconds <= 0) return '0 hours 0 min left';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours} hours ${minutes} min left`;
        }
        const naturalSort = (a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' });
        async function getVideoDuration(file) { return new Promise(r => {const v=document.createElement('video');v.preload='metadata';v.onloadedmetadata=()=>{r(v.duration);URL.revokeObjectURL(v.src)};v.onerror=()=>r(0);v.src=URL.createObjectURL(file)}); }

        // --- Progress Management ---
        async function loadAllProgress() {
            const allProgress = await new Promise(resolve => getStore(PROGRESS_STORE, 'readonly').getAll().onsuccess = e => resolve(e.target.result));
            courseProgress = {};
            allProgress.forEach(item => { courseProgress[item.id] = item; });
        }
        async function saveLectureProgress(data) {
            const progressId = `${data.courseId}_${data.lectureId}`;
            const existing = courseProgress[progressId] || { courseId: data.courseId, lectureId: data.lectureId };
            const progressData = { ...existing, ...data, id: progressId };
            await new Promise(resolve => getStore(PROGRESS_STORE, 'readwrite').put(progressData).onsuccess = resolve);
            courseProgress[progressId] = progressData;
        }
        function getLectureProgress(courseId, lectureId) {
            return courseProgress[`${courseId}_${lectureId}`] || {};
        }

        function calculateCourseProgress(course) {
            if (!course.lectures) return { completed: 0, total: course.videoCount, percentage: 0, remainingDuration: course.totalDuration || 0 };
            let completed = 0;
            let timeCompleted = 0;
            course.lectures.forEach(lecture => {
                const progress = getLectureProgress(course.id, lecture.id);
                if (progress.completed) {
                    completed++;
                    timeCompleted += lecture.duration;
                }
            });
            const total = course.lectures.length;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            const remainingDuration = (course.totalDuration || 0) - timeCompleted;
            return { completed, total, percentage, remainingDuration: Math.max(0, remainingDuration) };
        }
        
        function updateTotalTimeLeftDisplay() {
            let totalSecondsLeft = 0;
            courses.forEach(course => {
                const progress = calculateCourseProgress(course);
                totalSecondsLeft += progress.remainingDuration;
            });
            
            if (totalSecondsLeft > 0) {
                totalTimeDisplay.textContent = formatTotalDuration(totalSecondsLeft);
                totalTimeDisplay.style.display = 'inline-flex';
            } else {
                totalTimeDisplay.textContent = formatTotalDuration(0);
                 totalTimeDisplay.style.display = 'none';
            }
        }

        // --- View Switching & Rendering ---
        function switchView(viewId) {
            activeStatusCard = null; // Clear active card on any view switch
            nav.classList.toggle('hidden', viewId === 'player-view');
            views.forEach(view => view.classList.toggle('active', view.id === viewId));
            navLinks.forEach(link => link.classList.toggle('active', link.dataset.view === viewId));
            if (viewId === 'review-view') renderStatusView('review', reviewFilter);
            if (viewId === 'practice-view') renderStatusView('practice', practiceFilter);
            if (viewId === 'dashboard-view') renderCourseGrid();
            
            // Clear player persistence if navigating away manually
            if (viewId !== 'player-view') {
                sessionStorage.removeItem('courseflixState');
            }
        }
        
        async function loadCoursesFromDB() {
            const storedCourses = await new Promise(resolve => getStore(STORE_NAME, 'readonly').getAll().onsuccess = e => resolve(e.target.result));
            for (const course of storedCourses) {
                const handle = course.handle;
                course.isLinked = handle ? (await handle.queryPermission({ mode: 'read' }) === 'granted') : false;
            }
            courses = storedCourses;
            await renderCourseGrid();
        }
        
        async function scanDirectoryHandle(dirHandle) {
            const chapters = {};
            const lectures = [];
            let totalDuration = 0;
            const videoRegex = /\.(mp4|mkv|webm|mov|avi)$/i;
            
            async function recurse(currentHandle, path) {
                const chapterName = path || "Main Content";
                if (!chapters[chapterName]) {
                    chapters[chapterName] = { name: chapterName, lectures: [] };
                }

                const entries = [];
                for await (const entry of currentHandle.values()) {
                    entries.push(entry);
                }
                entries.sort((a, b) => naturalSort(a,b));

                for (const entry of entries) {
                    if (entry.kind === 'file' && videoRegex.test(entry.name)) {
                        try {
                            const file = await entry.getFile();
                            const duration = await getVideoDuration(file);
                            const lectureData = {
                                id: `${entry.name}_${file.size}_${file.lastModified}`,
                                name: entry.name.replace(/\.[^/.]+$/, ""),
                                displayName: entry.name.replace(/\.[^/.]+$/, ""),
                                handle: entry,
                                duration: duration,
                                chapter: chapterName
                            };
                            chapters[chapterName].lectures.push(lectureData);
                            lectures.push(lectureData);
                            totalDuration += duration;
                        } catch (e) {
                            console.error(`Could not process file ${entry.name}:`, e);
                        }
                    } else if (entry.kind === 'directory') {
                        await recurse(entry, path ? `${path}/${entry.name}` : entry.name);
                    }
                }
            }

            await recurse(dirHandle, '');
            const sortedChapters = Object.values(chapters).filter(ch => ch.lectures.length > 0).sort((a, b) => naturalSort(a, b));
            return { chapters: sortedChapters, videoCount: lectures.length, lectures, totalDuration };
        }

        async function renderCourseGrid() {
            courseGrid.innerHTML = '';
            if (courses.length === 0) { 
                courseGrid.innerHTML = `<p id="no-content-message">No courses added. Click 'Add Course' to begin.</p>`;
                totalTimeDisplay.style.display = 'none';
                return;
            }

            updateTotalTimeLeftDisplay();

            for (const course of courses) {
                const card = document.createElement('div');
                card.className = 'course-card';
                
                if (course.isLinked && course.handle && !course.lectures) {
                    const courseData = await scanDirectoryHandle(course.handle);
                    course.lectures = courseData.lectures;
                    course.totalDuration = courseData.totalDuration;
                    course.chapters = courseData.chapters;
                }
                const progress = calculateCourseProgress(course);

                const ratingStarsHTML = Array.from({length: 5}, (_, i) => 
                    `<i class="fa-star ${ (course.rating || 0) > i ? 'fas' : 'far'}" data-value="${i + 1}"></i>`
                ).join('');
                
                card.innerHTML = `
                    <div class="thumbnail-placeholder ${course.thumbnail ? 'has-thumbnail' : ''}" data-id="${course.id}" style="${course.thumbnail ? `background-image: url('${course.thumbnail}')` : ''}">
                        <i class="fas fa-photo-video"></i>
                        <button class="refresh-course-btn" data-id="${course.id}" title="Refresh Course Content"><i class="fas fa-sync-alt"></i></button>
                        <button class="remove-thumbnail-btn" data-id="${course.id}" title="Remove Thumbnail"><i class="fas fa-times"></i></button>
                        <button class="remove-course-btn" data-id="${course.id}" title="Remove Course"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="course-info">
                        <div>
                            <h3 title="${course.title}">${course.title}</h3>
                            <div class="course-extra-info" data-id="${course.id}">
                                <div class="course-faculty" title="Double-click to edit faculty">${course.facultyName || 'N/A Faculty'}</div>
                                <div class="course-rating">${ratingStarsHTML}</div>
                            </div>
                            <p class="course-meta">${course.videoCount} videos</p>
                            ${course.totalDuration ? `<div class="course-duration">${formatDuration(course.totalDuration)} total • ${formatDuration(progress.remainingDuration)} left</div>` : ''}
                        </div>
                        <div class="course-progress-container">
                            <div class="course-progress-bar"><div class="course-progress-fill" style="width: ${progress.percentage}%"></div></div>
                            <div class="course-progress-text">${progress.completed} / ${progress.total || course.videoCount} lectures completed</div>
                        </div>
                        <button class="enter-course-btn" data-id="${course.id}">Enter Course</button>
                    </div>`;
                courseGrid.appendChild(card);
            }
        }

        function renderStatusView(status, filter = null) {
            const grid = status === 'review' ? reviewGrid : practiceGrid;
            const dropdown = document.getElementById(`filter-dropdown-${status}`);
            const allItems = Object.values(courseProgress).filter(p => p.status === status);
            
            const courseTitles = [...new Set(allItems.map(item => item.courseTitle))];
            dropdown.innerHTML = '<a>All Courses</a>';
            courseTitles.sort().forEach(title => {
                dropdown.innerHTML += `<a data-course-title="${title}">${title}</a>`;
            });

            const items = allItems.filter(p => !filter || p.courseTitle === filter);
            
            grid.innerHTML = '';
            if (items.length === 0) {
                const message = filter ? `No lectures for "${filter}" marked for ${status}.` : `You haven't marked any lectures for ${status}.`;
                grid.innerHTML = `<p id="no-content-message">${message}</p>`; 
                return;
            }

            items.sort((a, b) => {
                const titleA = (a.courseTitle || '') + (a.lectureName || '');
                const titleB = (b.courseTitle || '') + (b.lectureName || '');
                return titleA.localeCompare(titleB);
            }).forEach(item => {
                const card = document.createElement('div');
                card.className = 'lecture-review-card';
                card.dataset.lectureId = item.lectureId;
                card.dataset.courseId = item.courseId;

                const watchedTime = item.currentTime || 0;
                const totalTime = item.lectureDuration || 1;
                const progressPercent = (watchedTime / totalTime) * 100;

                card.innerHTML = `
                    <button class="remove-status-btn" title="Remove Status"><i class="fas fa-times"></i></button>
                    <div class="lecture-review-info">
                        <p class="course-title">${item.courseTitle || 'Unknown Course'}</p>
                        <h3>${item.lectureName || 'Unknown Lecture'}</h3>
                        <div class="lecture-progress-bar"><div class="lecture-progress-fill" style="width: ${progressPercent}%"></div></div>
                        <div class="lecture-review-meta"><span class="time-display">${formatTime(watchedTime)} / ${formatTime(totalTime)}</span></div>
                    </div>
                    <div class="card-action-center">
                        <button class="primary-btn">
                            <i class="fas fa-play"></i> Watch Lecture
                        </button>
                    </div>`;
                grid.appendChild(card);
            });
        }

        // --- Player ---
        function updateMenuProgress() {
            if (!currentCourse) return;
            const progress = calculateCourseProgress(currentCourse);
            const container = document.querySelector('#player-view .menu-header');
            container.querySelector('.course-stats').textContent = `${formatDuration(currentCourse.totalDuration)} total • ${formatDuration(progress.remainingDuration)} remaining`;
            container.querySelector('.menu-progress-fill').style.width = `${progress.percentage}%`;
            container.querySelector('.menu-progress-text').textContent = `${progress.completed}/${progress.total} lectures completed`;
        }

        async function playLectureFromAnywhere(courseId, lectureId, originView = 'dashboard-view') {
            lastView = originView;
            const course = courses.find(c => c.id === parseInt(courseId));
            if (!course) {
                alert('Course not found.');
                return;
            }
            if (!course.isLinked) {
                const handle = course.handle;
                if (await handle.requestPermission({ mode: 'read' }) !== 'granted') { 
                    alert('Permission to access course files denied.');
                    return; 
                }
                course.isLinked = true;
            }
            await renderPlayer(courseId, lectureId, originView);
        }

        async function renderPlayer(courseId, lectureIdToPlay = null, originView = 'dashboard-view', startTime = null) {
            currentCourse = courses.find(c => c.id === parseInt(courseId));
            if (!currentCourse) return;
            switchView('player-view');
            chapterListDiv.innerHTML = '<p style="text-align:center; padding: 20px;">Loading lectures...</p>';
            
            if (originView === 'dashboard-view') {
                backToLibraryBtn.textContent = '← Back to Courses';
            } else {
                const statusName = originView.split('-')[0];
                backToLibraryBtn.textContent = `← Back to ${statusName.charAt(0).toUpperCase() + statusName.slice(1)}`;
            }
            backToLibraryBtn.dataset.view = originView;

            if (!currentCourse.lectures || !currentCourse.chapters) {
                try {
                    const courseData = await scanDirectoryHandle(currentCourse.handle);
                    currentCourse.lectures = courseData.lectures;
                    currentCourse.totalDuration = courseData.totalDuration;
                    currentCourse.chapters = courseData.chapters;
                } catch (error) {
                    console.error('Failed to load course data:', error);
                    chapterListDiv.innerHTML = `<p id="no-content-message">Error: Could not load course content. The original folder may have been moved or deleted.</p>`;
                    return;
                }
            }
            
            let chaptersToDisplay = currentCourse.chapters;
            if (originView === 'review-view' || originView === 'practice-view') {
                const status = originView.split('-')[0];
                const statusLectures = Object.values(courseProgress)
                    .filter(p => p.status === status && p.courseId === currentCourse.id)
                    .map(p => p.lectureId);

                chaptersToDisplay = currentCourse.chapters.map(chapter => {
                    const filteredLectures = chapter.lectures.filter(l => statusLectures.includes(l.id));
                    return { ...chapter, lectures: filteredLectures };
                }).filter(chapter => chapter.lectures.length > 0);
                
                courseTitleMenu.textContent = `${currentCourse.title} (${status.charAt(0).toUpperCase() + status.slice(1)} Lectures)`;
            } else {
                courseTitleMenu.textContent = currentCourse.title;
            }

            updateMenuProgress();
            renderChapterList(chaptersToDisplay, lectureIdToPlay);

            const liToPlay = chapterListDiv.querySelector(`li[data-lecture-id="${lectureIdToPlay}"]`) || chapterListDiv.querySelector('li');
            if (liToPlay) await playVideo(liToPlay, startTime);
        }
        
        function renderChapterList(chaptersToDisplay, lectureIdToPlay = null) {
             chapterListDiv.innerHTML = '';
             if (!chaptersToDisplay || chaptersToDisplay.length === 0 || (chaptersToDisplay.length === 1 && chaptersToDisplay[0].lectures.length === 0)) {
                chapterListDiv.innerHTML = `<p id="no-content-message">No lectures found for this course or filter.</p>`;
                return;
             }
            
             chaptersToDisplay.forEach((chapter) => {
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'chapter open';
                chapterDiv.dataset.chapterName = chapter.name;
                chapterDiv.draggable = true;

                const chapterDuration = chapter.lectures.reduce((sum, lect) => sum + (lect.duration || 0), 0);

                chapterDiv.innerHTML = `
                    <div class="chapter-title">
                        <i class="fas fa-grip-vertical chapter-drag-handle" title="Drag to reorder"></i>
                        <i class="fas fa-chevron-right"></i>
                        <span class="chapter-title-text" title="Double-click to rename">${chapter.name}</span>
                        <span class="chapter-duration">${formatDuration(chapterDuration)}</span>
                    </div>`;

                const lectureList = document.createElement('ul');
                lectureList.className = 'lecture-list';

                for (const lecture of chapter.lectures) {
                    const progress = getLectureProgress(currentCourse.id, lecture.id);
                    const lectureLi = document.createElement('li');
                    lectureLi.dataset.lectureId = lecture.id;

                    const pdfBtn = progress.pdfHandle
                        ? `<button class="file-btn view-pdf-btn" title="${progress.pdfName || 'View Notes'}"><i class="fas fa-file-pdf"></i></button>`
                        : `<button class="file-btn add-pdf-btn" title="Add Notes (PDF)"><i class="fas fa-plus"></i></button>`;

                    const assignBtn = progress.assignmentHandle
                        ? `<button class="file-btn view-assignment-btn" title="${progress.assignmentName || 'View Assignment'}"><i class="fas fa-file-alt"></i></button>`
                        : `<button class="file-btn add-assignment-btn" title="Add Assignment"><i class="fas fa-plus"></i></button>`;

                    lectureLi.innerHTML = `
                        <div class="lecture-checkbox ${progress.completed ? 'completed' : ''}"><i class="fas fa-check"></i></div>
                        <div class="lecture-title ${progress.completed ? 'completed' : ''}" title="${lecture.displayName} (Double-click to rename)">${lecture.displayName}</div>
                        <div class="file-controls">
                            ${pdfBtn}
                            ${assignBtn}
                        </div>
                        <span class="lecture-duration">${formatTime(lecture.duration, false)}</span>
                        <button class="status-btn ${progress.status || ''}" data-lecture-name="${lecture.displayName}" data-duration="${lecture.duration}">
                            ${progress.status ? progress.status.toUpperCase() : 'STATUS'}
                        </button>`;
                    lectureList.appendChild(lectureLi);
                }
                chapterDiv.appendChild(lectureList);
                chapterListDiv.appendChild(chapterDiv);
            });
        }

        async function playVideo(liElement, startTime = null) {
            if (currentLectureLi) currentLectureLi.classList.remove('active');
            currentLectureLi = liElement;
            currentLectureLi.classList.add('active');
            const lectureId = liElement.dataset.lectureId;
            const lecture = currentCourse.lectures.find(l => l.id === lectureId);
            if (!lecture) return;

            updateMediaViewerToggleButton();

            try {
                const file = await lecture.handle.getFile();
                if(videoPlayer.src) URL.revokeObjectURL(videoPlayer.src);
                videoPlayer.src = URL.createObjectURL(file);
                videoPlayer.load();

                videoPlayer.addEventListener('loadeddata', async () => {
                    let timeToSet = startTime;
                    if (timeToSet === null) {
                        const progress = getLectureProgress(currentCourse.id, lecture.id);
                        if(progress.currentTime) timeToSet = progress.currentTime;
                    }
                    if(timeToSet) videoPlayer.currentTime = timeToSet;
                    
                    unmuteBtn.classList.add('hidden');
                    videoPlayer.muted = !userInteracted;

                    try {
                        await videoPlayer.play();
                    } catch (err) {
                        console.warn("Autoplay was prevented:", err.message);
                        videoPlayer.muted = true;
                        unmuteBtn.classList.remove('hidden');
                        await videoPlayer.play();
                    }
                }, { once: true });

                videoPlayer.onended = () => {
                    const lectureId = currentLectureLi.dataset.lectureId;
                    const lecture = currentCourse.lectures.find(l => l.id === lectureId);
                    saveLectureProgress({ 
                        courseId: currentCourse.id, 
                        lectureId, 
                        completed: true, 
                        currentTime: 0,
                        lectureName: lecture.displayName,
                        courseTitle: currentCourse.title,
                        lectureDuration: lecture.duration
                    });
                    updateMenuProgress();
                    updateTotalTimeLeftDisplay();
                    liElement.querySelector('.lecture-checkbox').classList.add('completed');
                    liElement.querySelector('.lecture-title').classList.add('completed');
                };
            } catch (error) {
                console.error("Failed to load video:", error);
                alert("Could not load video. The original file may have been moved or deleted.");
                videoPlayer.src = "";
                videoPlayer.load();
            }
        }
        
        async function refreshCourse(courseId, btnElement) {
            const course = courses.find(c => c.id === courseId);
            if (!course || !course.handle) {
                alert('Could not find the course folder. It may have been moved or deleted.');
                return;
            }

            if (btnElement) btnElement.classList.add('loading');

            try {
                if ((await course.handle.queryPermission({ mode: 'read' })) !== 'granted') {
                    if ((await course.handle.requestPermission({ mode: 'read' })) !== 'granted') {
                        alert('Permission denied. Cannot refresh course.');
                        return;
                    }
                }

                const newCourseData = await scanDirectoryHandle(course.handle);

                course.lectures = newCourseData.lectures;
                course.chapters = newCourseData.chapters;
                course.videoCount = newCourseData.videoCount;
                course.totalDuration = newCourseData.totalDuration;
                
                await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(course).onsuccess = resolve);
                await renderCourseGrid();
            } catch (error) {
                console.error('Error refreshing course:', error);
                alert('An error occurred while refreshing the course.');
            } finally {
                // No need to remove 'loading' class as the element is re-rendered
            }
        }

        async function showMediaViewer(fileHandle, fileType, fileName, lectureProgress) {
            try {
                let file = fileHandle instanceof File ? fileHandle : await fileHandle.getFile();
                if (activeFileUrl) URL.revokeObjectURL(activeFileUrl);
                
                activeFileUrl = URL.createObjectURL(file);
                mediaViewerFrame.src = activeFileUrl;
                viewerTitle.textContent = fileName || file.name;
                activeViewerFileType = fileType.toLowerCase();
                
                updateFileSwitcher(lectureProgress, activeViewerFileType);

                const preferredWidth = localStorage.getItem('viewerWidth') || '500px';
                playerView.style.setProperty('--viewer-width', preferredWidth);
                mediaViewer.style.width = preferredWidth;
                playerView.classList.add('viewer-active');
                mediaViewer.classList.remove('hidden');
                
                mediaViewerToggleBtn.classList.add('hidden');

                deleteViewerFileBtn.dataset.type = activeViewerFileType;
                deleteViewerFileBtn.classList.add('visible');
            } catch (error) {
                console.error("Error showing file:", error);
                alert("Failed to open file. The original may have been moved or deleted. Please try re-adding it.");
                hideMediaViewer();
            }
        }

        function updateFileSwitcher(lectureProgress, currentType) {
            const container = document.getElementById('file-switcher-container');
            container.innerHTML = '';

            const hasPdf = !!lectureProgress.pdfHandle;
            const hasAssignment = !!lectureProgress.assignmentHandle;

            if (hasPdf && hasAssignment) {
                const otherType = currentType === 'pdf' ? 'assignment' : 'pdf';
                const otherHandle = otherType === 'pdf' ? lectureProgress.pdfHandle : lectureProgress.assignmentHandle;
                const otherName = otherType === 'pdf' ? lectureProgress.pdfName : lectureProgress.assignmentName;

                container.innerHTML = `
                    <button id="file-switcher-btn">${currentType.toUpperCase()} <i class="fas fa-chevron-down fa-xs"></i></button>
                    <div id="file-switcher-dropdown" class="hidden">
                         <button data-type="${otherType}">${otherType === 'pdf' ? 'View Notes' : 'View Assignment'}</button>
                    </div>`;

                const btn = container.querySelector('#file-switcher-btn');
                const dropdown = container.querySelector('#file-switcher-dropdown');
                btn.onclick = () => dropdown.classList.toggle('hidden');
                
                dropdown.querySelector('button').onclick = () => {
                    showMediaViewer(otherHandle, otherType, otherName, lectureProgress);
                };
                document.addEventListener('click', (e) => {
                     if (!container.contains(e.target)) dropdown.classList.add('hidden');
                }, { once: true });
            }
        }
        
        function hideMediaViewer() {
            playerView.classList.remove('viewer-active');
            mediaViewer.classList.add('hidden');
            deleteViewerFileBtn.classList.remove('visible');
            if (activeFileUrl) {
                URL.revokeObjectURL(activeFileUrl);
                activeFileUrl = null;
            }
            mediaViewerFrame.src = 'about:blank';
            activeViewerFileType = null;
            playerView.style.setProperty('--viewer-width', '0px');
            updateMediaViewerToggleButton();
        }

        function updateMediaViewerToggleButton() {
            if (!currentLectureLi) {
                mediaViewerToggleBtn.classList.add('hidden');
                return;
            }
            const lectureId = currentLectureLi.dataset.lectureId;
            const progress = getLectureProgress(currentCourse.id, lectureId);
            const hasFiles = progress.pdfHandle || progress.assignmentHandle;
            
            // Show toggle button only if files exist AND the viewer is currently closed
            const viewerIsHidden = mediaViewer.classList.contains('hidden');
            mediaViewerToggleBtn.classList.toggle('hidden', !hasFiles || !viewerIsHidden);
        }

        // --- Event Listeners ---
        navLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); switchView(e.target.dataset.view); }));
        homeBtn.addEventListener('click', () => switchView('dashboard-view'));

        document.body.addEventListener('click', async (e) => {
            userInteracted = true;
            videoPlayer.muted = false;
            unmuteBtn.classList.add('hidden');

            if (e.target.closest('.enter-course-btn')) { await playLectureFromAnywhere(e.target.closest('.enter-course-btn').dataset.id, null); }
            
            const reviewCard = e.target.closest('#review-grid .lecture-review-card, #practice-grid .lecture-review-card');
            if (reviewCard && !e.target.closest('.remove-status-btn')) {
                activeStatusCard = reviewCard;
                const currentViewId = document.querySelector('.view.active').id;
                await playLectureFromAnywhere(reviewCard.dataset.courseId, reviewCard.dataset.lectureId, currentViewId);
                return;
            }

            const removeStatusBtn = e.target.closest('.remove-status-btn');
            if (removeStatusBtn) {
                e.stopPropagation();
                const card = removeStatusBtn.parentElement;
                const courseId = parseInt(card.dataset.courseId);
                const lectureId = card.dataset.lectureId;
                const progress = getLectureProgress(courseId, lectureId);
                if (progress) {
                    progress.status = null;
                    await saveLectureProgress(progress);
                    const activeView = document.querySelector('.view.active');
                    if (activeView.id === 'review-view') {
                        renderStatusView('review', reviewFilter);
                    } else if (activeView.id === 'practice-view') {
                        renderStatusView('practice', practiceFilter);
                    }
                }
            }

            const removeBtn = e.target.closest('.remove-course-btn');
            if (removeBtn) { e.stopPropagation(); const courseId = parseInt(removeBtn.dataset.id); if (confirm('Are you sure you want to remove this course? This will also delete its progress.')) { await new Promise(resolve => getStore(STORE_NAME, 'readwrite').delete(courseId).onsuccess = resolve); await loadCoursesFromDB(); } }
            
            const refreshBtn = e.target.closest('.refresh-course-btn');
            if (refreshBtn) { e.stopPropagation(); const courseId = parseInt(refreshBtn.dataset.id); await refreshCourse(courseId, refreshBtn); }
            
            const thumbPlaceholder = e.target.closest('.thumbnail-placeholder');
            if (thumbPlaceholder && !removeBtn && !refreshBtn && !e.target.closest('.remove-thumbnail-btn')) { document.getElementById('thumbnail-uploader').dataset.courseId = thumbPlaceholder.dataset.id; document.getElementById('thumbnail-uploader').click(); }
            if (e.target.closest('.remove-thumbnail-btn')) { e.stopPropagation(); const btn = e.target.closest('.remove-thumbnail-btn'); const course = courses.find(c => c.id === parseInt(btn.dataset.id)); if (course) { delete course.thumbnail; getStore(STORE_NAME, 'readwrite').put(course); renderCourseGrid(); } }
            
            const filterBtnReview = e.target.closest('#filter-btn-review');
            if(filterBtnReview) document.getElementById('filter-dropdown-review').classList.toggle('hidden');
            const filterBtnPractice = e.target.closest('#filter-btn-practice');
            if(filterBtnPractice) document.getElementById('filter-dropdown-practice').classList.toggle('hidden');
            
            const filterLink = e.target.closest('.filter-dropdown a');
            if(filterLink) {
                e.preventDefault();
                const title = filterLink.dataset.courseTitle;
                const dropdown = filterLink.parentElement;
                if (dropdown.id.includes('review')) {
                    reviewFilter = title;
                    renderStatusView('review', reviewFilter);
                } else {
                    practiceFilter = title;
                    renderStatusView('practice', practiceFilter);
                }
                dropdown.classList.add('hidden');
            }
        });

        courseGrid.addEventListener('dblclick', (e) => {
            const facultyDiv = e.target.closest('.course-faculty');
            if (!facultyDiv || facultyDiv.querySelector('input')) return;
            
            const originalText = facultyDiv.textContent;
            facultyDiv.innerHTML = `<input type="text" class="course-faculty-input" value="${originalText === 'N/A Faculty' ? '' : originalText}" />`;
            const input = facultyDiv.querySelector('input');
            input.focus();
            input.select();
            
            const saveFacultyName = async () => {
                const courseId = parseInt(facultyDiv.parentElement.dataset.id);
                const course = courses.find(c => c.id === courseId);
                if (!course) return;

                const newName = input.value.trim();
                facultyDiv.textContent = newName || 'N/A Faculty';
                
                if (newName !== (course.facultyName || '')) {
                     course.facultyName = newName || null;
                     await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(course).onsuccess = resolve);
                }
            };
            
            input.addEventListener('blur', saveFacultyName);
            input.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter') input.blur();
                if (ev.key === 'Escape') {
                    input.removeEventListener('blur', saveFacultyName);
                    facultyDiv.textContent = originalText;
                }
            });
        });

        courseGrid.addEventListener('click', async (e) => {
            const star = e.target.closest('.course-rating i.fa-star');
            if (!star) return;

            const ratingContainer = star.parentElement;
            const courseId = parseInt(ratingContainer.parentElement.dataset.id);
            const course = courses.find(c => c.id === courseId);
            if (!course) return;

            const newRating = parseInt(star.dataset.value);
            // If the user clicks the same star value again, toggle it off (set rating to 0)
            course.rating = (course.rating === newRating) ? 0 : newRating; 

            await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(course).onsuccess = resolve);
            
            // Re-render just the stars for this card
            const allStars = ratingContainer.querySelectorAll('i');
            allStars.forEach((s, i) => {
                s.classList.toggle('fas', course.rating > i);
                s.classList.toggle('far', course.rating <= i);
            });
        });

        chapterListDiv.addEventListener('click', async (e) => {
            const lectureLi = e.target.closest('li');
            const chapterTitle = e.target.closest('.chapter-title');

            if(chapterTitle && !e.target.closest('.chapter-drag-handle') && !e.target.classList.contains('chapter-title-text')) { 
                chapterTitle.parentElement.classList.toggle('open'); 
                return; 
            }
            if(!lectureLi) return;

            const lectureId = lectureLi.dataset.lectureId;
            const lectureProgress = getLectureProgress(currentCourse.id, lectureId);
            const lecture = currentCourse.lectures.find(l => l.id === lectureId);

            if (e.target.closest('.add-pdf-btn')) {
                addPdfInput.dataset.lectureId = lectureId;
                addPdfInput.click();
            } else if (e.target.closest('.add-assignment-btn')) {
                addAssignmentInput.dataset.lectureId = lectureId;
                addAssignmentInput.click();
            } else if (e.target.closest('.view-pdf-btn')) {
                if (lectureProgress.pdfHandle) {
                    if (activeViewerFileType === 'pdf' && !mediaViewer.classList.contains('hidden')) hideMediaViewer();
                    else showMediaViewer(lectureProgress.pdfHandle, 'PDF', lectureProgress.pdfName, lectureProgress);
                }
            } else if (e.target.closest('.view-assignment-btn')) {
                if (lectureProgress.assignmentHandle) {
                    if (activeViewerFileType === 'assignment' && !mediaViewer.classList.contains('hidden')) hideMediaViewer();
                    else showMediaViewer(lectureProgress.assignmentHandle, 'Assignment', lectureProgress.assignmentName, lectureProgress);
                }
            } else if (e.target.closest('.status-btn')) {
                e.stopPropagation();
                const btn = e.target.closest('.status-btn');
                const currentStatus = lectureProgress.status;
                let newStatus = 'review';
                if (currentStatus === 'review') newStatus = 'practice';
                else if (currentStatus === 'practice') newStatus = null;
                btn.className = 'status-btn';
                if (newStatus) btn.classList.add(newStatus);
                btn.textContent = newStatus ? newStatus.toUpperCase() : 'STATUS';
                await saveLectureProgress({ ...lectureProgress, status: newStatus, courseTitle: currentCourse.title, lectureName: lecture.displayName, lectureDuration: lecture.duration, courseId: currentCourse.id, lectureId: lectureId });
            } else if(e.target.closest('.lecture-checkbox')) {
                e.stopPropagation();
                const checkbox = e.target.closest('.lecture-checkbox');
                const isCompleted = !checkbox.classList.contains('completed');
                checkbox.classList.toggle('completed');
                lectureLi.querySelector('.lecture-title').classList.toggle('completed');
                await saveLectureProgress({ 
                    ...lectureProgress, 
                    completed: isCompleted, 
                    courseId: currentCourse.id, 
                    lectureId: lectureId,
                    lectureName: lecture.displayName,
                    courseTitle: currentCourse.title,
                    lectureDuration: lecture.duration
                });
                updateMenuProgress();
                updateTotalTimeLeftDisplay();
            } else if (!e.target.classList.contains('lecture-title-input')) {
                playVideo(lectureLi);
            }
        });
        
        chapterListDiv.addEventListener('dblclick', (e) => {
            const titleDiv = e.target.closest('.lecture-title, .chapter-title-text');
            if (!titleDiv || titleDiv.querySelector('input')) return;

            const isChapter = titleDiv.classList.contains('chapter-title-text');
            const originalText = titleDiv.textContent;
            
            titleDiv.innerHTML = `<input type="text" class="lecture-title-input" value="${originalText}" />`;
            const input = titleDiv.querySelector('input');
            input.focus();
            input.select();
            
            const saveRename = async () => {
                const newName = input.value.trim();
                if (isChapter) {
                    const chapterDiv = titleDiv.closest('.chapter');
                    const oldName = chapterDiv.dataset.chapterName;
                    if (newName && newName !== oldName) {
                        const chapter = currentCourse.chapters.find(c => c.name === oldName);
                        if(chapter) {
                            chapter.name = newName;
                            // Update all lectures within this chapter
                            currentCourse.lectures.forEach(l => {
                                if (l.chapter === oldName) {
                                    l.chapter = newName;
                                }
                            });
                            await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(currentCourse).onsuccess = resolve);
                            chapterDiv.dataset.chapterName = newName;
                        }
                    }
                    titleDiv.innerHTML = newName || oldName;
                } else {
                    const li = titleDiv.closest('li');
                    const lectureId = li.dataset.lectureId;
                    const lecture = currentCourse.lectures.find(l => l.id === lectureId);
                    
                    if (newName && newName !== lecture.displayName) {
                        lecture.displayName = newName;
                        await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(currentCourse).onsuccess = resolve);
                        const progress = getLectureProgress(currentCourse.id, lectureId);
                        if (progress) {
                            await saveLectureProgress({ ...progress, lectureName: newName, courseId: currentCourse.id, lectureId: lectureId });
                        }
                    }
                    titleDiv.innerHTML = newName || lecture.displayName;
                    titleDiv.title = (newName || lecture.displayName) + " (Double-click to rename)";
                    li.querySelector('.status-btn').dataset.lectureName = newName || lecture.displayName;
                }
            };

            input.addEventListener('blur', saveRename);
            input.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter') input.blur();
                if (ev.key === 'Escape') {
                    input.removeEventListener('blur', saveRename);
                    titleDiv.innerHTML = originalText;
                }
            });
        });

        addPdfInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const lectureId = e.target.dataset.lectureId;
            if (file && lectureId) {
                const progressData = getLectureProgress(currentCourse.id, lectureId);
                await saveLectureProgress({ ...progressData, pdfHandle: file, pdfName: file.name, courseId: currentCourse.id, lectureId: lectureId });
                await renderPlayer(currentCourse.id, lectureId, lastView);
                await showMediaViewer(file, 'PDF', file.name, getLectureProgress(currentCourse.id, lectureId));
            }
            e.target.value = null;
        });

        addAssignmentInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const lectureId = e.target.dataset.lectureId;
            if (file && lectureId) {
                const progressData = getLectureProgress(currentCourse.id, lectureId);
                await saveLectureProgress({ ...progressData, assignmentHandle: file, assignmentName: file.name, courseId: currentCourse.id, lectureId: lectureId });
                await renderPlayer(currentCourse.id, lectureId, lastView);
                await showMediaViewer(file, 'Assignment', file.name, getLectureProgress(currentCourse.id, lectureId));
            }
            e.target.value = null;
        });
        
        backToLibraryBtn.addEventListener('click', () => {
            videoPlayer.pause(); videoPlayer.src = ""; videoPlayer.load();
            hideMediaViewer();
            switchView(lastView);
        });

        closeViewerBtn.addEventListener('click', hideMediaViewer);
        
        mediaViewerToggleBtn.addEventListener('click', () => {
            const isHidden = mediaViewer.classList.contains('hidden');
            if (isHidden) {
                const lectureId = currentLectureLi.dataset.lectureId;
                const progress = getLectureProgress(currentCourse.id, lectureId);
                let fileToShow = null;
                if (activeViewerFileType === 'pdf' && progress.pdfHandle) {
                   fileToShow = { handle: progress.pdfHandle, type: 'PDF', name: progress.pdfName };
                } else if (activeViewerFileType === 'assignment' && progress.assignmentHandle) {
                   fileToShow = { handle: progress.assignmentHandle, type: 'Assignment', name: progress.assignmentName };
                } else if (progress.pdfHandle) {
                   fileToShow = { handle: progress.pdfHandle, type: 'PDF', name: progress.pdfName };
                } else if (progress.assignmentHandle) {
                   fileToShow = { handle: progress.assignmentHandle, type: 'Assignment', name: progress.assignmentName };
                }

                if(fileToShow) {
                    showMediaViewer(fileToShow.handle, fileToShow.type, fileToShow.name, progress);
                }
            } else {
                hideMediaViewer();
            }
        });

        deleteViewerFileBtn.addEventListener('click', async () => {
            const fileType = deleteViewerFileBtn.dataset.type;
            if (!currentLectureLi || !fileType) return;
            if (confirm(`Are you sure you want to delete this ${fileType}?`)) {
                const lectureId = currentLectureLi.dataset.lectureId;
                const lectureProgress = getLectureProgress(currentCourse.id, lectureId);
                if (fileType === 'pdf') {
                    delete lectureProgress.pdfHandle;
                    delete lectureProgress.pdfName;
                } else if (fileType === 'assignment') {
                    delete lectureProgress.assignmentHandle;
                    delete lectureProgress.assignmentName;
                }
                await saveLectureProgress(lectureProgress);
                hideMediaViewer();
                updateMediaViewerToggleButton();
                await renderPlayer(currentCourse.id, lectureId, lastView);
            }
        });
        
        setInterval(() => {
            if (currentCourse && currentLectureLi && !videoPlayer.paused) {
                const lectureId = currentLectureLi.dataset.lectureId;
                const currentTime = videoPlayer.currentTime;
                saveLectureProgress({ courseId: currentCourse.id, lectureId: lectureId, currentTime: currentTime });
                const state = { view: 'player-view', courseId: currentCourse.id, lectureId, currentTime, lastView, sidebarCollapsed: lectureMenu.classList.contains('hidden') };
                sessionStorage.setItem('courseflixState', JSON.stringify(state));
            }
        }, 5000);

        window.addEventListener('beforeunload', () => {
            if (document.querySelector('.view.active')?.id === 'player-view' && currentCourse && currentLectureLi) {
                const lectureId = currentLectureLi.dataset.lectureId;
                const currentTime = videoPlayer.currentTime;
                const state = { view: 'player-view', courseId: currentCourse.id, lectureId, currentTime, lastView, sidebarCollapsed: lectureMenu.classList.contains('hidden') };
                sessionStorage.setItem('courseflixState', JSON.stringify(state));
            }
        });
        
        document.getElementById('add-course-btn').addEventListener('click', () => document.getElementById('modal-overlay').classList.remove('hidden'));
        document.getElementById('close-modal-btn').addEventListener('click', () => document.getElementById('modal-overlay').classList.add('hidden'));
        document.getElementById('modal-overlay').addEventListener('click', (e) => { if (e.target.id === 'modal-overlay') e.target.classList.add('hidden'); });
        
        document.getElementById('add-folder-btn').addEventListener('click', async () => { 
            try {
                const dirHandle = await window.showDirectoryPicker({ startIn: 'downloads' });
                const courseData = await scanDirectoryHandle(dirHandle);
                if (courseData.videoCount === 0) {
                    return alert('No videos found in this folder or its subfolders.');
                }
                const newCourse = {
                    id: Date.now(), title: dirHandle.name, handle: dirHandle,
                    videoCount: courseData.videoCount, lectures: courseData.lectures,
                    totalDuration: courseData.totalDuration, chapters: courseData.chapters
                };
                getStore(STORE_NAME, 'readwrite').add(newCourse);
                await loadCoursesFromDB();
            } catch (e) {
                console.error(e);
            } finally {
                document.getElementById('modal-overlay').classList.add('hidden');
            }
        });

        document.getElementById('thumbnail-uploader').addEventListener('change', (e) => { const file = e.target.files[0]; const courseId = parseInt(e.target.dataset.courseId); if (!file || !courseId) return; const reader = new FileReader(); reader.onload = async (event) => { const course = courses.find(c=>c.id === courseId); if(course) { course.thumbnail = event.target.result; getStore(STORE_NAME, 'readwrite').put(course); renderCourseGrid(); } }; reader.readAsDataURL(file); });
        
        sidebarToggleBtn.addEventListener('click', () => {
            lectureMenu.classList.toggle('hidden');
            sidebarToggleBtn.classList.toggle('collapsed');
        });
        
        // --- Drag and Drop for Chapters ---
        let draggedChapter = null;

        chapterListDiv.addEventListener('dragstart', e => {
            if (e.target.classList.contains('chapter')) {
                draggedChapter = e.target;
                setTimeout(() => {
                    draggedChapter.classList.add('dragging');
                }, 0);
            } else {
                e.preventDefault();
            }
        });

        chapterListDiv.addEventListener('dragend', () => {
            if (draggedChapter) {
                draggedChapter.classList.remove('dragging');
            }
            draggedChapter = null;
            document.querySelectorAll('.chapter-drop-indicator').forEach(el => el.remove());
        });

        chapterListDiv.addEventListener('dragover', e => {
            e.preventDefault();
            const container = chapterListDiv;
            const afterElement = getDragAfterElement(container, e.clientY);
            
            document.querySelectorAll('.chapter-drop-indicator').forEach(el => el.remove());

            const indicator = document.createElement('div');
            indicator.className = 'chapter-drop-indicator';

            if (afterElement == null) {
                container.appendChild(indicator);
            } else {
                container.insertBefore(indicator, afterElement);
            }
        });
        
        chapterListDiv.addEventListener('drop', async e => {
            e.preventDefault();
            if (!draggedChapter) return;
            
            const fromName = draggedChapter.dataset.chapterName;
            const fromIndex = currentCourse.chapters.findIndex(c => c.name === fromName);

            const dropIndicator = chapterListDiv.querySelector('.chapter-drop-indicator');
            const afterElement = dropIndicator ? dropIndicator.nextElementSibling : null;

            let toIndex;
            if (afterElement) {
                const toName = afterElement.dataset.chapterName;
                toIndex = currentCourse.chapters.findIndex(c => c.name === toName);
            } else {
                toIndex = currentCourse.chapters.length;
            }

            if (fromIndex < toIndex) { toIndex--; }
            
            const [movedItem] = currentCourse.chapters.splice(fromIndex, 1);
            currentCourse.chapters.splice(toIndex, 0, movedItem);

            await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(currentCourse).onsuccess = resolve);
            renderChapterList(currentCourse.chapters);
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.chapter:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- Video Player Controls ---
        unmuteBtn.addEventListener('click', () => {
            videoPlayer.muted = false;
            unmuteBtn.classList.add('hidden');
        });
        const showSeekIcon = (overlay) => { overlay.classList.add('show-icon'); setTimeout(() => overlay.classList.remove('show-icon'), 500); };
        playPauseBtn.addEventListener('click', () => videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause());
        videoPlayer.addEventListener('play', () => playPauseBtn.innerHTML = `<i class="fas fa-pause"></i>`);
        videoPlayer.addEventListener('pause', () => playPauseBtn.innerHTML = `<i class="fas fa-play"></i>`);
        videoWrapper.addEventListener('click', (e) => { if (e.target.closest('.video-controls-container') || e.target.closest('#unmute-btn')) return; if (clickTimer) { clearTimeout(clickTimer); clickTimer = null; } clickTimer = setTimeout(() => { if (!e.target.closest('#media-viewer')) playPauseBtn.click(); }, 250); });
        videoWrapper.addEventListener('dblclick', (e) => { if (e.target.closest('.video-controls-container') || e.target.closest('#media-viewer')) return; clearTimeout(clickTimer); clickTimer = null; const r=videoWrapper.getBoundingClientRect(),c=e.clientX-r.left;if(c<r.width/2){videoPlayer.currentTime-=10;showSeekIcon(leftSeekOverlay)}else{videoPlayer.currentTime+=10;showSeekIcon(rightSeekOverlay)}});
        videoPlayer.addEventListener('timeupdate', () => { 
            const currentTime = videoPlayer.currentTime;
            document.getElementById('current-time').textContent = formatTime(currentTime); 
            if (!isNaN(videoPlayer.duration)) { 
                const duration = videoPlayer.duration;
                timeline.value = currentTime; 
                const p = (currentTime / duration) * 100; 
                timeline.style.background = `linear-gradient(to right, var(--accent-primary) ${p}%, rgba(255, 255, 255, 0.3) ${p}%)`;
                if(activeStatusCard) {
                    activeStatusCard.querySelector('.lecture-progress-fill').style.width = `${p}%`;
                    activeStatusCard.querySelector('.time-display').textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
                }
            } 
        });
        videoPlayer.addEventListener('loadedmetadata', () => { document.getElementById('video-duration').textContent = formatTime(videoPlayer.duration); timeline.max = videoPlayer.duration; });
        timeline.addEventListener('input', (e) => videoPlayer.currentTime = e.target.value);
        fullscreenBtn.addEventListener('click', () => { if (!document.fullscreenElement) playerView.requestFullscreen().catch(err => alert(`Error: ${err.message}`)); else document.exitFullscreen(); });
        
        const speeds = [1, 1.25, 1.5, 1.75, 2, 2.25, 2.5, 0.75]; let currentSpeedIndex = 0;
        speedBtn.addEventListener('click', () => {
            currentSpeedIndex = (currentSpeedIndex + 1) % speeds.length;
            videoPlayer.playbackRate = speeds[currentSpeedIndex];
            speedBtn.textContent = `${speeds[currentSpeedIndex]}x`;
        });
        
        document.addEventListener('keydown', (e) => { const view = document.querySelector('.view.active'); if (!view || view.id !== 'player-view' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return; e.preventDefault(); userInteracted = true; videoPlayer.muted = false; unmuteBtn.classList.add('hidden'); switch(e.code) { case 'Space': playPauseBtn.click(); break; case 'ArrowRight': videoPlayer.currentTime += 5; break; case 'ArrowLeft': videoPlayer.currentTime -= 5; break; case 'ArrowUp': videoPlayer.volume = Math.min(1, videoPlayer.volume + 0.1); break; case 'ArrowDown': videoPlayer.volume = Math.max(0, videoPlayer.volume - 0.1); break; case 'KeyF': fullscreenBtn.click(); break; case 'Escape': if (document.fullscreenElement) document.exitFullscreen(); break; } });
        
        mediaResizeHandle.addEventListener('mousedown', (e) => { e.preventDefault(); isResizing = true; document.body.style.cursor = 'ew-resize'; playerView.style.userSelect = 'none'; });
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return; e.preventDefault(); const totalWidth = playerView.offsetWidth;
            const menuWidth = lectureMenu.classList.contains('hidden') ? 0 : lectureMenu.offsetWidth;
            let newViewerWidth = totalWidth - e.clientX;
            newViewerWidth = Math.max(300, newViewerWidth);
            newViewerWidth = Math.min(totalWidth - 300 - menuWidth, newViewerWidth);
            playerView.style.setProperty('--viewer-width', `${newViewerWidth}px`);
            mediaViewer.style.width = `${newViewerWidth}px`;
        });
        document.addEventListener('mouseup', () => {
            if (isResizing) {
                localStorage.setItem('viewerWidth', mediaViewer.style.width);
                isResizing = false;
                document.body.style.cursor = '';
                playerView.style.userSelect = '';
            }
        });

        async function main() {
            if (!window.indexedDB || !window.showDirectoryPicker) { document.body.innerHTML = "<h1>Browser Not Supported</h1><p>Please use a modern browser like Google Chrome or Microsoft Edge that supports the File System Access API and IndexedDB.</p>"; return; }
            await openDB();
            await loadAllProgress();
            await loadCoursesFromDB();
            
            const savedStateJSON = sessionStorage.getItem('courseflixState');
            if (savedStateJSON) {
                const savedState = JSON.parse(savedStateJSON);
                if (savedState.view === 'player-view' && savedState.courseId && savedState.lectureId) {
                    if (savedState.sidebarCollapsed) {
                        lectureMenu.classList.add('hidden');
                        sidebarToggleBtn.classList.add('collapsed');
                    }
                    const courseExists = courses.some(c => c.id === savedState.courseId);
                    if (courseExists) {
                      await renderPlayer(savedState.courseId, savedState.lectureId, savedState.lastView, savedState.currentTime);
                      return;
                    }
                }
            }
            switchView('dashboard-view');
        }
        main();
    });
    </script>
</body>
</html>
