<!DOCTYPE html>
<html lang="en" data-theme="dark" data-accent="green">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CourseFlix</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* --- THEME & ACCENT COLOR VARIABLES --- */
        :root {
            --bg-primary: #f9fafb; --bg-secondary: #ffffff; --bg-tertiary: #f3f4f6;
            --text-primary: #1f2937; --text-secondary: #6b7280; --text-on-accent: #ffffff;
            --border-primary: #e5e7eb; --border-secondary: #d1d5db; --accent-danger: #ef4444;
            --status-review: #f59e0b; --status-practice: #3b82f6;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --dpp-doubt: #9333ea; --dpp-fail: #ef4444; --dpp-solved: #3b82f6; --dpp-star: #f59e0b;
        }
        html[data-theme="dark"] {
            --bg-primary: #000000; --bg-secondary: #121212; --bg-tertiary: #1E1E1E;
            --text-primary: #f5f5f5; --text-secondary: #a3a3a3;
            --border-primary: #27272a; --border-secondary: #3f3f46;
            --shadow: 0 1px 3px 0 rgb(255 255 255 / 0.1), 0 1px 2px -1px rgb(255 255 255 / 0.08);
        }
        html[data-accent="green"] {
            --accent-primary: #16a34a; --accent-hover: #15803d;
            --accent-primary_translucent: rgba(34, 197, 94, 0.4);
        }

        /* --- BASE STYLES --- */
        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent;
            background-color: var(--bg-primary); color: var(--text-primary);
            transition: background-color 0.2s, color 0.2s; margin: 0;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        button, a, input { font-family: inherit; -webkit-tap-highlight-color: transparent; }

        /* --- VIEWS & LAYOUT --- */
        .view { width: 100%; flex-grow: 1; display: none; flex-direction: column; overflow: hidden; }
        .view.active { display: flex; }
        
        /* --- NAVBAR --- */
        nav {
            display: flex; align-items: center; padding: 1rem 2.5rem;
            background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-primary); 
            flex-shrink: 0; z-index: 10; gap: 1rem;
        }
        nav.hidden { display: none; }
        nav h1 { margin: 0; font-size: 1.5rem; font-weight: 700; cursor: pointer; }
        .nav-links { margin-right: auto; display: flex; gap: 1rem; }
        .nav-link { 
            color: var(--text-secondary); text-decoration: none; font-weight: 600; font-size: 0.95rem;
            padding: 8px 12px; border-radius: 8px; transition: background-color 0.2s, color 0.2s;
        }
        .nav-link:hover { color: var(--text-primary); background-color: var(--bg-tertiary); }
        .nav-link.active { color: var(--accent-primary); }
        .primary-btn {
            background-color: var(--accent-primary); color: var(--text-on-accent); border: none;
            padding: 10px 18px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: background-color 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .primary-btn:hover { background-color: var(--accent-hover); }

        .info-display {
            background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-secondary);
            padding: 10px 18px; border-radius: 8px; font-size: 0.9rem; font-weight: 600;
            display: none; align-items: center; gap: 8px; white-space: nowrap;
        }

        /* --- GRIDS --- */
        .grid-container { overflow-y: auto; flex-grow: 1; padding: 24px; }
        #course-grid, #upload-course-grid, #filter-results-grid, #dpp-course-grid, #notes-course-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px;
        }
        #review-grid, #practice-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
        }

        /* --- COURSE CARD --- */
        .course-card {
            background-color: var(--bg-secondary); border-radius: 10px;
            box-shadow: var(--shadow); border: 1px solid var(--border-primary);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; 
            display: flex; flex-direction: column; height: 350px; overflow: hidden;
        }
        html[data-theme="dark"] .course-card:hover { border-color: var(--accent-primary); box-shadow: 0 0 15px -2px var(--accent-primary_translucent); transform: translateY(-2px); }
        html[data-theme="light"] .course-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .thumbnail-placeholder {
            width: 100%; height: 140px; background-color: var(--bg-tertiary); border-bottom: 1px solid var(--border-primary);
            display: flex; align-items: center; justify-content: center; position: relative;
            flex-shrink: 0; cursor: pointer; background-size: cover; background-position: center;
        }
        .thumbnail-placeholder i { font-size: 2.5rem; color: var(--text-secondary); opacity: 0.4; }
        .thumbnail-placeholder.has-thumbnail i { display: none; }
        .remove-course-btn, .remove-thumbnail-btn, .refresh-course-btn {
            position: absolute; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 28px; height: 28px;
            cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; z-index: 2;
        }
        .remove-course-btn { top: 8px; right: 8px; }
        .remove-thumbnail-btn { top: 8px; left: 8px; display: none; }
        .refresh-course-btn { top: 8px; left: 50%; transform: translateX(-50%); }
        .refresh-course-btn.loading i { animation: spin 1.5s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .remove-course-btn:hover, .remove-thumbnail-btn:hover { background: var(--accent-danger); }
        .refresh-course-btn:hover { background: var(--accent-primary); }
        .course-card:hover .remove-course-btn, .course-card:hover .refresh-course-btn { opacity: 1; }
        .course-card:hover .thumbnail-placeholder.has-thumbnail .remove-thumbnail-btn { opacity: 1; display: flex; }
        .course-info { padding: 12px 16px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .upload-card-actions { padding: 12px 16px; display: flex; flex-direction: column; gap: 10px; }
        .course-info h3 { margin: 0 0 4px 0; font-size: 1rem; line-height: 1.3; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: text; }
        .course-info-input { width: 100%; font-size: 1rem; font-weight: 600; padding: 2px 4px; border-radius: 4px; border: 1px solid var(--border-secondary); background: var(--bg-tertiary); }
        html[data-theme="dark"] .course-info-input { color: var(--text-primary); }
        .course-meta { font-size: 0.8rem; color: var(--text-secondary); margin: 0 0 8px 0; }
        .course-duration { font-size: 0.75rem; color: var(--accent-primary); margin-bottom: 8px; font-weight: 500; }
        .course-progress-container { margin-top: auto; }
        .course-progress-bar, .lecture-progress-bar, .menu-progress-bar { width: 100%; height: 6px; background-color: var(--bg-tertiary); border-radius: 3px; overflow: hidden; margin-bottom: 4px;}
        .course-progress-fill, .lecture-progress-fill, .menu-progress-fill { height: 100%; background-color: var(--accent-primary); transition: width 0.3s ease; }
        .course-progress-text, .menu-progress-text { font-size: 0.75rem; color: var(--text-secondary); }
        .enter-course-btn { padding: 8px 12px; width: 100%; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; text-decoration: none; display: block; text-align: center; background-color: var(--accent-primary); color: var(--text-on-accent); margin-top: 12px; }
        .enter-course-btn:hover { background-color: var(--accent-hover); }
        .course-extra-info { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-secondary); margin: 8px 0; gap: 8px; }
        .course-faculty { font-weight: 500; cursor: text; padding: 2px 4px; border-radius: 4px; transition: background-color 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .course-faculty:hover { background-color: var(--bg-tertiary); }
        .course-rating { display: flex; flex-shrink: 0; }
        .course-rating i { cursor: pointer; color: var(--border-secondary); transition: transform 0.1s, color 0.1s; padding: 0 1px; }
        .course-rating i.fas { color: #f59e0b; }
        .course-rating:hover i { color: #f59e0b !important; }
        .course-rating i:hover ~ i { color: var(--border-secondary) !important; }
        .course-faculty-input { width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-secondary); border-radius: 4px; padding: 2px 4px; color: var(--text-primary); font-weight: 500; font-size: 0.8rem; box-sizing: border-box; }

        /* --- LECTURE REVIEW CARD --- */
        .lecture-review-card {
            background-color: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border-primary); padding: 16px;
            display: flex; flex-direction: column; justify-content: space-between; position: relative; cursor: pointer; overflow: hidden; min-height: 220px;
            background-image: url('lect.webp'); background-size: cover; background-position: center;
        }
        .lecture-review-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); border-radius: 10px; z-index: 1; }
        .lecture-review-info, .card-action-center, .remove-status-btn { position: relative; z-index: 2; }
        .lecture-review-info h3 { margin: 0 0 4px 0; font-size: 1.1rem; font-weight: 600; color: #ffffff; }
        .lecture-review-info .course-title { font-size: 0.8rem; font-weight: 500; color: #e5e5e5; margin-bottom: 12px; }
        .lecture-review-meta { display: flex; justify-content: space-between; font-size: 0.75rem; color: #e5e5e5; margin-top: 6px; }
        .card-action-center { display: flex; justify-content: center; padding-top: 1rem; }
        .remove-status-btn {
            position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%;
            width: 28px; height: 28px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s, background-color 0.2s;
        }
        .lecture-review-card:hover .remove-status-btn { opacity: 1; }
        .remove-status-btn:hover { background: var(--accent-danger); }

        /* --- VIEW HEADER --- */
        .view-header { padding: 12px 24px; border-bottom: 1px solid var(--border-primary); display: flex; align-items: center; gap: 1rem; position: relative; }
        
        /* --- MODALS --- */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .modal-overlay.hidden { display: none !important; }
        .modal-content { background-color: var(--bg-secondary); border-radius: 1rem; padding: 2rem; width: 100%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 1rem; position: relative; max-height: 90vh; }
        .modal-content-scrollable { overflow-y: auto; padding-right: 1rem; margin-right: -1rem; }
        .close-modal-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s; }
        .close-modal-btn:hover { background-color: var(--bg-tertiary); }
        .modal-content h2 { margin: 0; }
        .modal-content .secondary-btn {
            background-color: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s;
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-secondary); display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .modal-content .secondary-btn:hover { background-color: var(--border-primary); }

        /* --- IMPORT MODAL --- */
        .import-course-link-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-primary); background-color: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px; }
        .import-course-link-item:last-child { border-bottom: none; }
        .import-course-title { font-weight: 600; color: var(--text-primary); }
        .import-course-link-item button { padding: 6px 12px; font-size: 0.9rem; }
        .import-course-link-item span.status { color: var(--accent-primary); font-weight: 600; font-size: 0.9rem; }
        #import-final-btn { margin-top: 1.5rem; width: 100%; }
        #import-final-btn:disabled { background-color: var(--border-secondary); cursor: not-allowed; opacity: 0.7; }
        #import-status-message { text-align: center; margin-top: 1rem; color: var(--text-secondary); min-height: 20px; font-weight: 500; }
        
        /* --- UPLOAD VIEW --- */
        #upload-detail-view { width: 100%; height: 100%; display: flex; flex-grow: 1; }
        #upload-lecture-list-container { width: 400px; border-right: 1px solid var(--border-primary); flex-shrink: 0; display: flex; flex-direction: column; }
        #upload-lecture-list-header { padding: 1rem; border-bottom: 1px solid var(--border-primary); }
        #upload-lecture-list-header h3 { margin: 0; }
        #upload-lecture-list-header .back-link { margin-bottom: 0.5rem; }
        #upload-lecture-list { flex-grow: 1; overflow-y: auto; padding: 0.5rem; }
        #upload-lecture-list .lecture-item { padding: 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; gap: 8px; }
        #upload-lecture-list .lecture-item:hover { background-color: var(--bg-tertiary); }
        #upload-lecture-list .lecture-item.selected { background-color: var(--accent-primary); color: var(--text-on-accent); }
        #upload-lecture-list .lecture-item .file-status { display: flex; gap: 6px; margin-left: auto; }
        #upload-lecture-list .lecture-item .file-status i { color: var(--accent-primary); }
        #upload-drop-zones { flex-grow: 1; display: flex; gap: 2rem; padding: 2rem; }
        .drop-zone { flex: 1; border: 3px dashed var(--border-secondary); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: border-color 0.2s, background-color 0.2s; text-align: center; color: var(--text-secondary); }
        .drop-zone.dragover { border-color: var(--accent-primary); background-color: var(--bg-tertiary); }
        .drop-zone i { font-size: 3rem; margin-bottom: 1rem; }
        .drop-zone h4 { margin: 0 0 0.5rem 0; color: var(--text-primary); }
        .drop-zone p { margin: 0; font-size: 0.9rem; }

        /* --- PLAYER VIEW --- */
        #player-view { flex-direction: row; --viewer-width: 0px; }
        .player-content-wrapper { flex-grow: 1; display: flex; position: relative; width: calc(100% - 380px); transition: width 0.3s ease-in-out; }
        #player-view.viewer-active .player-content-wrapper { width: calc(100% - 380px - var(--viewer-width)); }
        #lecture-menu { width:380px; background-color:var(--bg-secondary); border-right:1px solid var(--border-primary); flex-shrink:0; display:flex; flex-direction:column; transition:margin-left 0.3s ease; }
        #lecture-menu.hidden { margin-left:-380px; }
        .menu-header { padding:20px; border-bottom:1px solid var(--border-primary); background-color: var(--bg-primary); flex-shrink: 0; }
        .menu-header-top { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 15px; }
        .back-link { color:var(--accent-primary);text-decoration:none;display:block;font-weight:500; cursor: pointer; flex-shrink: 0; }
        .back-link:hover { text-decoration: underline; }
        .clear-bookmarks-btn { background: none; border: 1px solid var(--accent-danger); color: var(--accent-danger); padding: 4px 8px; font-size: 0.75rem; border-radius: 6px; cursor: pointer; font-weight: 600; }
        #chapter-list { overflow-y:auto; flex-grow:1; padding:10px; }
        .chapter-title { font-weight:bold; cursor:pointer; padding:12px; border-radius:8px; display:flex; align-items:center; gap:8px; transition: background-color 0.2s; position: relative;}
        .chapter-title:hover { background-color: var(--bg-tertiary); }
        .chapter-title-text { flex-grow: 1; cursor: text; }
        .chapter-duration { font-size: 0.8rem; color: var(--text-secondary); margin-left: 10px; }
        .chapter-drag-handle { cursor: grab; color: var(--text-secondary); padding: 0 10px 0 2px; margin-left: -12px; opacity: 0.4; transition: opacity 0.2s; }
        .chapter-title:hover .chapter-drag-handle { opacity: 1; }
        .chapter.dragging { opacity: 0.5; background: var(--bg-tertiary); }
        .chapter-drop-indicator { height: 2px; background-color: var(--accent-primary); margin: -1px 0; }
        .chapter-title i { transition: transform 0.2s; }
        .chapter.open > .chapter-title i:not(.chapter-drag-handle) { transform: rotate(90deg); }
        .lecture-list { list-style:none; padding-left: 20px; margin: 0; display: none; }
        .chapter.open > .lecture-list { display: block; }
        .lecture-list li { padding:10px 12px; cursor:pointer; border-radius:8px; margin-top:5px; display:flex; align-items:center; gap:10px; justify-content: space-between; }
        .lecture-list li:hover { background-color:var(--bg-tertiary); }
        .lecture-list li.active { background-color:var(--accent-primary);color:var(--text-on-accent); }
        .lecture-checkbox { width: 18px; height: 18px; border: 2px solid var(--border-secondary); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
        .lecture-checkbox.completed { background-color: var(--accent-primary); border-color: var(--accent-primary); }
        .lecture-checkbox i { color: white; font-size: 12px; opacity: 0; }
        .lecture-checkbox.completed i { opacity: 1; }
        .lecture-title { flex-grow: 1; transition: opacity 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: text;}
        .lecture-title.completed { text-decoration: line-through; opacity: 0.6; }
        .lecture-title-input { width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-secondary); border-radius: 4px; padding: 2px 4px; color: var(--text-primary); font-weight: normal; font-size: 1em; }
        .lecture-duration { font-size: 0.7rem; color: var(--text-secondary); margin-left: auto; flex-shrink: 0; }
        .status-btn { border: none; border-radius: 6px; font-size: 0.65rem; font-weight: 700; padding: 4px 8px; margin-left: 10px; cursor: pointer; flex-shrink: 0; background-color: var(--bg-tertiary); color: var(--text-secondary); }
        .status-btn.review { background-color: var(--status-review); color: white; }
        .status-btn.practice { background-color: var(--status-practice); color: white; }

        /* --- PDF/ASSIGNMENT VIEWER --- */
        #media-viewer { display: flex; flex-direction: column; width: var(--viewer-width); height: 100%; background-color: var(--bg-secondary); border-left: 1px solid var(--border-primary); position: relative; z-index: 50; overflow: hidden; transition: width 0.3s ease-in-out; }
        #media-viewer.hidden { width: 0; border-left: none; }
        #media-viewer-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--border-primary); background-color: var(--bg-secondary); flex-shrink: 0; gap: 1rem; }
        #viewer-title { margin: 0; font-size: 1.1rem; font-weight: 600; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; flex-grow: 1; }
        .viewer-actions { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
        #close-viewer-btn { background-color: var(--accent-primary); color: white; border: none; border-radius: 6px; width: 28px; height: 28px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        #close-viewer-btn:hover { background-color: var(--accent-hover); }
        #delete-viewer-file { background-color: var(--accent-danger); color: white; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 500; padding: 6px 12px; cursor: pointer; display: none; align-items: center; gap: 6px; }
        #delete-viewer-file.visible { display: inline-flex; }
        #media-viewer-frame { flex-grow: 1; width: 100%; border: none; }
        #media-resize-handle { position: absolute; top: 0; left: 0; height: 100%; width: 8px; cursor: ew-resize; z-index: 60; background-color: transparent; transition: background-color 0.2s; }
        #media-resize-handle:hover { background-color: var(--accent-primary_translucent); }
        #video-wrapper-container { flex-grow: 1; display: flex; flex-direction: column; position: relative; width: 100%; transition: width 0.3s ease-in-out; }
        
        /* --- FILE SWITCHER --- */
        #file-switcher-container { position: relative; }
        #file-switcher-btn { background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500; }
        #file-switcher-dropdown { position: absolute; top: 110%; right: 0; background-color: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 6px; box-shadow: var(--shadow); z-index: 70; min-width: 120px; overflow: hidden; }
        #file-switcher-dropdown button { display: block; width: 100%; text-align: left; padding: 8px 12px; background: none; border: none; color: var(--text-primary); cursor: pointer; }
        #file-switcher-dropdown button:hover { background-color: var(--bg-tertiary); }

        /* --- VIDEO PLAYER --- */
        #video-wrapper { flex-grow:1;background-color:black;display:flex;justify-content:center;align-items:center;position:relative;overflow:hidden;}
        #video-player { width:100%;height:100%;outline:none;}
        #unmute-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; border: 2px solid white; border-radius: 8px; padding: 12px 20px; font-size: 1.1rem; font-weight: 600; cursor: pointer; z-index: 25; }
        .seek-overlay{position:absolute;top:0;width:50%;height:100%;z-index:10;pointer-events:none;}
        #left-seek-overlay{left:0;} #right-seek-overlay{right:0;}
        .seek-overlay i{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:48px;color:white;opacity:0;pointer-events:none;}
        .seek-overlay.show-icon i{opacity:0.8;animation:fade-out 0.5s forwards;}
        @keyframes fade-out { from { opacity: 0.8; } to { opacity: 0; } }
        .video-controls-container { position:absolute;bottom:0;left:0;width:100%;padding:0 15px;z-index:20;opacity:0;transition:opacity 0.2s ease-in-out;background:linear-gradient(to top, rgba(0,0,0,0.7), transparent);}
        #video-wrapper:hover .video-controls-container { opacity:1; }
        .timeline-container { padding: 10px 0; position: relative; }
        .timeline { -webkit-appearance:none; appearance:none; background:rgba(255,255,255,0.3); cursor:pointer; height:8px; width:100%; border-radius:5px; transition: height 0.2s ease; margin: 0; padding: 0;}
        .timeline:hover { height: 12px; }
        .timeline::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; height:18px; width:18px; border-radius:50%; background-color:var(--accent-primary); border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); transition: transform 0.2s ease, box-shadow 0.2s ease; opacity: 0; }
        .timeline-container:hover .timeline::-webkit-slider-thumb { opacity: 1; transform: scale(1.1); }
        .controls { display:flex;justify-content:space-between;align-items:center;padding-bottom:10px;color:white;}
        .left-controls, .right-controls { display:flex;align-items:center;gap:15px; }
        .control-btn { background:none;border:none;color:white;font-size:18px;cursor:pointer;padding:5px; }
        
        #sidebar-toggle-btn { position: fixed; top: 50%; transform: translateY(-50%); z-index: 1001; background:var(--accent-primary); color:white; border:none; width:25px; height:70px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition: all 0.3s ease; left:380px; border-radius:0 8px 8px 0; }
        #sidebar-toggle-btn.collapsed { left:0; }
        #sidebar-toggle-btn i { transition:transform 0.3s; }
        #sidebar-toggle-btn.collapsed i { transform:rotate(180deg); }
        #media-viewer-toggle-btn { position: absolute; top: 50%; transform: translateY(-50%); z-index: 55; background: var(--accent-primary); color: white; border: none; width: 25px; height: 70px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.3s ease, right 0.3s ease; right: 0; border-radius: 8px 0 0 8px; }
        
        /* --- BOOKMARKS --- */
        #bookmarks-container { position: absolute; top: 0; left: 0; right: 0; height: 100%; pointer-events: none; }
        .bookmark-dot {
            position: absolute; top: 50%; transform: translate(-50%, -50%);
            width: 12px; height: 12px; background-color: #f59e0b;
            border: 2px solid white; border-radius: 50%; cursor: pointer;
            pointer-events: all; z-index: 10; transition: transform 0.2s;
        }
        .bookmark-dot:hover { transform: translate(-50%, -50%) scale(1.4); }

        #no-content-message { text-align: center; color: var(--text-secondary); padding: 50px; }
        .hidden { display: none !important; }
        .file-controls { display: flex; gap: 5px; align-items: center; }
        .file-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; width: 24px; height: 24px; font-size: 1rem; display: flex; align-items: center; justify-content: center; position: relative; }
        .file-btn:hover { color: var(--accent-primary); }
        #add-pdf-input, #add-assignment-input { display: none; }
        
        /* --- DPP & NOTES VIEW --- */
        #dpp-view, #notes-view { flex-direction: column; }
        #dpp-detail-container, #notes-detail-container { flex-grow: 1; display: flex; flex-direction: row; }
        #dpp-sidebar, #notes-sidebar { width: 380px; background-color: var(--bg-secondary); border-right: 1px solid var(--border-primary); flex-shrink: 0; display: flex; flex-direction: column; transition: margin-left 0.3s ease; }
        #dpp-sidebar.hidden, #notes-sidebar.hidden { margin-left: -380px; }
        #dpp-sidebar-header, #notes-sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-primary); }
        #dpp-list-container, #notes-list-container { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .dpp-course-group h3, .notes-course-group h3 { padding: 12px; margin: 0; font-size: 1.1rem; }
        .dpp-folder-group, .notes-folder-group { padding-left: 15px; }
        .dpp-folder-title, .notes-folder-title { font-weight: bold; padding: 8px 12px; color: var(--text-secondary); font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px;}
        .dpp-folder-title i, .notes-folder-title i { transition: transform 0.2s ease-in-out; }
        .dpp-folder-group.open .dpp-folder-title i, .notes-folder-group.open .notes-folder-title i { transform: rotate(90deg); }
        .dpp-list, .notes-list { padding-left: 10px; display: none; }
        .dpp-folder-group.open .dpp-list, .notes-folder-group.open .notes-list { display: block; }

        .dpp-item, .notes-item { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .dpp-item:hover, .notes-item:hover { background-color: var(--bg-tertiary); }
        .dpp-item.active, .notes-item.active { background-color: var(--accent-primary); color: var(--text-on-accent); }
        .dpp-item-title, .notes-item-title { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dpp-item-title.completed { text-decoration: line-through; opacity: 0.6; }
        .dpp-item-controls { display: flex; align-items: center; gap: 4px; }
        .dpp-item-btn { width: 24px; height: 24px; font-size: 0.9rem; color: var(--text-secondary); }
        .dpp-item-btn.completed { color: var(--accent-primary); }
        .dpp-item-btn.starred { color: var(--dpp-star); }
        .dpp-item-btn.delete-dpp-btn:hover { color: var(--accent-danger); }
        .dpp-status-btn { font-size: 0.8rem; font-weight: 600; padding: 2px 6px; border-radius: 4px; min-width: 50px; text-align: center; }
        .dpp-status-btn.doubt { background-color: var(--dpp-doubt); color: white; }
        .dpp-status-btn.fail { background-color: var(--dpp-fail); color: white; }
        .dpp-status-btn.solved { background-color: var(--dpp-solved); color: white; }
        #dpp-content-area, #notes-content-area { flex-grow: 1; position: relative; }
        #dpp-viewer-frame, #notes-viewer-frame { width: 100%; height: 100%; border: none; }
        #dpp-sidebar-toggle-btn, #notes-sidebar-toggle-btn { position: fixed; top: 50%; transform: translateY(-50%); z-index: 1001; background: var(--accent-primary); color: white; border: none; width: 25px; height: 70px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; left: 380px; border-radius: 0 8px 8px 0; }
        #dpp-sidebar-toggle-btn.collapsed, #notes-sidebar-toggle-btn.collapsed { left: 0; }
        #dpp-sidebar-toggle-btn i, #notes-sidebar-toggle-btn i { transition: transform 0.3s; }
        #dpp-sidebar-toggle-btn.collapsed i, #notes-sidebar-toggle-btn.collapsed i { transform: rotate(180deg); }

        /* --- DPP UPLOAD VIEW --- */
        #dpp-upload-view { flex-direction: row; }
        #dpp-upload-sidebar { width: 380px; background-color: var(--bg-secondary); border-right: 1px solid var(--border-primary); flex-shrink: 0; display: flex; flex-direction: column; transition: margin-left 0.3s ease;}
        #dpp-upload-sidebar.hidden { margin-left: -380px; }
        #dpp-upload-header { padding: 1rem; border-bottom: 1px solid var(--border-primary); }
        #dpp-upload-header h3 { margin: 0 0 0.5rem 0; }
        #dpp-folder-list { flex-grow: 1; overflow-y: auto; padding: 0.5rem; }
        .dpp-folder-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .dpp-folder-item:hover { background-color: var(--bg-tertiary); }
        .dpp-folder-item.selected { background-color: var(--accent-primary); color: var(--text-on-accent); }
        .delete-dpp-folder-btn { color: var(--text-secondary); }
        .delete-dpp-folder-btn:hover { color: var(--accent-danger); }
        #dpp-upload-drop-zone { flex-grow: 1; margin: 2rem; }
        #dpp-upload-sidebar-toggle-btn { position: fixed; top: 50%; transform: translateY(-50%); z-index: 1001; background: var(--accent-primary); color: white; border: none; width: 25px; height: 70px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; left: 380px; border-radius: 0 8px 8px 0; }
        #dpp-upload-sidebar-toggle-btn.collapsed { left: 0; }
        #dpp-upload-sidebar-toggle-btn i { transition: transform 0.3s; }
        #dpp-upload-sidebar-toggle-btn.collapsed i { transform: rotate(180deg); }

    </style>
</head>
<body>

    <nav>
        <h1 id="home-btn">CourseFlix</h1>
        <div class="nav-links">
            <a href="#" class="nav-link" data-view="dashboard-view">Dashboard</a>
            <a href="#" class="nav-link" data-view="upload-view">Upload</a>
            <a href="#" class="nav-link" data-view="review-view">Review</a>
            <a href="#" class="nav-link" data-view="practice-view">Practice</a>
            <a href="#" class="nav-link" data-view="dpp-view">DPP</a>
            <a href="#" class="nav-link" data-view="notes-view">Notes</a>
        </div>
        <div id="total-time-left-display" class="info-display"></div>
        <button id="add-course-btn" class="primary-btn"><i class="fas fa-plus"></i> Add Course</button>
    </nav>

    <div id="dashboard-view" class="view active">
        <main id="course-grid" class="grid-container"></main>
    </div>
    
    <div id="upload-view" class="view">
        <main id="upload-course-grid" class="grid-container"></main>
        <div id="upload-detail-view" class="hidden">
            <div id="upload-lecture-list-container">
                <div id="upload-lecture-list-header">
                        <a class="back-link" id="back-to-upload-grid">&larr; Back to Courses</a>
                        <h3 id="upload-course-title"></h3>
                </div>
                <div id="upload-lecture-list"></div>
            </div>
            <div id="upload-drop-zones">
                <div class="drop-zone" id="pdf-drop-zone" data-type="pdf">
                    <i class="fas fa-file-pdf"></i>
                    <h4>Lecture Notes (PDF)</h4>
                    <p>Drag & Drop a PDF Here</p>
                </div>
                <div class="drop-zone" id="assignment-drop-zone" data-type="assignment">
                    <i class="fas fa-file-alt"></i>
                    <h4>Assignment</h4>
                    <p>Drag & Drop File Here</p>
                </div>
            </div>
        </div>
    </div>

    <div id="filter-results-view" class="view">
        <!-- This will be populated dynamically -->
    </div>

    <div id="dpp-upload-view" class="view">
        <div id="dpp-upload-sidebar">
            <div id="dpp-upload-header">
                <a class="back-link" id="back-to-upload-from-dpp">&larr; Back to Upload</a>
                <h3 id="dpp-upload-course-title"></h3>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="new-dpp-folder-name" placeholder="New folder name..." style="width: 100%;" class="course-info-input">
                    <button id="add-dpp-folder-btn" class="primary-btn"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div id="dpp-folder-list"></div>
        </div>
        <div id="dpp-upload-drop-zone" class="drop-zone">
            <i class="fas fa-file-upload"></i>
            <h4>Upload DPPs</h4>
            <p>Drag & Drop Files Here</p>
        </div>
        <button id="dpp-upload-sidebar-toggle-btn"><i class="fas fa-chevron-left"></i></button>
    </div>

    <div id="review-view" class="view">
        <div class="view-header">
            <button class="primary-btn" id="filter-btn-review"><i class="fas fa-filter"></i> Filter by Course</button>
        </div>
        <main id="review-grid" class="grid-container"></main>
    </div>

    <div id="practice-view" class="view">
        <div class="view-header">
            <button class="primary-btn" id="filter-btn-practice"><i class="fas fa-filter"></i> Filter by Course</button>
        </div>
        <main id="practice-grid" class="grid-container"></main>
    </div>
    
    <div id="dpp-view" class="view">
        <main id="dpp-course-grid" class="grid-container"></main>
        <div id="dpp-detail-container" class="hidden">
            <div id="dpp-sidebar">
                <div id="dpp-sidebar-header">
                    <a class="back-link" id="back-to-dpp-grid" style="margin-bottom: 1rem;">&larr; Back to Courses</a>
                    <h2 id="dpp-detail-course-title">DPP Library</h2>
                </div>
                <div id="dpp-list-container"></div>
            </div>
            <div id="dpp-content-area">
                <iframe id="dpp-viewer-frame"></iframe>
                <p id="dpp-no-content-message" style="text-align: center; color: var(--text-secondary); padding: 50px;">Select a DPP from the sidebar to view it.</p>
            </div>
            <button id="dpp-sidebar-toggle-btn"><i class="fas fa-chevron-left"></i></button>
        </div>
    </div>

    <div id="notes-view" class="view">
        <main id="notes-course-grid" class="grid-container"></main>
        <div id="notes-detail-container" class="hidden">
            <div id="notes-sidebar">
                <div id="notes-sidebar-header">
                    <a class="back-link" id="back-to-notes-grid" style="margin-bottom: 1rem;">&larr; Back to Courses</a>
                    <h2 id="notes-detail-course-title">Class Notes</h2>
                </div>
                <div id="notes-list-container"></div>
            </div>
            <div id="notes-content-area">
                <iframe id="notes-viewer-frame"></iframe>
                <p id="notes-no-content-message" style="text-align: center; color: var(--text-secondary); padding: 50px;">Select a note from the sidebar to view it.</p>
            </div>
            <button id="notes-sidebar-toggle-btn"><i class="fas fa-chevron-left"></i></button>
        </div>
    </div>

    <div id="player-view" class="view">
        <div id="lecture-menu">
            <div class="menu-header">
                <div class="menu-header-top">
                    <a class="back-link">&larr; Back to Courses</a>
                    <button class="clear-bookmarks-btn hidden">Clear Bookmarks</button>
                </div>
                <h2 id="course-title-menu"></h2>
                <div class="course-stats"></div>
                <div class="menu-progress-container">
                    <div class="menu-progress-bar">
                        <div class="menu-progress-fill"></div>
                    </div>
                    <div class="menu-progress-text"></div>
                </div>
            </div>
            <div id="chapter-list"></div>
        </div>
        <div class="player-content-wrapper">
            <div id="video-wrapper-container">
                <div id="video-wrapper">
                    <video id="video-player"></video>
                    <button id="unmute-btn" class="hidden"><i class="fas fa-volume-mute"></i> Click to Unmute</button>
                    <div class="seek-overlay" id="left-seek-overlay"><i class="fas fa-backward"></i></div>
                    <div class="seek-overlay" id="right-seek-overlay"><i class="fas fa-forward"></i></div>
                    <div class="video-controls-container">
                        <div class="timeline-container">
                            <input type="range" class="timeline" value="0" step="0.1">
                            <div id="bookmarks-container"></div>
                        </div>
                        <div class="controls">
                            <div class="left-controls">
                                <button class="control-btn" id="play-pause-btn"><i class="fas fa-play"></i></button>
                                <div class="time-display"><span id="current-time">0:00</span> / <span id="video-duration">0:00</span></div>
                            </div>
                            <div class="right-controls">
                                <button class="control-btn" id="speed-btn">1x</button>
                                <button class="control-btn" id="fullscreen-btn"><i class="fas fa-expand"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="media-viewer" class="hidden">
                <div id="media-resize-handle"></div>
                <div id="media-viewer-header">
                    <h3 id="viewer-title"></h3>
                    <div class="viewer-actions">
                        <div id="file-switcher-container"></div>
                        <button id="delete-viewer-file" title="Delete File"><i class="fas fa-trash"></i> Delete</button>
                        <button id="close-viewer-btn" title="Close Viewer"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <iframe id="media-viewer-frame"></iframe>
            </div>
            <button id="media-viewer-toggle-btn" class="hidden"><i class="fas fa-chevron-left"></i></button>
        </div>
        <button id="sidebar-toggle-btn"><i class="fas fa-chevron-left"></i></button>
    </div>

    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="close-modal-btn" title="Close">&times;</button>
            <h2>Manage Courses</h2>
            <button id="add-folder-btn" class="secondary-btn"><i class="fas fa-folder-plus"></i> Add Course Folder</button>
            <hr style="width:100%; border:none; border-top: 1px solid var(--border-primary);">
            <button id="import-btn" class="secondary-btn"><i class="fas fa-file-import"></i> Import Backup</button>
            <button id="export-btn" class="secondary-btn"><i class="fas fa-file-export"></i> Export Backup</button>
        </div>
    </div>
    
    <div id="import-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content" id="import-modal-content">
            </div>
    </div>
    
    <input type="file" id="thumbnail-uploader" class="hidden" accept="image/*">
    <input type="file" id="add-pdf-input" class="hidden" accept=".pdf">
    <input type="file" id="add-assignment-input" class="hidden" accept=".pdf,.doc,.docx,.txt,.zip">
    <input type="file" id="import-zip-input" class="hidden" accept=".zip">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const DB_NAME = 'CourseFlixDB';
        const DB_VERSION = 9; // Incremented version for new object store
        const STORE_NAME = 'courses';
        const PROGRESS_STORE = 'progress';
        const DPP_STORE = 'dpps'; // New store for DPPs
        let db;

        // --- Database Helper ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("Error opening IndexedDB");
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (event) => { 
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(PROGRESS_STORE)) db.createObjectStore(PROGRESS_STORE, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(DPP_STORE)) db.createObjectStore(DPP_STORE, { keyPath: 'id', autoIncrement: true });
                };
            });
        }
        function getStore(storeName, mode) { return db.transaction(storeName, mode).objectStore(storeName); }

        // --- DOM Elements ---
        const nav = document.querySelector('nav');
        const navLinks = document.querySelectorAll('.nav-link');
        const homeBtn = document.getElementById('home-btn');
        const views = document.querySelectorAll('.view');
        const courseGrid = document.getElementById('course-grid');
        const reviewGrid = document.getElementById('review-grid');
        const practiceGrid = document.getElementById('practice-grid');
        const playerView = document.getElementById('player-view');
        const videoWrapper = document.getElementById('video-wrapper');
        const videoPlayer = document.getElementById('video-player');
        const unmuteBtn = document.getElementById('unmute-btn');
        const chapterListDiv = document.getElementById('chapter-list');
        const courseTitleMenu = document.getElementById('course-title-menu');
        const backToLibraryBtn = document.querySelector('#player-view .back-link');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const timeline = document.querySelector('.timeline');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const leftSeekOverlay = document.getElementById('left-seek-overlay');
        const rightSeekOverlay = document.getElementById('right-seek-overlay');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const mediaViewerToggleBtn = document.getElementById('media-viewer-toggle-btn');
        const lectureMenu = document.getElementById('lecture-menu');
        const speedBtn = document.getElementById('speed-btn');
        const mediaViewer = document.getElementById('media-viewer');
        const mediaViewerFrame = document.getElementById('media-viewer-frame');
        const viewerTitle = document.getElementById('viewer-title');
        const addPdfInput = document.getElementById('add-pdf-input');
        const addAssignmentInput = document.getElementById('add-assignment-input');
        const mediaResizeHandle = document.getElementById('media-resize-handle');
        const deleteViewerFileBtn = document.getElementById('delete-viewer-file');
        const totalTimeDisplay = document.getElementById('total-time-left-display');
        const closeViewerBtn = document.getElementById('close-viewer-btn');
        const importZipInput = document.getElementById('import-zip-input');
        const bookmarksContainer = document.getElementById('bookmarks-container');
        const clearBookmarksBtn = document.querySelector('.clear-bookmarks-btn');

        let courses = [];
        let currentCourse = null;
        let currentLectureLi = null;
        let courseProgress = {};
        let clickTimer = null;
        let lastView = 'dashboard-view';
        let activeFileUrl = null;
        let activeViewerFileType = null;
        let isResizing = false;
        let userInteracted = false;

        // --- Utility Functions ---
        function formatTime(timeInSeconds, withHours = true) {
            const time = Math.round(timeInSeconds || 0);
            const hours = Math.floor(time / 3600);
            const minutes = Math.floor((time % 3600) / 60);
            const seconds = Math.floor(time % 60);
            if (hours > 0 && withHours) return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        function formatDuration(seconds) {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }
        function formatTotalDuration(seconds) {
            if (isNaN(seconds) || seconds <= 0) return '0 hours 0 min left';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours} hours ${minutes} min left`;
        }
        const naturalSort = (a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' });
        async function getVideoDuration(file) { return new Promise(r => {const v=document.createElement('video');v.preload='metadata';v.onloadedmetadata=()=>{r(v.duration);URL.revokeObjectURL(v.src)};v.onerror=()=>r(0);v.src=URL.createObjectURL(file)}); }
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.backgroundColor = isError ? 'var(--accent-danger)' : 'var(--accent-primary)';
            toast.style.color = 'white';
            toast.style.padding = '12px 20px';
            toast.style.borderRadius = '8px';
            toast.style.zIndex = '2000';
            toast.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
            document.body.appendChild(toast);
            setTimeout(() => { 
                toast.style.transition = 'opacity 0.3s';
                toast.style.opacity = '0'; 
                setTimeout(() => toast.remove(), 300); 
            }, 3000);
        }

        // --- Progress Management ---
        async function loadAllProgress() {
            const allProgress = await new Promise(resolve => getStore(PROGRESS_STORE, 'readonly').getAll().onsuccess = e => resolve(e.target.result));
            courseProgress = {};
            allProgress.forEach(item => { courseProgress[item.id] = item; });
        }
        async function saveLectureProgress(data) {
            const progressId = `${data.courseId}_${data.lectureId}`;
            const existing = courseProgress[progressId] || { courseId: data.courseId, lectureId: data.lectureId };
            const progressData = { ...existing, ...data, id: progressId };
            await new Promise(resolve => getStore(PROGRESS_STORE, 'readwrite').put(progressData).onsuccess = resolve);
            courseProgress[progressId] = progressData;
        }
        function getLectureProgress(courseId, lectureId) {
            return courseProgress[`${courseId}_${lectureId}`] || {};
        }

        function calculateCourseProgress(course) {
            if (!course.lectures) return { completed: 0, total: course.videoCount || 0, percentage: 0, remainingDuration: course.totalDuration || 0 };
            let completed = 0;
            let timeCompleted = 0;
            course.lectures.forEach(lecture => {
                const progress = getLectureProgress(course.id, lecture.id);
                if (progress.completed) {
                    completed++;
                    timeCompleted += lecture.duration;
                }
            });
            const total = course.lectures.length;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            const remainingDuration = (course.totalDuration || 0) - timeCompleted;
            return { completed, total, percentage, remainingDuration: Math.max(0, remainingDuration) };
        }
        
        function updateTotalTimeLeftDisplay() {
            let totalSecondsLeft = 0;
            courses.forEach(course => {
                const progress = calculateCourseProgress(course);
                totalSecondsLeft += progress.remainingDuration;
            });
            
            if (totalSecondsLeft > 0) {
                totalTimeDisplay.textContent = formatTotalDuration(totalSecondsLeft);
                totalTimeDisplay.style.display = 'inline-flex';
            } else {
                totalTimeDisplay.textContent = formatTotalDuration(0);
                 totalTimeDisplay.style.display = 'none';
            }
        }

        // --- View Switching & Rendering ---
        function switchView(viewId) {
            nav.classList.toggle('hidden', ['player-view', 'dpp-upload-view', 'filter-results-view'].includes(viewId));
            
            views.forEach(view => view.classList.toggle('active', view.id === viewId));
            navLinks.forEach(link => link.classList.toggle('active', link.dataset.view === viewId));
            
            if (viewId === 'review-view' || viewId === 'practice-view') {
                renderStatusGrid(viewId.split('-')[0]);
            }
            if (viewId === 'dashboard-view') renderCourseGrid();
            if (viewId === 'upload-view') {
                 document.getElementById('upload-course-grid').classList.remove('hidden');
                 document.getElementById('upload-detail-view').classList.add('hidden');
                 renderUploadView();
            }
            if (viewId === 'dpp-view') renderDppCourseSelectionView();
            if (viewId === 'notes-view') renderNotesCourseSelectionView();
            
            if (viewId !== 'player-view') {
                sessionStorage.removeItem('courseflixState');
            }
        }
        
        async function loadCoursesFromDB() {
            const storedCourses = await new Promise(resolve => getStore(STORE_NAME, 'readonly').getAll().onsuccess = e => resolve(e.target.result));
            for (const course of storedCourses) {
                const handle = course.handle;
                if (handle && typeof handle.queryPermission === 'function') {
                    try {
                        course.isLinked = await handle.queryPermission({ mode: 'read' }) === 'granted';
                    } catch (e) {
                        console.warn(`Could not query permission for course "${course.title}". It might need to be relinked.`, e);
                        course.isLinked = false;
                    }
                } else {
                    course.isLinked = false;
                }
            }
            courses = storedCourses;
            await renderCourseGrid();
        }
        
        async function scanDirectoryHandle(dirHandle) {
            const chapters = {};
            const lectures = [];
            let totalDuration = 0;
            const videoRegex = /\.(mp4|mkv|webm|mov|avi)$/i;
            
            async function recurse(currentHandle, path) {
                const chapterName = path || "Main Content";
                if (!chapters[chapterName]) {
                    chapters[chapterName] = { name: chapterName, lectures: [] };
                }

                const entries = [];
                for await (const entry of currentHandle.values()) {
                    entries.push(entry);
                }
                entries.sort((a, b) => naturalSort(a,b));

                for (const entry of entries) {
                    if (entry.kind === 'file' && videoRegex.test(entry.name)) {
                        try {
                            const file = await entry.getFile();
                            const duration = await getVideoDuration(file);
                            const lectureData = {
                                id: `${entry.name}_${file.size}_${file.lastModified}`,
                                name: entry.name.replace(/\.[^/.]+$/, ""),
                                displayName: entry.name.replace(/\.[^/.]+$/, ""),
                                handle: entry,
                                duration: duration,
                                chapter: chapterName
                            };
                            chapters[chapterName].lectures.push(lectureData);
                            lectures.push(lectureData);
                            totalDuration += duration;
                        } catch (e) {
                            console.error(`Could not process file ${entry.name}:`, e);
                        }
                    } else if (entry.kind === 'directory') {
                        await recurse(entry, path ? `${path}/${entry.name}` : entry.name);
                    }
                }
            }

            await recurse(dirHandle, '');
            const sortedChapters = Object.values(chapters).filter(ch => ch.lectures.length > 0).sort((a, b) => naturalSort(a, b));
            return { chapters: sortedChapters, videoCount: lectures.length, lectures, totalDuration };
        }

        async function renderCourseGrid() {
            courseGrid.innerHTML = '';
            if (courses.length === 0) { 
                courseGrid.innerHTML = `<p id="no-content-message">No courses added. Click 'Add Course' to begin.</p>`;
                totalTimeDisplay.style.display = 'none';
                return;
            }

            updateTotalTimeLeftDisplay();

            for (const course of courses) {
                const card = document.createElement('div');
                card.className = 'course-card';
                
                if (course.isLinked && course.handle && !course.lectures) {
                    try {
                        const courseData = await scanDirectoryHandle(course.handle);
                        course.lectures = courseData.lectures;
                        course.totalDuration = courseData.totalDuration;
                        course.chapters = courseData.chapters;
                    } catch (e) {
                        console.error(`Failed to scan course "${course.title}"`, e);
                    }
                }
                const progress = calculateCourseProgress(course);

                const ratingStarsHTML = Array.from({length: 5}, (_, i) => 
                    `<i class="fa-star ${ (course.rating || 0) > i ? 'fas' : 'far'}" data-value="${i + 1}"></i>`
                ).join('');
                
                card.innerHTML = `
                    <div class="thumbnail-placeholder ${course.thumbnail ? 'has-thumbnail' : ''}" data-id="${course.id}" style="${course.thumbnail ? `background-image: url('${course.thumbnail}')` : ''}">
                        <i class="fas fa-photo-video"></i>
                        <button class="refresh-course-btn" data-id="${course.id}" title="Refresh Course Content"><i class="fas fa-sync-alt"></i></button>
                        <button class="remove-thumbnail-btn" data-id="${course.id}" title="Remove Thumbnail"><i class="fas fa-times"></i></button>
                        <button class="remove-course-btn" data-id="${course.id}" title="Remove Course"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="course-info">
                        <div>
                            <h3 title="${course.title} (Double-click to edit)">${course.title}</h3>
                            <div class="course-extra-info" data-id="${course.id}">
                                <div class="course-faculty" title="Double-click to edit faculty">${course.facultyName || 'N/A Faculty'}</div>
                                <div class="course-rating">${ratingStarsHTML}</div>
                            </div>
                            <p class="course-meta">${course.videoCount || 0} videos</p>
                            ${course.totalDuration ? `<div class="course-duration">${formatDuration(course.totalDuration)} total • ${formatDuration(progress.remainingDuration)} left</div>` : ''}
                        </div>
                        <div class="course-progress-container">
                            <div class="course-progress-bar"><div class="course-progress-fill" style="width: ${progress.percentage}%"></div></div>
                            <div class="course-progress-text">${progress.completed} / ${progress.total || course.videoCount || 0} lectures completed</div>
                        </div>
                        <button class="enter-course-btn" data-id="${course.id}">Enter Course</button>
                    </div>`;
                courseGrid.appendChild(card);
            }
        }

        function showFilteredCoursesView(status) {
            const filterResultsView = document.getElementById('filter-results-view');
            const allItems = Object.values(courseProgress).filter(p => p.status === status);
            const courseIdsWithStatus = [...new Set(allItems.map(item => item.courseId))];
            const coursesToShow = courses.filter(c => courseIdsWithStatus.includes(c.id));
            
            let header = `
                <div class="view-header">
                    <button class="primary-btn" id="back-to-status-view-btn" data-view="${status}-view"><i class="fas fa-arrow-left"></i> Back to ${status.charAt(0).toUpperCase() + status.slice(1)}</button>
                </div>
                <main id="filter-results-grid" class="grid-container"></main>
            `;
            filterResultsView.innerHTML = header;

            const grid = filterResultsView.querySelector('#filter-results-grid');
            if (coursesToShow.length === 0) {
                grid.innerHTML = `<p id="no-content-message">No courses have lectures marked for ${status}.</p>`;
            } else {
                coursesToShow.forEach(course => {
                    const progress = calculateCourseProgress(course);
                    const card = document.createElement('div');
                    card.className = 'course-card';
                    card.dataset.courseIdFilter = course.id;
                    card.dataset.statusFilter = status;
                    card.style.cursor = 'pointer';
                    card.innerHTML = `
                         <div class="thumbnail-placeholder ${course.thumbnail ? 'has-thumbnail' : ''}" style="${course.thumbnail ? `background-image: url('${course.thumbnail}')` : ''}">
                             <i class="fas fa-photo-video"></i>
                         </div>
                         <div class="course-info" style="padding: 12px;">
                             <h3>${course.title}</h3>
                             <div class="course-progress-container">
                                 <div class="course-progress-bar"><div class="course-progress-fill" style="width: ${progress.percentage}%"></div></div>
                                 <div class="course-progress-text">${progress.completed} / ${progress.total || course.videoCount || 0} completed</div>
                             </div>
                         </div>`;
                    grid.appendChild(card);
                });
            }
            switchView('filter-results-view');
        }

        function renderStatusGrid(status, filter = null) {
            const grid = status === 'review' ? reviewGrid : practiceGrid;
            const allItems = Object.values(courseProgress).filter(p => p.status === status);
            const items = allItems.filter(p => !filter || p.courseId === filter);
            
            grid.innerHTML = '';
            if (items.length === 0) {
                const message = filter 
                    ? `No lectures for the selected course are marked for ${status}.` 
                    : `You haven't marked any lectures for ${status}.`;
                grid.innerHTML = `<p id="no-content-message">${message}</p>`; 
                return;
            }

            items.sort((a, b) => {
                const titleA = (a.courseTitle || '') + (a.lectureName || '');
                const titleB = (b.courseTitle || '') + (b.lectureName || '');
                return titleA.localeCompare(titleB);
            }).forEach(item => {
                const card = document.createElement('div');
                card.className = 'lecture-review-card';
                card.dataset.lectureId = item.lectureId;
                card.dataset.courseId = item.courseId;

                const watchedTime = item.currentTime || 0;
                const totalTime = item.lectureDuration || 1;
                const progressPercent = (watchedTime / totalTime) * 100;

                card.innerHTML = `
                    <button class="remove-status-btn" title="Remove Status"><i class="fas fa-times"></i></button>
                    <div class="lecture-review-info">
                        <p class="course-title">${item.courseTitle || 'Unknown Course'}</p>
                        <h3>${item.lectureName || 'Unknown Lecture'}</h3>
                        <div class="lecture-progress-bar"><div class="lecture-progress-fill" style="width: ${progressPercent}%"></div></div>
                        <div class="lecture-review-meta"><span class="time-display">${formatTime(watchedTime)} / ${formatTime(totalTime)}</span></div>
                    </div>
                    <div class="card-action-center">
                        <button class="primary-btn">
                            <i class="fas fa-play"></i> Watch Lecture
                        </button>
                    </div>`;
                grid.appendChild(card);
            });
        }
        
        // --- Upload View ---
        function renderUploadView() {
            const grid = document.getElementById('upload-course-grid');
            grid.innerHTML = '';
            
            if (courses.length === 0) { 
                grid.innerHTML = `<p id="no-content-message">No courses to upload files to. Add a course first.</p>`;
                return;
            }
            courses.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card'; 
                card.dataset.courseId = course.id;
                 card.innerHTML = `
                    <div class="thumbnail-placeholder ${course.thumbnail ? 'has-thumbnail' : ''}" style="${course.thumbnail ? `background-image: url('${course.thumbnail}')` : ''}">
                         <i class="fas fa-file-upload"></i>
                    </div>
                    <div class="course-info">
                        <h3>${course.title}</h3>
                        <p class="course-meta">${course.videoCount || 0} videos</p>
                    </div>
                    <div class="upload-card-actions">
                         <button class="primary-btn upload-notes-btn" data-id="${course.id}"><i class="fas fa-file-alt"></i> Upload Lecture Files</button>
                         <button class="primary-btn upload-dpp-btn" data-id="${course.id}"><i class="fas fa-file-invoice"></i> Upload DPPs</button>
                    </div>`;
                grid.appendChild(card);
            });
        }
        
        async function renderLectureUploadDetail(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (!course) {
                showToast("Could not find course data.", true);
                return;
            }

            if (course.isLinked && course.handle && !course.lectures) {
               await refreshCourse(course.id, null);
            }
            if (!course.lectures) {
                showToast("Could not load lectures for this course.", true);
                return;
            }

            document.getElementById('upload-course-grid').classList.add('hidden');
            const detailView = document.getElementById('upload-detail-view');
            detailView.classList.remove('hidden');
            detailView.dataset.courseId = courseId;

            document.getElementById('upload-course-title').textContent = course.title;
            const list = document.getElementById('upload-lecture-list');
            list.innerHTML = '';
            
            let lectures = [];
            course.chapters.forEach(ch => lectures.push(...ch.lectures));

            lectures.forEach(lecture => {
                const progress = getLectureProgress(course.id, lecture.id);
                const item = document.createElement('div');
                item.className = 'lecture-item';
                item.dataset.lectureId = lecture.id;
                item.innerHTML = `
                    <span>${lecture.displayName}</span>
                    <div class="file-status">
                        ${progress.pdfHandle ? '<i class="fas fa-file-pdf" title="Notes added"></i>' : ''}
                        ${progress.assignmentHandle ? '<i class="fas fa-file-alt" title="Assignment added"></i>' : ''}
                    </div>`;
                list.appendChild(item);
            });
            
            // Add click listeners for selection
            list.querySelectorAll('.lecture-item').forEach(item => {
                item.addEventListener('click', () => {
                    list.querySelectorAll('.lecture-item.selected').forEach(sel => sel.classList.remove('selected'));
                    item.classList.add('selected');
                });
            });
        }


        // --- Player ---
        function updateMenuProgress() {
            if (!currentCourse) return;
            const progress = calculateCourseProgress(currentCourse);
            const container = document.querySelector('#player-view .menu-header');
            container.querySelector('.course-stats').textContent = `${formatDuration(currentCourse.totalDuration)} total • ${formatDuration(progress.remainingDuration)} remaining`;
            container.querySelector('.menu-progress-fill').style.width = `${progress.percentage}%`;
            container.querySelector('.menu-progress-text').textContent = `${progress.completed}/${progress.total} lectures completed`;
        }

        async function playLectureFromAnywhere(courseId, lectureId, originView = 'dashboard-view') {
            lastView = originView;
            const course = courses.find(c => c.id === parseInt(courseId));
            if (!course) {
                showToast('Course not found.', true);
                return;
            }
            if (!course.isLinked) {
                const handle = course.handle;
                if (await handle.requestPermission({ mode: 'read' }) !== 'granted') { 
                    showToast('Permission to access course files denied.', true);
                    return; 
                }
                course.isLinked = true;
            }
            await renderPlayer(courseId, lectureId, originView);
        }

        async function renderPlayer(courseId, lectureIdToPlay = null, originView = 'dashboard-view', startTime = null) {
            currentCourse = courses.find(c => c.id === parseInt(courseId));
            if (!currentCourse) return;
            switchView('player-view');
            chapterListDiv.innerHTML = '<p style="text-align:center; padding: 20px;">Loading lectures...</p>';
            
            if (originView === 'dashboard-view') {
                backToLibraryBtn.textContent = '← Back to Courses';
            } else {
                const statusName = originView.split('-')[0];
                backToLibraryBtn.textContent = `← Back to ${statusName.charAt(0).toUpperCase() + statusName.slice(1)}`;
            }
            backToLibraryBtn.dataset.view = originView;

            if (!currentCourse.lectures || !currentCourse.chapters) {
                try {
                    const courseData = await scanDirectoryHandle(currentCourse.handle);
                    currentCourse.lectures = courseData.lectures;
                    currentCourse.totalDuration = courseData.totalDuration;
                    currentCourse.chapters = courseData.chapters;
                } catch (error) {
                    console.error('Failed to load course data:', error);
                    chapterListDiv.innerHTML = `<p id="no-content-message">Error: Could not load course content. The original folder may have been moved or deleted.</p>`;
                    return;
                }
            }
            
            let chaptersToDisplay = currentCourse.chapters;
            if (originView === 'review-view' || originView === 'practice-view') {
                const status = originView.split('-')[0];
                const statusLectures = Object.values(courseProgress)
                    .filter(p => p.status === status && p.courseId === currentCourse.id)
                    .map(p => p.lectureId);

                chaptersToDisplay = JSON.parse(JSON.stringify(currentCourse.chapters)).map(chapter => {
                    chapter.lectures = chapter.lectures.filter(l => statusLectures.includes(l.id));
                    return chapter;
                }).filter(chapter => chapter.lectures.length > 0);
                
                courseTitleMenu.textContent = `${currentCourse.title} (${status.charAt(0).toUpperCase() + status.slice(1)} Lectures)`;
                clearBookmarksBtn.classList.add('hidden');
            } else {
                courseTitleMenu.textContent = currentCourse.title;
                clearBookmarksBtn.classList.remove('hidden');
            }

            updateMenuProgress();
            renderChapterList(chaptersToDisplay, lectureIdToPlay);

            const liToPlay = chapterListDiv.querySelector(`li[data-lecture-id="${lectureIdToPlay}"]`) || chapterListDiv.querySelector('li');
            if (liToPlay) await playVideo(liToPlay, startTime);
        }
        
        function renderChapterList(chaptersToDisplay, lectureIdToPlay = null) {
             chapterListDiv.innerHTML = '';
             if (!chaptersToDisplay || chaptersToDisplay.length === 0 || (chaptersToDisplay.length === 1 && chaptersToDisplay[0].lectures.length === 0)) {
                 chapterListDiv.innerHTML = `<p id="no-content-message">No lectures found for this course or filter.</p>`;
                 return;
             }
            
             chaptersToDisplay.forEach((chapter) => {
                 const chapterDiv = document.createElement('div');
                 chapterDiv.className = 'chapter open';
                 chapterDiv.dataset.chapterName = chapter.name;
                 chapterDiv.draggable = true;

                 const chapterDuration = chapter.lectures.reduce((sum, lect) => sum + (lect.duration || 0), 0);

                 chapterDiv.innerHTML = `
                     <div class="chapter-title">
                         <i class="fas fa-grip-vertical chapter-drag-handle" title="Drag to reorder"></i>
                         <i class="fas fa-chevron-right"></i>
                         <span class="chapter-title-text" title="Double-click to rename">${chapter.name}</span>
                         <span class="chapter-duration">${formatDuration(chapterDuration)}</span>
                     </div>`;

                 const lectureList = document.createElement('ul');
                 lectureList.className = 'lecture-list';

                 for (const lecture of chapter.lectures) {
                     const progress = getLectureProgress(currentCourse.id, lecture.id);
                     const lectureLi = document.createElement('li');
                     lectureLi.dataset.lectureId = lecture.id;

                     const pdfBtn = progress.pdfHandle
                         ? `<button class="file-btn view-pdf-btn" title="${progress.pdfName || 'View Notes'}"><i class="fas fa-file-pdf"></i></button>`
                         : `<button class="file-btn add-pdf-btn" title="Add Notes (PDF)"><i class="fas fa-plus"></i></button>`;

                     const assignBtn = progress.assignmentHandle
                         ? `<button class="file-btn view-assignment-btn" title="${progress.assignmentName || 'View Assignment'}"><i class="fas fa-file-alt"></i></button>`
                         : `<button class="file-btn add-assignment-btn" title="Add Assignment"><i class="fas fa-plus"></i></button>`;

                     lectureLi.innerHTML = `
                         <div class="lecture-checkbox ${progress.completed ? 'completed' : ''}"><i class="fas fa-check"></i></div>
                         <div class="lecture-title ${progress.completed ? 'completed' : ''}" title="${lecture.displayName} (Double-click to rename)">${lecture.displayName}</div>
                         <div class="file-controls">
                             ${pdfBtn}
                             ${assignBtn}
                         </div>
                         <span class="lecture-duration">${formatTime(lecture.duration, false)}</span>
                         <button class="status-btn ${progress.status || ''}" data-lecture-name="${lecture.displayName}" data-duration="${lecture.duration}">
                             ${progress.status ? progress.status.toUpperCase() : 'STATUS'}
                         </button>`;
                     lectureList.appendChild(lectureLi);
                 }
                 chapterDiv.appendChild(lectureList);
                 chapterListDiv.appendChild(chapterDiv);
             });
        }

        async function playVideo(liElement, startTime = null) {
            if (currentLectureLi) { // Save last played info before switching
                const lastLectureId = currentLectureLi.dataset.lectureId;
                if (lastLectureId !== liElement.dataset.lectureId) {
                    currentCourse.lastPlayedLecture = { lectureId: lastLectureId, currentTime: videoPlayer.currentTime };
                    await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(currentCourse).onsuccess = resolve);
                }
            }
            if (currentLectureLi) currentLectureLi.classList.remove('active');
            currentLectureLi = liElement;
            currentLectureLi.classList.add('active');
            const lectureId = liElement.dataset.lectureId;
            const lecture = currentCourse.lectures.find(l => l.id === lectureId);
            if (!lecture) return;

            updateMediaViewerToggleButton();

            try {
                const file = await lecture.handle.getFile();
                if(videoPlayer.src) URL.revokeObjectURL(videoPlayer.src);
                videoPlayer.src = URL.createObjectURL(file);
                videoPlayer.load();

                videoPlayer.addEventListener('loadeddata', async () => {
                    renderBookmarks();
                    let timeToSet = startTime;
                    if (timeToSet === null) {
                        const progress = getLectureProgress(currentCourse.id, lecture.id);
                        if(progress.currentTime) timeToSet = progress.currentTime;
                    }
                    if(timeToSet) videoPlayer.currentTime = timeToSet;
                    
                    unmuteBtn.classList.add('hidden');
                    videoPlayer.muted = !userInteracted;

                    try {
                        await videoPlayer.play();
                    } catch (err) {
                        console.warn("Autoplay was prevented:", err.message);
                        videoPlayer.muted = true;
                        unmuteBtn.classList.remove('hidden');
                        await videoPlayer.play();
                    }
                }, { once: true });

                videoPlayer.onended = () => {
                    const lectureId = currentLectureLi.dataset.lectureId;
                    const lecture = currentCourse.lectures.find(l => l.id === lectureId);
                    saveLectureProgress({ 
                        courseId: currentCourse.id, 
                        lectureId, 
                        completed: true, 
                        currentTime: 0,
                        lectureName: lecture.displayName,
                        courseTitle: currentCourse.title,
                        lectureDuration: lecture.duration
                    });
                    updateMenuProgress();
                    updateTotalTimeLeftDisplay();
                    liElement.querySelector('.lecture-checkbox').classList.add('completed');
                    liElement.querySelector('.lecture-title').classList.add('completed');
                };
            } catch (error) {
                console.error("Failed to load video:", error);
                showToast("Could not load video. The original file may have been moved or deleted.", true);
                videoPlayer.src = "";
                videoPlayer.load();
            }
        }
        
        async function refreshCourse(courseId, btnElement) {
            const course = courses.find(c => c.id === courseId);
            if (!course || !course.handle) {
                showToast('Could not find the course folder. It may have been moved or deleted.', true);
                return;
            }

            if (btnElement) btnElement.classList.add('loading');

            try {
                if ((await course.handle.queryPermission({ mode: 'read' })) !== 'granted') {
                    if ((await course.handle.requestPermission({ mode: 'read' })) !== 'granted') {
                        showToast('Permission denied. Cannot refresh course.', true);
                        return;
                    }
                }

                const newCourseData = await scanDirectoryHandle(course.handle);

                course.lectures = newCourseData.lectures;
                course.chapters = newCourseData.chapters;
                course.videoCount = newCourseData.videoCount;
                course.totalDuration = newCourseData.totalDuration;
                
                await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(course).onsuccess = resolve);
                await renderCourseGrid();
            } catch (error) {
                console.error('Error refreshing course:', error);
                showToast('An error occurred while refreshing the course.', true);
            } finally {
                if(btnElement) btnElement.classList.remove('loading');
            }
        }

        async function showMediaViewer(fileHandle, fileType, fileName, lectureProgress) {
            try {
                let file = fileHandle instanceof File ? fileHandle : await fileHandle.getFile();
                if (activeFileUrl) URL.revokeObjectURL(activeFileUrl);

                let blobToView = file; 

                if (fileType.toLowerCase() === 'assignment' || fileType.toLowerCase() === 'dpp' || fileType.toLowerCase() === 'note') {
                    blobToView = new Blob([file], { type: 'application/pdf' });
                }

                activeFileUrl = URL.createObjectURL(blobToView);
                
                if (fileType.toLowerCase() === 'dpp') {
                    document.getElementById('dpp-viewer-frame').src = activeFileUrl;
                    document.getElementById('dpp-no-content-message').classList.add('hidden');
                } else if (fileType.toLowerCase() === 'note') {
                    document.getElementById('notes-viewer-frame').src = activeFileUrl;
                    document.getElementById('notes-no-content-message').classList.add('hidden');
                } else {
                    mediaViewerFrame.src = activeFileUrl;
                    viewerTitle.textContent = fileName || file.name;
                    activeViewerFileType = fileType.toLowerCase();
                    updateFileSwitcher(lectureProgress, activeViewerFileType);
                    const preferredWidth = localStorage.getItem('viewerWidth') || '500px';
                    playerView.style.setProperty('--viewer-width', preferredWidth);
                    mediaViewer.style.width = preferredWidth;
                    playerView.classList.add('viewer-active');
                    mediaViewer.classList.remove('hidden');
                    mediaViewerToggleBtn.classList.add('hidden');
                    deleteViewerFileBtn.dataset.type = activeViewerFileType;
                    deleteViewerFileBtn.classList.add('visible');
                }
            } catch (error) {
                console.error("Error showing file:", error);
                showToast("Failed to open file. Please try re-adding it.", true);
                if (fileType.toLowerCase() !== 'dpp' && fileType.toLowerCase() !== 'note') {
                    hideMediaViewer();
                }
            }
        }

        function updateFileSwitcher(lectureProgress, currentType) {
            const container = document.getElementById('file-switcher-container');
            container.innerHTML = '';

            const hasPdf = !!lectureProgress.pdfHandle;
            const hasAssignment = !!lectureProgress.assignmentHandle;

            if (hasPdf && hasAssignment) {
                const otherType = currentType === 'pdf' ? 'assignment' : 'pdf';
                const otherHandle = otherType === 'pdf' ? lectureProgress.pdfHandle : lectureProgress.assignmentHandle;
                const otherName = otherType === 'pdf' ? lectureProgress.pdfName : lectureProgress.assignmentName;

                container.innerHTML = `
                    <button id="file-switcher-btn">${currentType.toUpperCase()} <i class="fas fa-chevron-down fa-xs"></i></button>
                    <div id="file-switcher-dropdown" class="hidden">
                        <button data-type="${otherType}">${otherType === 'pdf' ? 'View Notes' : 'View Assignment'}</button>
                    </div>`;

                const btn = container.querySelector('#file-switcher-btn');
                const dropdown = container.querySelector('#file-switcher-dropdown');
                btn.onclick = () => dropdown.classList.toggle('hidden');
                
                dropdown.querySelector('button').onclick = () => {
                    showMediaViewer(otherHandle, otherType, otherName, lectureProgress);
                };
                document.addEventListener('click', (e) => {
                     if (!container.contains(e.target)) dropdown.classList.add('hidden');
                }, { once: true });
            }
        }
        
        function hideMediaViewer() {
            playerView.classList.remove('viewer-active');
            mediaViewer.classList.add('hidden');
            deleteViewerFileBtn.classList.remove('visible');
            if (activeFileUrl) {
                URL.revokeObjectURL(activeFileUrl);
                activeFileUrl = null;
            }
            mediaViewerFrame.src = 'about:blank';
            activeViewerFileType = null;
            playerView.style.setProperty('--viewer-width', '0px');
            updateMediaViewerToggleButton();
        }

        function updateMediaViewerToggleButton() {
            if (!currentLectureLi) {
                mediaViewerToggleBtn.classList.add('hidden');
                return;
            }
            const lectureId = currentLectureLi.dataset.lectureId;
            const progress = getLectureProgress(currentCourse.id, lectureId);
            const hasFiles = progress.pdfHandle || progress.assignmentHandle;
            
            const viewerIsHidden = mediaViewer.classList.contains('hidden');
            mediaViewerToggleBtn.classList.toggle('hidden', !hasFiles || !viewerIsHidden);
        }

        // --- Event Listeners ---
        navLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); switchView(e.target.dataset.view); }));
        homeBtn.addEventListener('click', () => switchView('dashboard-view'));

        document.body.addEventListener('click', async (e) => {
            userInteracted = true;
            videoPlayer.muted = false;
            unmuteBtn.classList.add('hidden');

            if (e.target.closest('.enter-course-btn')) { await playLectureFromAnywhere(e.target.closest('.enter-course-btn').dataset.id, null); }
            
            const reviewCard = e.target.closest('#review-grid .lecture-review-card, #practice-grid .lecture-review-card');
            if (reviewCard && !e.target.closest('.remove-status-btn')) {
                const currentViewId = document.querySelector('.view.active').id;
                await playLectureFromAnywhere(reviewCard.dataset.courseId, reviewCard.dataset.lectureId, currentViewId);
                return;
            }
            
            const filterResultsCard = e.target.closest('#filter-results-view .course-card');
            if (filterResultsCard) {
                e.preventDefault();
                const courseId = parseInt(filterResultsCard.dataset.courseIdFilter);
                const status = filterResultsCard.dataset.statusFilter;
                await playLectureFromAnywhere(courseId, null, `${status}-view`);
            }
            
            const backToStatusBtn = e.target.closest('#back-to-status-view-btn');
            if(backToStatusBtn) {
                switchView(backToStatusBtn.dataset.view);
            }


            const removeStatusBtn = e.target.closest('.remove-status-btn');
            if (removeStatusBtn) {
                e.stopPropagation();
                const card = removeStatusBtn.parentElement;
                const courseId = parseInt(card.dataset.courseId);
                const lectureId = card.dataset.lectureId;
                const progress = getLectureProgress(courseId, lectureId);
                if (progress) {
                    progress.status = null;
                    await saveLectureProgress(progress);
                    const activeView = document.querySelector('.view.active');
                    if (activeView.id === 'review-view') {
                        renderStatusGrid('review');
                    } else if (activeView.id === 'practice-view') {
                        renderStatusGrid('practice');
                    }
                }
            }

            const removeBtn = e.target.closest('.remove-course-btn');
            if (removeBtn) { e.stopPropagation(); const courseId = parseInt(removeBtn.dataset.id); if (confirm('Are you sure you want to remove this course? This will also delete its progress.')) { await new Promise(resolve => getStore(STORE_NAME, 'readwrite').delete(courseId).onsuccess = resolve); await loadCoursesFromDB(); } }
            
            const refreshBtn = e.target.closest('.refresh-course-btn');
            if (refreshBtn) { e.stopPropagation(); const courseId = parseInt(refreshBtn.dataset.id); await refreshCourse(courseId, refreshBtn); }
            
            const thumbPlaceholder = e.target.closest('.thumbnail-placeholder');
            if (thumbPlaceholder && !removeBtn && !refreshBtn && !e.target.closest('.remove-thumbnail-btn') && !e.target.closest('.upload-notes-btn') && !e.target.closest('.upload-dpp-btn')) { document.getElementById('thumbnail-uploader').dataset.courseId = thumbPlaceholder.dataset.id; document.getElementById('thumbnail-uploader').click(); }
            if (e.target.closest('.remove-thumbnail-btn')) { e.stopPropagation(); const btn = e.target.closest('.remove-thumbnail-btn'); const course = courses.find(c => c.id === parseInt(btn.dataset.id)); if (course) { delete course.thumbnail; getStore(STORE_NAME, 'readwrite').put(course); renderCourseGrid(); } }
            
            const filterBtnReview = e.target.closest('#filter-btn-review');
            if(filterBtnReview) showFilteredCoursesView('review');
            const filterBtnPractice = e.target.closest('#filter-btn-practice');
            if(filterBtnPractice) showFilteredCoursesView('practice');

            const uploadNotesBtn = e.target.closest('.upload-notes-btn');
            if (uploadNotesBtn) {
                const courseId = parseInt(uploadNotesBtn.dataset.id);
                document.getElementById('upload-course-grid').classList.add('hidden');
                document.getElementById('upload-detail-view').classList.remove('hidden');
                await renderLectureUploadDetail(courseId);
            }

            const uploadDppBtn = e.target.closest('.upload-dpp-btn');
            if (uploadDppBtn) {
                const courseId = parseInt(uploadDppBtn.dataset.id);
                switchView('dpp-upload-view');
                await renderDppUploadView(courseId);
            }

            const dppCourseCard = e.target.closest('#dpp-course-grid .course-card .enter-course-btn');
            if(dppCourseCard) {
                const courseId = parseInt(dppCourseCard.closest('.course-card').dataset.courseId);
                await renderDppDetailView(courseId);
            }
            if(e.target.closest('#back-to-dpp-grid')) {
                renderDppCourseSelectionView();
            }

            const notesCourseCard = e.target.closest('#notes-course-grid .course-card .enter-course-btn');
            if(notesCourseCard) {
                const courseId = parseInt(notesCourseCard.closest('.course-card').dataset.courseId);
                await renderNotesDetailView(courseId);
            }
             if(e.target.closest('#back-to-notes-grid')) {
                renderNotesCourseSelectionView();
            }


        });
        
        // --- Edit Title/Faculty Listeners ---
        courseGrid.addEventListener('dblclick', (e) => {
            const titleH3 = e.target.closest('.course-info h3');
            const facultyDiv = e.target.closest('.course-faculty');

            if (titleH3) {
                const courseCard = titleH3.closest('.course-card');
                if (!courseCard || titleH3.querySelector('input')) return;
                
                const originalText = titleH3.textContent;
                titleH3.innerHTML = `<input type="text" class="course-info-input" value="${originalText}" />`;
                const input = titleH3.querySelector('input');
                input.focus();
                input.select();

                const saveTitle = async () => {
                    const courseId = parseInt(courseCard.querySelector('.thumbnail-placeholder').dataset.id);
                    const course = courses.find(c => c.id === courseId);
                    if (!course) return;

                    const newTitle = input.value.trim();
                    titleH3.textContent = newTitle || originalText;
                    titleH3.title = (newTitle || originalText) + " (Double-click to edit)";
                    
                    if (newTitle && newTitle !== course.title) {
                        course.title = newTitle;
                        await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(course).onsuccess = resolve);
                    }
                };
                input.addEventListener('blur', saveTitle);
                input.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter') input.blur();
                    if (ev.key === 'Escape') {
                        input.removeEventListener('blur', saveTitle);
                        titleH3.textContent = originalText;
                    }
                });

            } else if (facultyDiv) {
                if (facultyDiv.querySelector('input')) return;
            
                const originalText = facultyDiv.textContent;
                facultyDiv.innerHTML = `<input type="text" class="course-faculty-input" value="${originalText === 'N/A Faculty' ? '' : originalText}" />`;
                const input = facultyDiv.querySelector('input');
                input.focus();
                input.select();
            
                const saveFacultyName = async () => {
                    const courseId = parseInt(facultyDiv.parentElement.dataset.id);
                    const course = courses.find(c => c.id === courseId);
                    if (!course) return;

                    const newName = input.value.trim();
                    facultyDiv.textContent = newName || 'N/A Faculty';
                    
                     if (newName !== (course.facultyName || '')) {
                         course.facultyName = newName || null;
                         await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(course).onsuccess = resolve);
                     }
                };
                
                input.addEventListener('blur', saveFacultyName);
                input.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter') input.blur();
                    if (ev.key === 'Escape') {
                        input.removeEventListener('blur', saveFacultyName);
                        facultyDiv.textContent = originalText;
                    }
                });
            }
        });

        courseGrid.addEventListener('click', async (e) => {
            const star = e.target.closest('.course-rating i.fa-star');
            if (!star) return;

            const ratingContainer = star.parentElement;
            const courseId = parseInt(ratingContainer.parentElement.dataset.id);
            const course = courses.find(c => c.id === courseId);
            if (!course) return;

            const newRating = parseInt(star.dataset.value);
            course.rating = (course.rating === newRating) ? 0 : newRating; 

            await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(course).onsuccess = resolve);
            
            const allStars = ratingContainer.querySelectorAll('i');
            allStars.forEach((s, i) => {
                s.classList.toggle('fas', course.rating > i);
                s.classList.toggle('far', course.rating <= i);
            });
        });

        // --- Player View Listeners ---
        chapterListDiv.addEventListener('click', async (e) => {
            const lectureLi = e.target.closest('li');
            const chapterTitle = e.target.closest('.chapter-title');

            if(chapterTitle && !e.target.closest('.chapter-drag-handle') && !e.target.classList.contains('chapter-title-text')) { 
                chapterTitle.parentElement.classList.toggle('open'); 
                return; 
            }
            if(!lectureLi) return;

            const lectureId = lectureLi.dataset.lectureId;
            const lectureProgress = getLectureProgress(currentCourse.id, lectureId);
            const lecture = currentCourse.lectures.find(l => l.id === lectureId);

            if (e.target.closest('.add-pdf-btn')) {
                addPdfInput.dataset.lectureId = lectureId;
                addPdfInput.click();
            } else if (e.target.closest('.add-assignment-btn')) {
                addAssignmentInput.dataset.lectureId = lectureId;
                addAssignmentInput.click();
            } else if (e.target.closest('.view-pdf-btn')) {
                if (lectureProgress.pdfHandle) {
                    if (activeViewerFileType === 'pdf' && !mediaViewer.classList.contains('hidden')) hideMediaViewer();
                    else showMediaViewer(lectureProgress.pdfHandle, 'PDF', lectureProgress.pdfName, lectureProgress);
                }
            } else if (e.target.closest('.view-assignment-btn')) {
                if (lectureProgress.assignmentHandle) {
                    if (activeViewerFileType === 'assignment' && !mediaViewer.classList.contains('hidden')) hideMediaViewer();
                    else showMediaViewer(lectureProgress.assignmentHandle, 'Assignment', lectureProgress.assignmentName, lectureProgress);
                }
            } else if (e.target.closest('.status-btn')) {
                e.stopPropagation();
                const btn = e.target.closest('.status-btn');
                const currentStatus = lectureProgress.status;
                let newStatus = 'review';
                if (currentStatus === 'review') newStatus = 'practice';
                else if (currentStatus === 'practice') newStatus = null;
                btn.className = 'status-btn';
                if (newStatus) btn.classList.add(newStatus);
                btn.textContent = newStatus ? newStatus.toUpperCase() : 'STATUS';
                await saveLectureProgress({ ...lectureProgress, status: newStatus, courseTitle: currentCourse.title, lectureName: lecture.displayName, lectureDuration: lecture.duration, courseId: currentCourse.id, lectureId: lectureId });
            } else if(e.target.closest('.lecture-checkbox')) {
                e.stopPropagation();
                const checkbox = e.target.closest('.lecture-checkbox');
                const isCompleted = !checkbox.classList.contains('completed');
                checkbox.classList.toggle('completed');
                lectureLi.querySelector('.lecture-title').classList.toggle('completed');
                await saveLectureProgress({ 
                    ...lectureProgress, 
                    completed: isCompleted, 
                    courseId: currentCourse.id, 
                    lectureId: lectureId,
                    lectureName: lecture.displayName,
                    courseTitle: currentCourse.title,
                    lectureDuration: lecture.duration
                });
                updateMenuProgress();
                updateTotalTimeLeftDisplay();
            } else if (!e.target.classList.contains('lecture-title-input')) {
                playVideo(lectureLi);
            }
        });
        
        chapterListDiv.addEventListener('dblclick', (e) => {
            const titleDiv = e.target.closest('.lecture-title, .chapter-title-text');
            if (!titleDiv || titleDiv.querySelector('input')) return;

            const isChapter = titleDiv.classList.contains('chapter-title-text');
            const originalText = titleDiv.textContent;
            
            titleDiv.innerHTML = `<input type="text" class="lecture-title-input" value="${originalText}" />`;
            const input = titleDiv.querySelector('input');
            input.focus();
            input.select();
            
            const saveRename = async () => {
                const newName = input.value.trim();
                if (isChapter) {
                    const chapterDiv = titleDiv.closest('.chapter');
                    const oldName = chapterDiv.dataset.chapterName;
                    if (newName && newName !== oldName) {
                        const chapter = currentCourse.chapters.find(c => c.name === oldName);
                        if(chapter) {
                            chapter.name = newName;
                            currentCourse.lectures.forEach(l => {
                                if (l.chapter === oldName) l.chapter = newName;
                            });
                            await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(currentCourse).onsuccess = resolve);
                            chapterDiv.dataset.chapterName = newName;
                        }
                    }
                    titleDiv.innerHTML = newName || oldName;
                } else {
                    const li = titleDiv.closest('li');
                    const lectureId = li.dataset.lectureId;
                    const lecture = currentCourse.lectures.find(l => l.id === lectureId);
                    
                    if (newName && newName !== lecture.displayName) {
                        lecture.displayName = newName;
                        await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(currentCourse).onsuccess = resolve);
                        const progress = getLectureProgress(currentCourse.id, lectureId);
                        if (progress) {
                            await saveLectureProgress({ ...progress, lectureName: newName, courseId: currentCourse.id, lectureId: lectureId });
                        }
                    }
                    titleDiv.innerHTML = newName || lecture.displayName;
                    titleDiv.title = (newName || lecture.displayName) + " (Double-click to rename)";
                    li.querySelector('.status-btn').dataset.lectureName = newName || lecture.displayName;
                }
            };

            input.addEventListener('blur', saveRename);
            input.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter') input.blur();
                if (ev.key === 'Escape') {
                    input.removeEventListener('blur', saveRename);
                    titleDiv.innerHTML = originalText;
                }
            });
        });

        addPdfInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const lectureId = e.target.dataset.lectureId;
            if (file && lectureId) {
                const progressData = getLectureProgress(currentCourse.id, lectureId);
                await saveLectureProgress({ ...progressData, pdfHandle: file, pdfName: file.name, courseId: currentCourse.id, lectureId: lectureId });
                await renderPlayer(currentCourse.id, lectureId, lastView);
                await showMediaViewer(file, 'PDF', file.name, getLectureProgress(currentCourse.id, lectureId));
            }
            e.target.value = null;
        });

        addAssignmentInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const lectureId = e.target.dataset.lectureId;
            if (file && lectureId) {
                const progressData = getLectureProgress(currentCourse.id, lectureId);
                await saveLectureProgress({ ...progressData, assignmentHandle: file, assignmentName: file.name, assignmentType: file.type, courseId: currentCourse.id, lectureId: lectureId });
                await renderPlayer(currentCourse.id, lectureId, lastView);
                await showMediaViewer(file, 'Assignment', file.name, getLectureProgress(currentCourse.id, lectureId));
            }
            e.target.value = null;
        });
        
        backToLibraryBtn.addEventListener('click', () => {
            videoPlayer.pause(); videoPlayer.src = ""; videoPlayer.load();
            hideMediaViewer();
            const targetView = backToLibraryBtn.dataset.view || 'dashboard-view';
            if (targetView.includes('review') || targetView.includes('practice')) {
                showFilteredCoursesView(targetView.split('-')[0]);
            } else {
                switchView(targetView);
            }
        });

        closeViewerBtn.addEventListener('click', hideMediaViewer);
        
        mediaViewerToggleBtn.addEventListener('click', () => {
            const isHidden = mediaViewer.classList.contains('hidden');
            if (isHidden) {
                const lectureId = currentLectureLi.dataset.lectureId;
                const progress = getLectureProgress(currentCourse.id, lectureId);
                let fileToShow = null;
                if (activeViewerFileType === 'pdf' && progress.pdfHandle) {
                   fileToShow = { handle: progress.pdfHandle, type: 'PDF', name: progress.pdfName };
                } else if (activeViewerFileType === 'assignment' && progress.assignmentHandle) {
                   fileToShow = { handle: progress.assignmentHandle, type: 'Assignment', name: progress.assignmentName };
                } else if (progress.pdfHandle) {
                   fileToShow = { handle: progress.pdfHandle, type: 'PDF', name: progress.pdfName };
                } else if (progress.assignmentHandle) {
                   fileToShow = { handle: progress.assignmentHandle, type: 'Assignment', name: progress.assignmentName };
                }

                if(fileToShow) {
                    showMediaViewer(fileToShow.handle, fileToShow.type, fileToShow.name, progress);
                }
            } else {
                hideMediaViewer();
            }
        });

        deleteViewerFileBtn.addEventListener('click', async () => {
            const fileType = deleteViewerFileBtn.dataset.type;
            if (!currentLectureLi || !fileType) return;
            if (confirm(`Are you sure you want to delete this ${fileType}?`)) {
                const lectureId = currentLectureLi.dataset.lectureId;
                const lectureProgress = getLectureProgress(currentCourse.id, lectureId);
                if (fileType === 'pdf') {
                    delete lectureProgress.pdfHandle;
                    delete lectureProgress.pdfName;
                } else if (fileType === 'assignment') {
                    delete lectureProgress.assignmentHandle;
                    delete lectureProgress.assignmentName;
                }
                await saveLectureProgress(lectureProgress);
                hideMediaViewer();
                updateMediaViewerToggleButton();
                await renderPlayer(currentCourse.id, lectureId, lastView);
            }
        });
        
        setInterval(() => {
            if (currentCourse && currentLectureLi && !videoPlayer.paused) {
                const lectureId = currentLectureLi.dataset.lectureId;
                const currentTime = videoPlayer.currentTime;
                saveLectureProgress({ courseId: currentCourse.id, lectureId: lectureId, currentTime: currentTime });
                const state = { view: 'player-view', courseId: currentCourse.id, lectureId, currentTime, lastView, sidebarCollapsed: lectureMenu.classList.contains('hidden') };
                sessionStorage.setItem('courseflixState', JSON.stringify(state));
            }
        }, 5000);

        window.addEventListener('beforeunload', () => {
            if (document.querySelector('.view.active')?.id === 'player-view' && currentCourse && currentLectureLi) {
                const lectureId = currentLectureLi.dataset.lectureId;
                const currentTime = videoPlayer.currentTime;
                const state = { view: 'player-view', courseId: currentCourse.id, lectureId, currentTime, lastView, sidebarCollapsed: lectureMenu.classList.contains('hidden') };
                sessionStorage.setItem('courseflixState', JSON.stringify(state));
            }
        });
        
        document.getElementById('add-course-btn').addEventListener('click', () => {
            const modal = document.getElementById('modal-overlay');
            modal.querySelector('.close-modal-btn').onclick = () => modal.classList.add('hidden');
            modal.classList.remove('hidden');
        });
        document.getElementById('modal-overlay').addEventListener('click', (e) => { if (e.target.id === 'modal-overlay') e.target.classList.add('hidden'); });
        
        document.getElementById('add-folder-btn').addEventListener('click', async () => { 
            try {
                const dirHandle = await window.showDirectoryPicker({ startIn: 'downloads' });
                const courseData = await scanDirectoryHandle(dirHandle);
                if (courseData.videoCount === 0) {
                    return showToast('No videos found in this folder or its subfolders.', true);
                }
                const newCourse = {
                    id: Date.now(), title: dirHandle.name, handle: dirHandle,
                    videoCount: courseData.videoCount, lectures: courseData.lectures,
                    totalDuration: courseData.totalDuration, chapters: courseData.chapters
                };
                getStore(STORE_NAME, 'readwrite').add(newCourse);
                await loadCoursesFromDB();
            } catch (e) {
                if (e.name !== 'AbortError') console.error(e);
            } finally {
                document.getElementById('modal-overlay').classList.add('hidden');
            }
        });

        document.getElementById('thumbnail-uploader').addEventListener('change', (e) => { const file = e.target.files[0]; const courseId = parseInt(e.target.dataset.courseId); if (!file || !courseId) return; const reader = new FileReader(); reader.onload = async (event) => { const course = courses.find(c=>c.id === courseId); if(course) { course.thumbnail = event.target.result; getStore(STORE_NAME, 'readwrite').put(course); renderCourseGrid(); } }; reader.readAsDataURL(file); });
        
        sidebarToggleBtn.addEventListener('click', () => {
            lectureMenu.classList.toggle('hidden');
            sidebarToggleBtn.classList.toggle('collapsed');
        });
        
        // --- Drag and Drop for Chapters ---
        let draggedChapter = null;

        chapterListDiv.addEventListener('dragstart', e => {
            if (e.target.classList.contains('chapter')) {
                draggedChapter = e.target;
                setTimeout(() => {
                    draggedChapter.classList.add('dragging');
                }, 0);
            } else {
                e.preventDefault();
            }
        });

        chapterListDiv.addEventListener('dragend', () => {
            if (draggedChapter) {
                draggedChapter.classList.remove('dragging');
            }
            draggedChapter = null;
            document.querySelectorAll('.chapter-drop-indicator').forEach(el => el.remove());
        });

        chapterListDiv.addEventListener('dragover', e => {
            e.preventDefault();
            const container = chapterListDiv;
            const afterElement = getDragAfterElement(container, e.clientY);
            
            document.querySelectorAll('.chapter-drop-indicator').forEach(el => el.remove());

            const indicator = document.createElement('div');
            indicator.className = 'chapter-drop-indicator';

            if (afterElement == null) {
                container.appendChild(indicator);
            } else {
                container.insertBefore(indicator, afterElement);
            }
        });
        
        chapterListDiv.addEventListener('drop', async e => {
            e.preventDefault();
            if (!draggedChapter) return;
            
            const fromName = draggedChapter.dataset.chapterName;
            const fromIndex = currentCourse.chapters.findIndex(c => c.name === fromName);

            const dropIndicator = chapterListDiv.querySelector('.chapter-drop-indicator');
            const afterElement = dropIndicator ? dropIndicator.nextElementSibling : null;

            let toIndex;
            if (afterElement) {
                const toName = afterElement.dataset.chapterName;
                toIndex = currentCourse.chapters.findIndex(c => c.name === toName);
            } else {
                toIndex = currentCourse.chapters.length;
            }

            if (fromIndex < toIndex) { toIndex--; }
            
            const [movedItem] = currentCourse.chapters.splice(fromIndex, 1);
            currentCourse.chapters.splice(toIndex, 0, movedItem);

            await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(currentCourse).onsuccess = resolve);
            renderChapterList(currentCourse.chapters);
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.chapter:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // --- Import / Export ---
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function base64ToBlob(base64) {
            const byteString = atob(base64.split(',')[1]);
            const mimeString = base64.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
        }
        async function blobToDataURL(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(reader.error);
                reader.readAsDataURL(blob);
            });
        }

        exportBtn.addEventListener('click', async () => {
            if (courses.length === 0) {
                return showToast("There are no courses to export.", true);
            }
            exportBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Exporting...`;
            exportBtn.disabled = true;

            try {
                const zip = new JSZip();
                const serializableCourses = [];
                const serializableProgress = [];
                const allProgress = await new Promise(r => getStore(PROGRESS_STORE, 'readonly').getAll().onsuccess = e => r(e.target.result));
                
                for (const course of courses) {
                    const cleanCourse = { ...course };
                    delete cleanCourse.handle; 
                    delete cleanCourse.lectures; 
                    if(course.handle) cleanCourse.folderName = course.handle.name;
                    
                    if (course.thumbnail) {
                        const thumbBlob = base64ToBlob(course.thumbnail);
                        const thumbFilename = `thumb_${course.id}.png`;
                        zip.folder('thumbnails').file(thumbFilename, thumbBlob);
                        cleanCourse.thumbnailFilename = thumbFilename;
                    }
                    delete cleanCourse.thumbnail;
                    serializableCourses.push(cleanCourse);
                }

                for (const progress of allProgress) {
                    const cleanProgress = { ...progress };
                    if (progress.pdfHandle) {
                        const pdfFilename = `pdf_${progress.id}.pdf`;
                        zip.folder('pdfs').file(pdfFilename, progress.pdfHandle);
                        cleanProgress.pdfFilename = pdfFilename;
                    }
                     if (progress.assignmentHandle) {
                        const assignFilename = `assign_${progress.id}_${progress.assignmentName}`;
                        zip.folder('assignments').file(assignFilename, progress.assignmentHandle);
                        cleanProgress.assignmentFilename = assignFilename;
                    }
                    delete cleanProgress.pdfHandle;
                    delete cleanProgress.assignmentHandle;
                    serializableProgress.push(cleanProgress);
                }

                // Export DPPs
                const allDpps = await new Promise(r => getStore(DPP_STORE, 'readonly').getAll().onsuccess = e => r(e.target.result));
                const serializableDpps = [];
                for (const dpp of allDpps) {
                    const cleanDpp = {...dpp};
                    if (dpp.fileHandle) {
                        const dppFilename = `dpp_${dpp.id}_${dpp.fileName}`;
                        zip.folder('dpps').file(dppFilename, dpp.fileHandle);
                        cleanDpp.dppFilename = dppFilename;
                    }
                    delete cleanDpp.fileHandle;
                    serializableDpps.push(cleanDpp);
                }

                const backupData = {
                    courses: serializableCourses,
                    progress: serializableProgress,
                    dpps: serializableDpps,
                    version: 2,
                    exportedAt: new Date().toISOString()
                };

                zip.file("backup.json", JSON.stringify(backupData, null, 2));
                const zipBlob = await zip.generateAsync({ type: "blob" });
                downloadBlob(zipBlob, `CourseFlix_Backup_${new Date().toISOString().split('T')[0]}.zip`);
                showToast("Export successful!");

            } catch (err) {
                console.error("Export failed:", err);
                showToast("Export failed. Check the console for errors.", true);
            } finally {
                exportBtn.innerHTML = `<i class="fas fa-file-export"></i> Export Backup`;
                exportBtn.disabled = false;
            }
        });

        importBtn.addEventListener('click', () => {
            importZipInput.click();
        });

        importZipInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const importModal = document.getElementById('import-modal-overlay');
            const importModalContent = document.getElementById('import-modal-content');
            importModalContent.innerHTML = `<h2><i class="fas fa-spinner fa-spin"></i> Reading Backup...</h2>`;
            importModal.classList.remove('hidden');

            try {
                const zip = await JSZip.loadAsync(file);
                const backupFile = zip.file('backup.json');
                if (!backupFile) {
                    throw new Error('Invalid backup file: backup.json not found.');
                }
                const backupData = JSON.parse(await backupFile.async('string'));
                showImportRelinkModal(backupData, zip);
            } catch (err) {
                console.error("Import failed:", err);
                showToast(`Import failed: ${err.message}`, true);
                importModal.classList.add('hidden');
            } finally {
                e.target.value = null; 
            }
        });
        
        function showImportRelinkModal(backupData, zip) {
            const importModalContent = document.getElementById('import-modal-content');
            let courseLinksHTML = backupData.courses.map(c => `
                <div class="import-course-link-item" data-course-id="${c.id}" data-folder-name="${c.folderName || ''}">
                    <span class="import-course-title">${c.folderName || c.title}</span>
                    <div class="status-container">
                        ${c.folderName ? `<button class="primary-btn link-folder-btn" data-course-id="${c.id}">Select Folder</button>` : `<span class="status">OK</span>`}
                    </div>
                </div>
            `).join('');

            importModalContent.innerHTML = `
                <button class="close-modal-btn" title="Close">&times;</button>
                <h2>Link Course Folders</h2>
                <p style="color: var(--text-secondary); margin: -0.5rem 0 0.5rem 0;">Select a master folder to link all courses automatically, or link them individually.</p>
                <button id="select-master-folder" class="secondary-btn"><i class="fas fa-folder-tree"></i> Select Master Folder</button>
                <div class="modal-content-scrollable" style="margin-top:1rem;">
                    ${courseLinksHTML}
                </div>
                <button id="import-final-btn" class="primary-btn" disabled>Start Import</button>
                <div id="import-status-message"></div>
            `;
            
            const linkedHandles = {};
            const coursesThatNeedLinks = backupData.courses.filter(c => c.folderName);
            const coursesToLinkCount = coursesThatNeedLinks.length;
            let linkedCount = 0;

            const checkAllLinked = () => {
                const allLinked = linkedCount >= coursesToLinkCount;
                document.getElementById('import-final-btn').disabled = !allLinked;
            };
            checkAllLinked();

            importModalContent.querySelector('.close-modal-btn').onclick = () => {
                document.getElementById('import-modal-overlay').classList.add('hidden');
            };

            importModalContent.querySelector('#select-master-folder').onclick = async () => {
                try {
                    const masterHandle = await window.showDirectoryPicker();
                    for await (const courseItem of coursesThatNeedLinks) {
                        try {
                            const courseHandle = await masterHandle.getDirectoryHandle(courseItem.folderName, { create: false });
                            const courseId = courseItem.id;
                            if (!linkedHandles[courseId]) { // Don't override manual selections
                                linkedHandles[courseId] = courseHandle;
                                const itemEl = importModalContent.querySelector(`.import-course-link-item[data-course-id="${courseId}"] .status-container`);
                                if (itemEl) {
                                    itemEl.innerHTML = `<span class="status">✅ Auto-Linked</span>`;
                                    linkedCount++;
                                }
                            }
                        } catch (e) {
                            console.warn(`Could not find folder "${courseItem.folderName}" in master directory.`);
                        }
                    }
                    checkAllLinked();
                } catch(e) { console.log('User cancelled master folder picker.'); }
            };

            importModalContent.querySelectorAll('.link-folder-btn').forEach(btn => {
                btn.onclick = async () => {
                    try {
                        const handle = await window.showDirectoryPicker();
                        const courseId = btn.dataset.courseId;
                        if (!linkedHandles[courseId]) linkedCount++;
                        linkedHandles[courseId] = handle;
                        btn.parentElement.innerHTML = `<span class="status">✅ Linked</span>`;
                        checkAllLinked();
                    } catch (err) {
                        console.log("User cancelled folder picker.");
                    }
                };
            });

            document.getElementById('import-final-btn').onclick = async () => {
                if (!confirm("This will overwrite all current courses and progress. Are you sure you want to continue?")) return;
                await processImport(backupData, zip, linkedHandles);
            };
        }
        
        async function processImport(backupData, zip, linkedHandles) {
            const statusMsg = document.getElementById('import-status-message');
            statusMsg.textContent = 'Importing... Please wait.';
            document.getElementById('import-final-btn').disabled = true;

            try {
                await Promise.all([
                    new Promise(r => getStore(STORE_NAME, 'readwrite').clear().onsuccess = r),
                    new Promise(r => getStore(PROGRESS_STORE, 'readwrite').clear().onsuccess = r),
                    new Promise(r => getStore(DPP_STORE, 'readwrite').clear().onsuccess = r)
                ]);

                for (const course of backupData.courses) {
                    statusMsg.textContent = `Importing course: ${course.title}...`;
                    const newCourse = { ...course };
                    if (course.folderName) {
                        newCourse.handle = linkedHandles[course.id];
                        if (!newCourse.handle) throw new Error(`Folder for ${course.title} was not linked.`);
                    }
                    if (course.thumbnailFilename) {
                        const thumbFile = zip.file(`thumbnails/${course.thumbnailFilename}`);
                        if (thumbFile) newCourse.thumbnail = await blobToDataURL(await thumbFile.async('blob'));
                    }
                    await new Promise(r => getStore(STORE_NAME, 'readwrite').put(newCourse).onsuccess = r);
                }

                for (const progress of backupData.progress) {
                    statusMsg.textContent = `Importing progress...`;
                    const newProgress = { ...progress };
                    if (progress.pdfFilename) {
                        const pdfFile = zip.file(`pdfs/${progress.pdfFilename}`);
                        if (pdfFile) newProgress.pdfHandle = new File([await pdfFile.async('blob')], progress.pdfName, { type: 'application/pdf' });
                    }
                     if (progress.assignmentFilename) {
                        const assignFile = zip.file(`assignments/${progress.assignmentFilename}`);
                        if (assignFile) {
                            const blob = await assignFile.async('blob');
                            const type = progress.assignmentType || 'application/octet-stream';
                            newProgress.assignmentHandle = new File([blob], progress.assignmentName, { type });
                        }
                    }
                    await new Promise(r => getStore(PROGRESS_STORE, 'readwrite').put(newProgress).onsuccess = r);
                }

                if (backupData.dpps) {
                    for (const dpp of backupData.dpps) {
                        statusMsg.textContent = `Importing DPPs...`;
                        const newDpp = { ...dpp };
                        if (dpp.dppFilename) {
                            const dppFile = zip.file(`dpps/${dpp.dppFilename}`);
                            if (dppFile) {
                                const blob = await dppFile.async('blob');
                                newDpp.fileHandle = new File([blob], dpp.fileName, { type: 'application/pdf' });
                            }
                        }
                        await new Promise(r => getStore(DPP_STORE, 'readwrite').put(newDpp).onsuccess = r);
                    }
                }

                statusMsg.textContent = 'Import complete! Reloading...';
                showToast("Import successful! Your library has been restored.");
                
                setTimeout(async () => {
                    document.getElementById('import-modal-overlay').classList.add('hidden');
                    document.getElementById('modal-overlay').classList.add('hidden');
                    await loadAllProgress();
                    await loadCoursesFromDB();
                    switchView('dashboard-view');
                }, 1500);

            } catch (err) {
                console.error("Error during final import stage:", err);
                statusMsg.textContent = `Error: ${err.message}`;
                showToast(`Import failed: ${err.message}`, true);
            }
        }

        // --- Video Player Controls ---
        unmuteBtn.addEventListener('click', () => {
            videoPlayer.muted = false;
            unmuteBtn.classList.add('hidden');
        });
        const showSeekIcon = (overlay) => { overlay.classList.add('show-icon'); setTimeout(() => overlay.classList.remove('show-icon'), 500); };
        playPauseBtn.addEventListener('click', () => videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause());
        videoPlayer.addEventListener('play', () => playPauseBtn.innerHTML = `<i class="fas fa-pause"></i>`);
        videoPlayer.addEventListener('pause', () => playPauseBtn.innerHTML = `<i class="fas fa-play"></i>`);
        videoWrapper.addEventListener('click', (e) => { if (e.target.closest('.video-controls-container') || e.target.closest('#unmute-btn') || e.target.closest('.bookmark-dot')) return; if (clickTimer) { clearTimeout(clickTimer); clickTimer = null; } clickTimer = setTimeout(() => { if (!e.target.closest('#media-viewer')) playPauseBtn.click(); }, 250); });
        videoWrapper.addEventListener('dblclick', (e) => { if (e.target.closest('.video-controls-container') || e.target.closest('#media-viewer')) return; clearTimeout(clickTimer); clickTimer = null; const r=videoWrapper.getBoundingClientRect(),c=e.clientX-r.left;if(c<r.width/2){videoPlayer.currentTime-=10;showSeekIcon(leftSeekOverlay)}else{videoPlayer.currentTime+=10;showSeekIcon(rightSeekOverlay)}});
        videoPlayer.addEventListener('timeupdate', () => { 
            const currentTime = videoPlayer.currentTime;
            document.getElementById('current-time').textContent = formatTime(currentTime); 
            if (!isNaN(videoPlayer.duration)) { 
                const duration = videoPlayer.duration;
                timeline.value = currentTime; 
                const p = (currentTime / duration) * 100; 
                timeline.style.background = `linear-gradient(to right, var(--accent-primary) ${p}%, rgba(255, 255, 255, 0.3) ${p}%)`;
            } 
        });
        videoPlayer.addEventListener('loadedmetadata', () => { document.getElementById('video-duration').textContent = formatTime(videoPlayer.duration); timeline.max = videoPlayer.duration; });
        timeline.addEventListener('input', (e) => videoPlayer.currentTime = e.target.value);
        fullscreenBtn.addEventListener('click', () => { if (!document.fullscreenElement) playerView.requestFullscreen().catch(err => showToast(`Error: ${err.message}`, true)); else document.exitFullscreen(); });
        
        const speeds = [1, 1.25, 1.5, 1.75, 2, 2.25, 2.5, 0.75]; let currentSpeedIndex = 0;
        speedBtn.addEventListener('click', () => {
            currentSpeedIndex = (currentSpeedIndex + 1) % speeds.length;
            videoPlayer.playbackRate = speeds[currentSpeedIndex];
            speedBtn.textContent = `${speeds[currentSpeedIndex]}x`;
        });
        
        document.addEventListener('keydown', (e) => { 
            const activeModal = document.querySelector('.modal-overlay:not(.hidden)');
            if (activeModal) {
                 if (e.key === 'Escape') {
                     activeModal.classList.add('hidden');
                }
                return;
            }

            const activeInput = document.querySelector('input:focus, textarea:focus');
             if (activeInput) {
                 if (e.key === 'Escape') {
                     activeInput.blur();
                 }
                 return; 
             }

            const view = document.querySelector('.view.active'); 
            if (!view || !['player-view', 'dpp-view', 'notes-view'].includes(view.id)) return;
            
            userInteracted = true; 
            videoPlayer.muted = false; 
            unmuteBtn.classList.add('hidden'); 

            let shouldPreventDefault = true;
            switch(e.key) { 
                case ' ': if (view.id === 'player-view') playPauseBtn.click(); break;
                case 'ArrowRight': if (view.id === 'player-view') videoPlayer.currentTime += 5; break;
                case 'ArrowLeft': if (view.id === 'player-view') videoPlayer.currentTime -= 5; break; 
                case 'ArrowUp': if (view.id === 'player-view') videoPlayer.volume = Math.min(1, videoPlayer.volume + 0.1); break;
                case 'ArrowDown': if (view.id === 'player-view') videoPlayer.volume = Math.max(0, videoPlayer.volume - 0.1); break;
                case ']': if (view.id === 'player-view') speedBtn.click(); break;
                case '[': 
                    if (view.id === 'player-view') {
                        currentSpeedIndex = (currentSpeedIndex - 2 + speeds.length) % speeds.length;
                        speedBtn.click();
                    }
                    break;
                case 'f': if (view.id === 'player-view') fullscreenBtn.click(); break;
                case 'Escape': 
                    if (document.fullscreenElement) {
                         document.exitFullscreen();
                    } else if (view.id === 'player-view' && !lectureMenu.classList.contains('hidden')) {
                        sidebarToggleBtn.click();
                    } else if (view.id === 'dpp-view' && !document.getElementById('dpp-sidebar').classList.contains('hidden')) {
                        document.getElementById('dpp-sidebar-toggle-btn').click();
                    } else if (view.id === 'notes-view' && !document.getElementById('notes-sidebar').classList.contains('hidden')) {
                        document.getElementById('notes-sidebar-toggle-btn').click();
                    }
                    break; 
                case 'b': if (view.id === 'player-view') addBookmark(); break;
                case 'c': if (view.id === 'player-view') clearCurrentVideoBookmarks(); break;
                default: shouldPreventDefault = false; break;
            } 
            if (shouldPreventDefault) e.preventDefault();
        });
        
        mediaResizeHandle.addEventListener('mousedown', (e) => { e.preventDefault(); isResizing = true; document.body.style.cursor = 'ew-resize'; playerView.style.userSelect = 'none'; });
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return; e.preventDefault(); const totalWidth = playerView.offsetWidth;
            const menuWidth = lectureMenu.classList.contains('hidden') ? 0 : lectureMenu.offsetWidth;
            let newViewerWidth = totalWidth - e.clientX;
            newViewerWidth = Math.max(300, newViewerWidth);
            newViewerWidth = Math.min(totalWidth - 300 - menuWidth, newViewerWidth);
            playerView.style.setProperty('--viewer-width', `${newViewerWidth}px`);
            mediaViewer.style.width = `${newViewerWidth}px`;
        });
        document.addEventListener('mouseup', () => {
            if (isResizing) {
                localStorage.setItem('viewerWidth', mediaViewer.style.width);
                isResizing = false;
                document.body.style.cursor = '';
                playerView.style.userSelect = '';
            }
        });

        // --- Bookmark Functions ---
        function renderBookmarks() {
            bookmarksContainer.innerHTML = '';
            if (!currentCourse || !currentLectureLi || isNaN(videoPlayer.duration)) return;

            const lectureId = currentLectureLi.dataset.lectureId;
            const progress = getLectureProgress(currentCourse.id, lectureId);
            const bookmarks = progress.bookmarks || [];

            bookmarks.forEach(time => {
                const dot = document.createElement('div');
                dot.className = 'bookmark-dot';
                dot.style.left = `${(time / videoPlayer.duration) * 100}%`;
                dot.title = `Bookmark at ${formatTime(time)}`;
                dot.onclick = (e) => {
                    e.stopPropagation();
                    videoPlayer.currentTime = time;
                };
                bookmarksContainer.appendChild(dot);
            });
        }

        async function addBookmark() {
            if (!currentCourse || !currentLectureLi || videoPlayer.seeking) return;
            const lectureId = currentLectureLi.dataset.lectureId;
            const progress = getLectureProgress(currentCourse.id, lectureId);
            const bookmarks = progress.bookmarks || [];
            const currentTime = videoPlayer.currentTime;

            if (!bookmarks.some(b => Math.abs(b - currentTime) < 1)) { // Avoid duplicate bookmarks
                bookmarks.push(currentTime);
                bookmarks.sort((a, b) => a - b);
                await saveLectureProgress({ ...progress, courseId: currentCourse.id, lectureId, bookmarks });
                renderBookmarks();
                showToast(`Bookmark added at ${formatTime(currentTime)}`);
            }
        }

        async function clearCurrentVideoBookmarks() {
            if (!currentCourse || !currentLectureLi) return;
             if (confirm('Are you sure you want to clear all bookmarks for this video?')) {
                const lectureId = currentLectureLi.dataset.lectureId;
                const progress = getLectureProgress(currentCourse.id, lectureId);
                await saveLectureProgress({ ...progress, courseId: currentCourse.id, lectureId, bookmarks: [] });
                renderBookmarks();
                showToast('Bookmarks cleared for this video.');
            }
        }
        
        clearBookmarksBtn.addEventListener('click', async () => {
             if (!currentCourse) return;
             if (confirm(`Are you sure you want to clear ALL bookmarks for the course "${currentCourse.title}"? This cannot be undone.`)) {
                 for (const lecture of currentCourse.lectures) {
                     const progress = getLectureProgress(currentCourse.id, lecture.id);
                     if (progress.bookmarks && progress.bookmarks.length > 0) {
                         progress.bookmarks = [];
                         await saveLectureProgress(progress);
                     }
                 }
                 renderBookmarks(); // Clear for current video
                 showToast(`All bookmarks for "${currentCourse.title}" have been cleared.`);
             }
        });

        // --- DPP Functions ---
        async function renderDppCourseSelectionView() {
            nav.classList.remove('hidden');
            const dppCourseGrid = document.getElementById('dpp-course-grid');
            document.getElementById('dpp-detail-container').classList.add('hidden');
            dppCourseGrid.classList.remove('hidden');

            const allDpps = await new Promise(r => getStore(DPP_STORE, 'readonly').getAll().onsuccess = e => r(e.target.result));
            const courseIdsWithDpps = [...new Set(allDpps.map(dpp => dpp.courseId))];
            const coursesWithDpps = courses.filter(c => courseIdsWithDpps.includes(c.id));

            dppCourseGrid.innerHTML = '';
            if (coursesWithDpps.length === 0) {
                dppCourseGrid.innerHTML = `<p id="no-content-message">No DPPs uploaded for any course yet. Go to the Upload tab to add some.</p>`;
                return;
            }

            coursesWithDpps.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';
                card.dataset.courseId = course.id;
                card.innerHTML = `
                    <div class="thumbnail-placeholder ${course.thumbnail ? 'has-thumbnail' : ''}" style="${course.thumbnail ? `background-image: url('${course.thumbnail}')` : ''}">
                        <i class="fas fa-file-invoice" style="font-size: 3rem;"></i>
                    </div>
                    <div class="course-info">
                        <h3>${course.title}</h3>
                        <p class="course-meta">${allDpps.filter(d => d.courseId === course.id).length} DPPs</p>
                        <button class="enter-course-btn" style="margin-top: auto;">View DPPs</button>
                    </div>`;
                dppCourseGrid.appendChild(card);
            });
        }


        async function renderDppDetailView(courseId) {
            nav.classList.add('hidden');
            const course = courses.find(c => c.id === courseId);
            if (!course) {
                showToast("Error: Course not found.", true);
                switchView('dpp-view'); // Go back to course selection
                return;
            };

            document.getElementById('dpp-course-grid').classList.add('hidden');
            const detailContainer = document.getElementById('dpp-detail-container');
            detailContainer.dataset.courseId = courseId;
            detailContainer.classList.remove('hidden');
            
            document.getElementById('dpp-detail-course-title').textContent = course.title;
            const dppListContainer = document.getElementById('dpp-list-container');
            const allDpps = await new Promise(r => getStore(DPP_STORE, 'readonly').getAll().onsuccess = e => r(e.target.result));
            const courseDpps = allDpps.filter(dpp => dpp.courseId === courseId);

            if (courseDpps.length === 0) {
                dppListContainer.innerHTML = `<p id="no-content-message">No DPPs uploaded for this course yet.</p>`;
                return;
            }

            const groupedByFolder = courseDpps.reduce((acc, dpp) => {
                const folder = dpp.folderName || 'Uncategorized';
                (acc[folder] = acc[folder] || []).push(dpp);
                return acc;
            }, {});

            let html = '';
            const sortedFolders = Object.keys(groupedByFolder).sort();

            for (const folderName of sortedFolders) {
                html += `<div class="dpp-folder-group open">`; // Start open by default
                if (folderName !== 'Uncategorized') {
                     html += `<div class="dpp-folder-title"><i class="fas fa-chevron-right"></i> <span>${folderName}</span></div>`;
                }
                
                html += `<div class="dpp-list">`;
                groupedByFolder[folderName].sort((a,b) => naturalSort({name: a.fileName}, {name: b.fileName})).forEach(dpp => {
                    const statusClass = dpp.status || '';
                    html += `
                        <div class="dpp-item" data-dpp-id="${dpp.id}">
                            <span class="dpp-item-title ${dpp.completed ? 'completed' : ''}">${dpp.fileName}</span>
                            <div class="dpp-item-controls">
                                <button class="file-btn dpp-item-btn dpp-status-btn ${statusClass}" title="Cycle Status">${dpp.status ? dpp.status.toUpperCase() : 'STATUS'}</button>
                                <button class="file-btn dpp-item-btn star-dpp-btn ${dpp.starred ? 'starred' : ''}" title="Star DPP"><i class="fas fa-star"></i></button>
                                <button class="file-btn dpp-item-btn complete-dpp-btn ${dpp.completed ? 'completed' : ''}" title="Mark as Complete"><i class="fas fa-check"></i></button>
                                <button class="file-btn dpp-item-btn delete-dpp-btn" title="Delete DPP"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            dppListContainer.innerHTML = html;
        }


        async function renderDppUploadView(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;

            const view = document.getElementById('dpp-upload-view');
            view.dataset.courseId = courseId;

            document.getElementById('dpp-upload-course-title').textContent = course.title;
            const folderList = document.getElementById('dpp-folder-list');

            let folderHTML = `<div class="dpp-folder-item selected" data-folder-name="">
                <span><i class="fas fa-folder"></i> No Folder (Root)</span>
            </div>`;

            if (course.dppFolders && course.dppFolders.length > 0) {
                folderHTML += course.dppFolders.sort().map(folder => `
                    <div class="dpp-folder-item" data-folder-name="${folder}">
                        <span><i class="fas fa-folder"></i> ${folder}</span>
                        <button class="file-btn delete-dpp-folder-btn" title="Delete folder" data-folder-name="${folder}"><i class="fas fa-trash"></i></button>
                    </div>
                `).join('');
            }
            folderList.innerHTML = folderHTML;

            folderList.querySelectorAll('.dpp-folder-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-dpp-folder-btn')) return;
                    folderList.querySelectorAll('.dpp-folder-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                });
            });
        }
        
        async function addDppFolder(courseId, folderName) {
            folderName = folderName.trim();
            if (!folderName) {
                showToast("Folder name cannot be empty.", true);
                return;
            }
            const course = courses.find(c => c.id === courseId);
            if (!course) return;

            if (!course.dppFolders) course.dppFolders = [];
            if (course.dppFolders.includes(folderName)) {
                showToast(`Folder "${folderName}" already exists.`, true);
                return;
            }

            course.dppFolders.push(folderName);
            await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(course).onsuccess = resolve);
            await renderDppUploadView(courseId);
        }

        async function deleteDppFolder(courseId, folderName) {
            if (!confirm(`Are you sure you want to delete the folder "${folderName}"? DPPs inside will be moved to the root.`)) return;
            
            const course = courses.find(c => c.id === courseId);
            if (!course || !course.dppFolders) return;
            
            course.dppFolders = course.dppFolders.filter(f => f !== folderName);
            await new Promise(resolve => getStore(STORE_NAME, 'readwrite').put(course).onsuccess = resolve);

            const allDpps = await new Promise(r => getStore(DPP_STORE, 'readonly').getAll().onsuccess = e => r(e.target.result));
            const dppsToUpdate = allDpps.filter(dpp => dpp.courseId === courseId && dpp.folderName === folderName);
            
            const tx = db.transaction(DPP_STORE, 'readwrite');
            const store = tx.objectStore(DPP_STORE);
            for(const dpp of dppsToUpdate) {
                dpp.folderName = ''; // Move to root
                store.put(dpp);
            }
            await new Promise(r => tx.oncomplete = r);
            await renderDppUploadView(courseId);
        }

        // --- DPP & Upload Listeners ---
        document.getElementById('back-to-upload-from-dpp').addEventListener('click', () => switchView('upload-view'));
        document.getElementById('back-to-upload-grid').addEventListener('click', () => switchView('upload-view'));

        
        const dppSidebarToggleBtn = document.getElementById('dpp-sidebar-toggle-btn');
        dppSidebarToggleBtn.addEventListener('click', () => {
            document.getElementById('dpp-sidebar').classList.toggle('hidden');
            dppSidebarToggleBtn.classList.toggle('collapsed');
        });

        const dppUploadSidebarToggleBtn = document.getElementById('dpp-upload-sidebar-toggle-btn');
        dppUploadSidebarToggleBtn.addEventListener('click', () => {
            document.getElementById('dpp-upload-sidebar').classList.toggle('hidden');
            dppUploadSidebarToggleBtn.classList.toggle('collapsed');
        });

        const newDppFolderNameInput = document.getElementById('new-dpp-folder-name');
        const addDppFolderBtn = document.getElementById('add-dpp-folder-btn');
        const dppFolderList = document.getElementById('dpp-folder-list');

        const handleAddDppFolder = async () => {
            const courseId = parseInt(document.getElementById('dpp-upload-view').dataset.courseId);
            const folderName = newDppFolderNameInput.value;
            if (folderName && courseId) {
                await addDppFolder(courseId, folderName);
                newDppFolderNameInput.value = '';
            }
        };

        addDppFolderBtn.addEventListener('click', handleAddDppFolder);
        newDppFolderNameInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleAddDppFolder();
            }
        });

        dppFolderList.addEventListener('click', e => {
            const deleteBtn = e.target.closest('.delete-dpp-folder-btn');
            if (deleteBtn) {
                e.stopPropagation();
                const courseId = parseInt(document.getElementById('dpp-upload-view').dataset.courseId);
                const folderName = deleteBtn.dataset.folderName;
                deleteDppFolder(courseId, folderName);
            }
        });
        
        const dppDropZone = document.getElementById('dpp-upload-drop-zone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dppDropZone.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        dppDropZone.addEventListener('dragenter', () => dppDropZone.classList.add('dragover'));
        dppDropZone.addEventListener('dragover', () => dppDropZone.classList.add('dragover'));
        dppDropZone.addEventListener('dragleave', () => dppDropZone.classList.remove('dragover'));
        dppDropZone.addEventListener('drop', async (e) => {
            dppDropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (!files || files.length === 0) return;

            const courseId = parseInt(document.getElementById('dpp-upload-view').dataset.courseId);
            const selectedFolderEl = document.querySelector('#dpp-folder-list .dpp-folder-item.selected');
            const folderName = selectedFolderEl ? selectedFolderEl.dataset.folderName : '';

            const tx = db.transaction(DPP_STORE, 'readwrite');
            const store = tx.objectStore(DPP_STORE);
            let uploadedCount = 0;

            for (const file of files) {
                const dpp = {
                    courseId: courseId,
                    folderName: folderName,
                    fileName: file.name.replace(/\.[^/.]+$/, ""),
                    fileHandle: file,
                    completed: false,
                    starred: false,
                    status: null
                };
                store.add(dpp);
                uploadedCount++;
            }
            await new Promise(r => tx.oncomplete = r);
            
            if(uploadedCount > 0) {
                showToast(`${uploadedCount} DPP(s) uploaded successfully!`);
            }
        });

        document.getElementById('dpp-list-container').addEventListener('click', async (e) => {
            const folderTitle = e.target.closest('.dpp-folder-title');
            if (folderTitle) {
                e.stopPropagation();
                folderTitle.parentElement.classList.toggle('open');
                return;
            }

            const dppItem = e.target.closest('.dpp-item');
            if (!dppItem) return;
            
            const dppId = parseInt(dppItem.dataset.dppId);
            const dpp = await new Promise(r => getStore(DPP_STORE, 'readonly').get(dppId).onsuccess = e => r(e.target.result));
            if (!dpp) return;

            // Handle button clicks
            if (e.target.closest('.delete-dpp-btn')) {
                e.stopPropagation();
                if (confirm(`Are you sure you want to delete the DPP "${dpp.fileName}"?`)) {
                    await new Promise(r => getStore(DPP_STORE, 'readwrite').delete(dppId).onsuccess = r);
                    const courseId = parseInt(document.getElementById('dpp-detail-container').dataset.courseId);
                    await renderDppDetailView(courseId);
                }
            } else if (e.target.closest('.complete-dpp-btn')) {
                e.stopPropagation();
                dpp.completed = !dpp.completed;
                await new Promise(r => getStore(DPP_STORE, 'readwrite').put(dpp).onsuccess = r);
                e.target.closest('.complete-dpp-btn').classList.toggle('completed', dpp.completed);
                dppItem.querySelector('.dpp-item-title').classList.toggle('completed', dpp.completed);
            } else if (e.target.closest('.star-dpp-btn')) {
                e.stopPropagation();
                dpp.starred = !dpp.starred;
                await new Promise(r => getStore(DPP_STORE, 'readwrite').put(dpp).onsuccess = r);
                e.target.closest('.star-dpp-btn').classList.toggle('starred', dpp.starred);
            } else if (e.target.closest('.dpp-status-btn')) {
                e.stopPropagation();
                const statuses = [null, 'doubt', 'fail', 'solved'];
                const currentIndex = statuses.indexOf(dpp.status);
                const nextIndex = (currentIndex + 1) % statuses.length;
                dpp.status = statuses[nextIndex];
                await new Promise(r => getStore(DPP_STORE, 'readwrite').put(dpp).onsuccess = r);
                
                const btn = e.target.closest('.dpp-status-btn');
                btn.className = 'file-btn dpp-item-btn dpp-status-btn'; // reset classes
                if (dpp.status) {
                    btn.classList.add(dpp.status);
                    btn.textContent = dpp.status.toUpperCase();
                } else {
                    btn.textContent = 'STATUS';
                }
            } else { // Click on the item itself to view
                document.querySelectorAll('#dpp-list-container .dpp-item').forEach(item => item.classList.remove('active'));
                dppItem.classList.add('active');
                await showMediaViewer(dpp.fileHandle, 'dpp', dpp.fileName, null);
            }
        });

        async function handleLectureFileDrop(files, type) {
            const selectedLectureEl = document.querySelector('#upload-lecture-list .lecture-item.selected');
            if (!selectedLectureEl) {
                showToast('Please select a lecture from the list first!', true);
                return;
            }
            if (files.length > 1) {
                showToast('Please drop only one file at a time.', true);
                return;
            }
            
            const file = files[0];
            const courseId = parseInt(document.getElementById('upload-detail-view').dataset.courseId);
            const lectureId = selectedLectureEl.dataset.lectureId;
            const progressData = getLectureProgress(courseId, lectureId);

            if (type === 'pdf') {
                if (!file.name.toLowerCase().endsWith('.pdf')) {
                    showToast('Only PDF files are allowed for notes.', true);
                    return;
                }
                await saveLectureProgress({ ...progressData, pdfHandle: file, pdfName: file.name, courseId, lectureId });
            } else if (type === 'assignment') {
                await saveLectureProgress({ ...progressData, assignmentHandle: file, assignmentName: file.name, assignmentType: file.type, courseId, lectureId });
            }

            showToast(`${type === 'pdf' ? 'Notes' : 'Assignment'} for "${selectedLectureEl.textContent.trim()}" added successfully!`);
            
            const existingProgress = getLectureProgress(courseId, lectureId);
            const statusDiv = selectedLectureEl.querySelector('.file-status');
            statusDiv.innerHTML = `
                ${existingProgress.pdfHandle ? '<i class="fas fa-file-pdf" title="Notes added"></i>' : ''}
                ${existingProgress.assignmentHandle ? '<i class="fas fa-file-alt" title="Assignment added"></i>' : ''}
            `;
        }
        
        const pdfDropZone = document.getElementById('pdf-drop-zone');
        const assignmentDropZone = document.getElementById('assignment-drop-zone');
        [pdfDropZone, assignmentDropZone].forEach(zone => {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
            });
            zone.addEventListener('dragenter', () => zone.classList.add('dragover'));
            zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
            zone.addEventListener('drop', async (e) => {
                zone.classList.remove('dragover');
                await handleLectureFileDrop(e.dataTransfer.files, zone.dataset.type);
            });
        });
        
        // --- Notes Functions ---
        async function renderNotesCourseSelectionView() {
            nav.classList.remove('hidden');
            const notesCourseGrid = document.getElementById('notes-course-grid');
            document.getElementById('notes-detail-container').classList.add('hidden');
            notesCourseGrid.classList.remove('hidden');

            const notesProgress = Object.values(courseProgress).filter(p => p.pdfHandle);
            const courseIdsWithNotes = [...new Set(notesProgress.map(p => p.courseId))];
            const coursesWithNotes = courses.filter(c => courseIdsWithNotes.includes(c.id));

            notesCourseGrid.innerHTML = '';
            if (coursesWithNotes.length === 0) {
                notesCourseGrid.innerHTML = `<p id="no-content-message">No notes uploaded for any course yet. Go to the Upload tab to add some.</p>`;
                return;
            }

            coursesWithNotes.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';
                card.dataset.courseId = course.id;

                const notesCount = notesProgress.filter(p => p.courseId === course.id).length;
                 const ratingStarsHTML = Array.from({length: 5}, (_, i) => 
                    `<i class="fa-star ${ (course.rating || 0) > i ? 'fas' : 'far'}"></i>`
                ).join('');


                card.innerHTML = `
                    <div class="thumbnail-placeholder ${course.thumbnail ? 'has-thumbnail' : ''}" style="${course.thumbnail ? `background-image: url('${course.thumbnail}')` : ''}">
                        <i class="fas fa-book-open" style="font-size: 3rem;"></i>
                    </div>
                    <div class="course-info">
                         <div>
                            <h3 title="${course.title}">${course.title}</h3>
                            <div class="course-extra-info">
                                <div class="course-faculty">${course.facultyName || 'N/A Faculty'}</div>
                                <div class="course-rating" style="pointer-events: none;">${ratingStarsHTML}</div>
                            </div>
                            <p class="course-meta">${notesCount} class notes</p>
                        </div>
                        <button class="enter-course-btn" style="margin-top: auto;">View Notes</button>
                    </div>`;
                notesCourseGrid.appendChild(card);
            });
        }

        async function renderNotesDetailView(courseId) {
            nav.classList.add('hidden');
            const course = courses.find(c => c.id === courseId);
             if (!course) {
                showToast("Error: Course not found.", true);
                switchView('notes-view');
                return;
            };

            // Ensure lectures are loaded for chapter info
            if (course.isLinked && course.handle && !course.lectures) {
               await refreshCourse(course.id, null);
            }

            document.getElementById('notes-course-grid').classList.add('hidden');
            const detailContainer = document.getElementById('notes-detail-container');
            detailContainer.dataset.courseId = courseId;
            detailContainer.classList.remove('hidden');
            
            document.getElementById('notes-detail-course-title').textContent = course.title;
            const notesListContainer = document.getElementById('notes-list-container');
            
            const courseNotes = Object.values(courseProgress).filter(p => p.courseId === courseId && p.pdfHandle);

            if (courseNotes.length === 0 || !course.chapters) {
                notesListContainer.innerHTML = `<p id="no-content-message">No notes found for this course.</p>`;
                return;
            }
            
            let html = '';
            course.chapters.forEach(chapter => {
                const notesInChapter = courseNotes.filter(note => {
                    return chapter.lectures.some(lec => lec.id === note.lectureId);
                });

                if (notesInChapter.length > 0) {
                    html += `<div class="notes-folder-group open">
                                <div class="notes-folder-title"><i class="fas fa-chevron-right"></i> <span>${chapter.name}</span></div>
                                <div class="notes-list">`;
                    
                    notesInChapter.forEach(note => {
                        html += `<div class="notes-item" data-lecture-id="${note.lectureId}">
                                    <span class="notes-item-title">${note.lectureName || 'Unnamed Note'}</span>
                                 </div>`;
                    });

                    html += `</div></div>`;
                }
            });
            notesListContainer.innerHTML = html;
        }

        const notesSidebarToggleBtn = document.getElementById('notes-sidebar-toggle-btn');
        notesSidebarToggleBtn.addEventListener('click', () => {
            document.getElementById('notes-sidebar').classList.toggle('hidden');
            notesSidebarToggleBtn.classList.toggle('collapsed');
        });

        document.getElementById('notes-list-container').addEventListener('click', async (e) => {
            const folderTitle = e.target.closest('.notes-folder-title');
            if (folderTitle) {
                e.stopPropagation();
                folderTitle.parentElement.classList.toggle('open');
                return;
            }

            const noteItem = e.target.closest('.notes-item');
            if(noteItem) {
                const courseId = parseInt(document.getElementById('notes-detail-container').dataset.courseId);
                const lectureId = noteItem.dataset.lectureId;
                const progress = getLectureProgress(courseId, lectureId);

                if (progress && progress.pdfHandle) {
                    document.querySelectorAll('#notes-list-container .notes-item').forEach(item => item.classList.remove('active'));
                    noteItem.classList.add('active');
                    await showMediaViewer(progress.pdfHandle, 'note', progress.pdfName, null);
                }
            }
        });


        // --- Init ---
        async function main() {
            if (!window.indexedDB || !window.showDirectoryPicker) { document.body.innerHTML = "<h1>Browser Not Supported</h1><p>Please use a modern browser like Google Chrome or Microsoft Edge that supports the File System Access API and IndexedDB.</p>"; return; }
            await openDB();
            await loadAllProgress();
            await loadCoursesFromDB();
            
            const savedStateJSON = sessionStorage.getItem('courseflixState');
            if (savedStateJSON) {
                const savedState = JSON.parse(savedStateJSON);
                if (savedState.view === 'player-view' && savedState.courseId && savedState.lectureId) {
                    if (savedState.sidebarCollapsed) {
                        lectureMenu.classList.add('hidden');
                        sidebarToggleBtn.classList.add('collapsed');
                    }
                    const courseExists = courses.some(c => c.id === savedState.courseId);
                    if (courseExists) {
                      await renderPlayer(savedState.courseId, savedState.lectureId, savedState.lastView, savedState.currentTime);
                      return;
                    }
                }
            }
            switchView('dashboard-view');
        }
        main();
    });
    </script>
</body>
</html>
